<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Skew | Trading Plan Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #cde7ec;
            --color-card: #edfcff;
            --color-card-alt: #dbf6fa;
            --color-card-muted: #f8fafa;
            --color-text: #273f43;
            --color-text-secondary: #2f3b58;
            --color-text-muted: #48616b;
            --color-border: #dbf6fa;
            --color-border-strong: #bac6ea;
            --color-primary: #00424a;
            --color-primary-accent: #005f6b;
            --color-primary-contrast: #edfcff;
            --color-secondary: #006b5e;
            --color-secondary-hover: #008a7b;
            --color-tooltip-bg: #00424a;
            --color-tooltip-text: #edfcff;
            --color-table-row-even: #f8fafa;
            --color-table-row-odd: #edfcff;
            --color-summary-bg: #dbf6fa;
            --color-summary-border: #00424a;
            --color-executed-bg: #cde9d6;
            --color-invalid: #b91c1c;
            --color-helper-border: #2f3b58;
            --color-slider-track: #bac6ea;
            --color-slider-thumb: #00424a;
            --color-grid-line: rgba(186, 198, 234, 0.7);
            --color-chart-axis-text: #2f3b58;
            --color-buy-bar: #2f3b58;
            --color-buy-bar-hover: #00424a;
            --color-sell-bar: #006b5e;
            --color-sell-bar-hover: #008a7b;
            --color-control-bg: rgba(237, 252, 255, 0.75);
            --color-control-text: #2f3b58;
            --color-control-border: #bac6ea;
            --color-control-active: #00424a;
            --color-control-active-text: #edfcff;
            --color-control-shadow: 0 6px 16px -8px rgba(15, 23, 42, 0.18);
            --focus-ring-color: rgba(0, 66, 74, 0.2);
            --shadow-base: 0 10px 15px -3px rgba(15, 23, 42, 0.08), 0 4px 6px -2px rgba(15, 23, 42, 0.06);
            --color-warning-bg: rgba(185, 28, 28, 0.08);
            --color-warning-border: rgba(185, 28, 28, 0.35);
        }

        body.theme-dark {
            --color-bg: #0f172a;
            --color-card: #1e293b;
            --color-card-alt: rgba(30, 41, 59, 0.78);
            --color-card-muted: rgba(15, 23, 42, 0.85);
            --color-text: #e2e8f0;
            --color-text-secondary: #cbd5f5;
            --color-text-muted: #94a3b8;
            --color-border: #334155;
            --color-border-strong: #475569;
            --color-primary: #38bdf8;
            --color-primary-accent: #0ea5e9;
            --color-primary-contrast: #0f172a;
            --color-secondary: #22d3ee;
            --color-secondary-hover: #06b6d4;
            --color-tooltip-bg: #0ea5e9;
            --color-tooltip-text: #0f172a;
            --color-table-row-even: rgba(30, 41, 59, 0.6);
            --color-table-row-odd: rgba(15, 23, 42, 0.7);
            --color-summary-bg: rgba(29, 78, 216, 0.78);
            --color-summary-border: #38bdf8;
            --color-executed-bg: rgba(34, 197, 94, 0.25);
            --color-invalid: #f87171;
            --color-helper-border: #38bdf8;
            --color-slider-track: #1e40af;
            --color-slider-thumb: #38bdf8;
            --color-grid-line: rgba(148, 163, 184, 0.5);
            --color-chart-axis-text: #e2e8f0;
            --color-buy-bar: #38bdf8;
            --color-buy-bar-hover: #0ea5e9;
            --color-sell-bar: #22d3ee;
            --color-sell-bar-hover: #06b6d4;
            --color-control-bg: rgba(15, 23, 42, 0.82);
            --color-control-text: #cbd5f5;
            --color-control-border: #1e3a8a;
            --color-control-active: #38bdf8;
            --color-control-active-text: #0f172a;
            --color-control-shadow: 0 10px 24px -12px rgba(2, 6, 23, 0.65);
            --focus-ring-color: rgba(56, 189, 248, 0.35);
            --shadow-base: 0 18px 28px -12px rgba(2, 6, 23, 0.65), 0 10px 16px -8px rgba(2, 6, 23, 0.55);
            --color-warning-bg: rgba(248, 113, 113, 0.16);
            --color-warning-border: rgba(248, 113, 113, 0.45);
        }

        html {
            scroll-behavior: smooth;
        }

        @media (prefers-reduced-motion: reduce) {
            html {
                scroll-behavior: auto;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        section[id] {
            scroll-margin-top: 120px;
        }

        @media (max-width: 640px) {
            section[id] {
                scroll-margin-top: 96px;
            }
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        .text-primary-dark {
            color: var(--color-text);
        }

        .text-secondary-dark {
            color: var(--color-text-secondary);
        }

        .text-tertiary-dark {
            color: var(--color-text-muted);
        }

        .form-input,
        select.form-input {
            background-color: var(--color-card-muted);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            transition: all 0.3s ease;
        }

        .form-input:focus,
        select.form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--focus-ring-color);
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-contrast);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: var(--color-primary-accent);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-primary-contrast);
            transition: background-color 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: var(--color-secondary-hover);
        }

        .card {
            background-color: var(--color-card);
            border-radius: 1rem;
            box-shadow: var(--shadow-base);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .summary-card {
            background-color: var(--color-summary-bg);
            border-left: 4px solid var(--color-summary-border);
        }

        #summary {
            grid-auto-rows: minmax(150px, auto);
        }

        .summary-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            gap: 0.35rem;
        }

        .summary-card p {
            margin: 0;
        }

        .surface-muted {
            background-color: var(--color-card-muted);
        }

        .surface-accent {
            background-color: var(--color-card-alt);
        }

        .border-soft {
            border-color: var(--color-border);
        }

        .border-strong {
            border-color: var(--color-border-strong);
        }

        .border-accent {
            border-color: var(--color-summary-border);
        }

        .table-header {
            background-color: var(--color-card-alt);
        }

        body.layout-desktop .table-row-odd td {
            background-color: var(--color-table-row-odd);
        }

        body.layout-desktop .table-row-even td {
            background-color: var(--color-table-row-even);
        }

        .executed-rung td {
            background-color: var(--color-executed-bg);
            font-weight: 600;
        }

        .label-invalid {
            color: var(--color-invalid) !important;
        }

        .input-invalid {
            border-color: var(--color-invalid) !important;
            box-shadow: 0 0 0 3px rgba(185, 28, 28, 0.18);
        }

        .label-with-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #buy-orders-card table th,
        #buy-orders-card table td,
        #sell-orders-card table th,
        #sell-orders-card table td {
            padding: 0.35rem 0.5rem;
        }

        .label-with-info .info-button {
            margin-left: auto;
        }

        .info-button {
            background-color: transparent;
            border: 1px solid var(--color-invalid);
            color: var(--color-invalid);
            border-radius: 9999px;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .info-button:hover,
        .info-button:focus-visible {
            background-color: rgba(185, 28, 28, 0.12);
        }

        .helper-tooltip {
            background-color: transparent;
            border: 1px solid var(--color-helper-border);
            color: var(--color-helper-border);
            border-radius: 9999px;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .helper-tooltip:hover,
        .helper-tooltip:focus-visible {
            background-color: rgba(47, 59, 88, 0.12);
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: var(--color-slider-track);
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        input[type=range]:hover {
            opacity: 1;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-slider-thumb);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--color-primary-contrast);
        }

        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--color-slider-thumb);
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid var(--color-primary-contrast);
        }

        .slider-control {
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
        }

        .slider-headline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .slider-value-cluster {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.15rem 0.35rem;
            border-radius: 999px;
            background-color: var(--color-control-bg);
            border: 1px solid var(--color-control-border);
            box-shadow: var(--color-control-shadow);
        }

        .slider-number-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .slider-value-input {
            width: 88px;
            text-align: center;
            font-variant-numeric: tabular-nums;
            padding-right: 1.5rem;
            background-color: transparent;
            border: none;
            box-shadow: none;
            color: var(--color-control-text);
            font-weight: 600;
        }

        .slider-value-input:focus {
            outline: none;
            box-shadow: none;
        }

        .slider-value-input::-webkit-outer-spin-button,
        .slider-value-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .slider-value-input[type=number] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        .slider-value-suffix {
            position: absolute;
            right: 0.5rem;
            font-size: 0.75rem;
            color: var(--color-text-muted);
            pointer-events: none;
        }

        .slider-stepper {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 1px solid transparent;
            background: var(--color-control-active);
            color: var(--color-control-active-text);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.15s ease, background-color 0.2s ease;
        }

        .slider-stepper:hover {
            transform: scale(1.05);
        }

        .slider-stepper:active {
            transform: scale(0.95);
        }

        .slider-stepper:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        .slider-track-row {
            display: flex;
            align-items: center;
        }

        .slider-track-row input[type=range] {
            width: 100%;
        }

        .plan-alerts {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .plan-alerts.hidden {
            display: none;
        }

        .alert-banner {
            border-radius: 0.75rem;
            border: 1px solid var(--color-warning-border);
            background-color: var(--color-warning-bg);
            color: var(--color-text);
            padding: 0.85rem 1rem;
            font-size: 0.9rem;
            line-height: 1.4;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .alert-banner svg {
            flex-shrink: 0;
            width: 18px;
            height: 18px;
            color: var(--color-invalid);
        }

        .plan-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 640px) {
            .plan-actions {
                flex-direction: row;
                align-items: center;
            }
        }

        .plan-select {
            flex: 1;
            min-height: 48px;
            border-radius: 0.75rem;
            border: 1px solid var(--color-border);
            background-color: var(--color-card-muted);
            color: var(--color-text);
            padding: 0.4rem 0.85rem;
            font-weight: 600;
        }

        .plan-actions-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .plan-action-button {
            min-height: 48px;
            border-radius: 0.75rem;
            border: 1px solid var(--color-control-border);
            background-color: var(--color-control-bg);
            color: var(--color-control-text);
            font-weight: 600;
            padding: 0.4rem 1.25rem;
            cursor: pointer;
        }

        .plan-action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .plan-action-link {
            background: none;
            border: none;
            color: var(--color-secondary);
            font-weight: 600;
            cursor: pointer;
        }

        .order-toggle-bar {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-bottom: -0.5rem;
        }

        .order-toggle-button {
            border-radius: 999px;
            border: 1px solid var(--color-control-border);
            background-color: var(--color-card-muted);
            color: var(--color-control-text);
            padding: 0.35rem 0.85rem;
            font-size: 0.85rem;
            font-weight: 600;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
        }

        .order-toggle-button:hover,
        .order-toggle-button:focus-visible {
            border-color: var(--color-control-active);
            color: var(--color-control-active-text);
            background-color: var(--color-control-active);
        }

        .order-card .overflow-x-auto {
            overflow-x: hidden;
        }

        .export-sheet-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.25s ease;
            z-index: 970;
        }

        .export-sheet-overlay.is-visible {
            opacity: 1;
            pointer-events: auto;
        }

        .export-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-card);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            box-shadow: 0 -20px 35px rgba(15, 23, 42, 0.25);
            transform: translateY(100%);
            transition: transform 0.25s ease;
            padding: 1.5rem;
            z-index: 980;
        }

        .export-sheet.is-visible {
            transform: translateY(0);
        }

        .export-sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .export-sheet-subtitle {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--color-text-muted);
            margin: 0 0 0.35rem 0;
        }

        .export-sheet h2 {
            margin: 0;
            font-size: 1.35rem;
            color: var(--color-text);
        }

        .export-sheet-close {
            border: none;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 999px;
            width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--color-text);
            cursor: pointer;
        }

        .export-sheet-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        @media (min-width: 640px) {
            .export-sheet-actions {
                flex-direction: row;
            }
        }

        .export-sheet-button {
            flex: 1;
            min-height: 56px;
            border-radius: 1rem;
            border: 1px solid var(--color-control-border);
            background-color: var(--color-card-muted);
            color: var(--color-control-text);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, border-color 0.2s ease, background-color 0.2s ease;
        }

        .export-sheet-button:hover,
        .export-sheet-button:focus-visible {
            outline: none;
            border-color: var(--color-control-active);
            background-color: var(--color-control-active);
            color: var(--color-control-active-text);
        }

        .export-sheet-button:active {
            transform: scale(0.98);
        }

        .export-sheet-status {
            margin-top: 1rem;
            display: none;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }

        .export-sheet-status.active {
            display: flex;
        }

        .export-sheet-spinner {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: var(--color-primary);
            animation: spin 0.8s linear infinite;
        }

        .export-sheet-spinner.hidden {
            display: none;
        }

        .export-sheet-status-text {
            font-weight: 600;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }

        .order-card.collapsed table,
        .order-card.collapsed .overflow-x-auto {
            display: none;
        }

        .order-collapsed-message {
            display: none;
            color: var(--color-text-muted);
            font-size: 0.875rem;
            margin: 0;
        }

        .order-card.collapsed .order-collapsed-message {
            display: block;
        }

        .d3-chart .domain {
            stroke: var(--color-chart-axis-text);
        }

        .d3-chart .tick line {
            stroke: var(--color-grid-line);
        }

        .d3-chart .tick text {
            fill: var(--color-chart-axis-text);
            font-size: 11px;
        }

        .d3-chart .grid line {
            stroke: var(--color-grid-line);
            stroke-opacity: 0.6;
            shape-rendering: crispEdges;
        }

        .chart-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x;
            overscroll-behavior: contain;
            padding-bottom: 0.5rem;
            margin: 0 -0.25rem;
        }

        .chart-scroll-container:focus-within {
            outline: 2px solid var(--color-primary);
            outline-offset: 6px;
        }

        .d3-chart {
            min-height: 320px;
        }

        .d3-chart .buy-bar {
            fill: var(--color-buy-bar);
            transition: all 0.3s ease-out;
        }

        .d3-chart .buy-bar:hover {
            fill: var(--color-buy-bar-hover);
        }

        .d3-chart .sell-bar {
            fill: var(--color-sell-bar);
            transition: all 0.3s ease-out;
        }

        .d3-chart .sell-bar:hover {
            fill: var(--color-sell-bar-hover);
        }

        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font-size: 12px;
            background: var(--color-tooltip-bg);
            color: var(--color-tooltip-text);
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            box-shadow: 0 10px 18px -12px rgba(15, 23, 42, 0.45);
        }

        .brand-header {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 1.25rem;
            background: linear-gradient(145deg, rgba(237, 252, 255, 0.85), rgba(219, 246, 250, 0.65));
            border: 1px solid rgba(186, 198, 234, 0.45);
            box-shadow: 0 20px 35px -18px rgba(15, 23, 42, 0.35);
        }

        .brand-header-inner {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .brand-title {
            font-size: clamp(2.5rem, 3.8vw, 3.75rem);
            font-weight: 800;
            line-height: 1.05;
            letter-spacing: -0.02em;
            background: linear-gradient(120deg, var(--color-primary) 0%, var(--color-secondary) 45%, var(--color-primary-accent) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 6px 14px rgba(0, 66, 74, 0.18);
        }

        .brand-kicker {
            display: inline-flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            font-weight: 600;
            color: var(--color-text-muted);
        }

        .brand-kicker::before {
            content: '';
            display: inline-block;
            width: 32px;
            height: 1px;
            background: var(--color-border-strong);
            opacity: 0.6;
        }

        .brand-subtitle {
            font-size: clamp(1rem, 1.8vw, 1.35rem);
            color: var(--color-text-secondary);
            max-width: 38rem;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-self: flex-start;
        }

        .section-nav-wrapper {
            position: sticky;
            top: 0;
            z-index: 80;
            margin-top: 1.5rem;
        }

        .section-nav {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 999px;
            background-color: var(--color-card);
            box-shadow: var(--shadow-base);
            overflow-x: auto;
            scrollbar-width: none;
            backdrop-filter: blur(12px);
        }

        .section-nav::-webkit-scrollbar {
            display: none;
        }

        .section-nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.4rem 0.95rem;
            border-radius: 999px;
            border: 1px solid transparent;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-control-text);
            background-color: transparent;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            white-space: nowrap;
        }

        .section-nav-link:hover {
            border-color: var(--color-control-border);
        }

        .section-nav-link.active {
            background-color: var(--color-control-active);
            color: var(--color-control-active-text);
            border-color: var(--color-control-active);
            box-shadow: var(--color-control-shadow);
        }

        .back-to-top {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 48px;
            height: 48px;
            border-radius: 999px;
            border: none;
            background-color: var(--color-primary);
            color: var(--color-primary-contrast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-base);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            z-index: 95;
        }

        .back-to-top.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .back-to-top:active {
            transform: scale(0.96);
        }

        @media (min-width: 768px) {
            .back-to-top {
                bottom: 2.25rem;
                right: 2.25rem;
            }
        }

        .header-controls-group {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .theme-toggle-group {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem;
            border-radius: 999px;
            border: 1px solid rgba(186, 198, 234, 0.6);
            background-color: rgba(237, 252, 255, 0.6);
            box-shadow: var(--color-control-shadow);
        }

        .header-icons-group {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem;
            border-radius: 999px;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .header-icons-group:hover {
            opacity: 0.8;
        }

        .header-icon-btn {
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
            color: var(--color-text-muted);
            text-decoration: none;
        }

        .header-icon-btn:hover {
            transform: scale(1.1);
            opacity: 1;
            background: rgba(186, 198, 234, 0.2);
        }

        .header-icon-btn:active {
            transform: scale(0.95);
        }

        .header-solana-icon {
            width: 18px;
            height: 14px;
        }

        .header-github-icon {
            width: 16px;
            height: 16px;
        }

        .theme-toggle-button {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            border: none;
            background: transparent;
            color: var(--color-control-text);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
            position: relative;
        }

        #theme-toggle .theme-icon {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        body[data-theme-mode="light"] #theme-toggle .theme-icon--sun {
            opacity: 1;
        }

        body[data-theme-mode="light"] #theme-toggle .theme-icon--moon {
            opacity: 0;
        }

        body[data-theme-mode="dark"] #theme-toggle .theme-icon--moon {
            opacity: 1;
        }

        body[data-theme-mode="dark"] #theme-toggle .theme-icon--sun {
            opacity: 0;
        }

        .theme-toggle-button svg {
            width: 16px;
            height: 16px;
        }

        .theme-toggle-button.active {
            background-color: var(--color-control-active);
            color: var(--color-control-active-text);
            box-shadow: 0 8px 14px -8px rgba(15, 23, 42, 0.3);
        }

        .theme-toggle-button:focus-visible {
            outline: 2px solid var(--color-control-active);
            outline-offset: 2px;
        }

        .display-footer {
            margin-top: 3rem;
            padding: 1.5rem 0 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            color: var(--color-text-muted);
            font-size: 0.75rem;
        }

        .donation-section {
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            position: relative;
        }

        .donation-link {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            color: var(--color-text-muted);
            opacity: 0.6;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s ease, color 0.2s ease;
            text-decoration: none;
        }

        .donation-link:hover {
            opacity: 1;
            color: var(--color-text-secondary);
        }

        .donation-link:focus-visible {
            outline: 1px solid var(--color-text-muted);
            outline-offset: 2px;
            opacity: 1;
        }

        .donation-icon {
            width: 12px;
            height: 12px;
            flex-shrink: 0;
        }

        .donation-details {
            max-width: 400px;
            margin-top: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--color-card-muted);
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 0.7rem;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .donation-content {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            text-align: center;
        }

        .donation-text {
            color: var(--color-text-secondary);
            margin: 0;
            line-height: 1.4;
        }

        .donation-address-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            justify-content: space-between;
        }

        .donation-address {
            flex: 1;
            font-size: 0.65rem;
            color: var(--color-text);
            word-break: break-all;
            text-align: left;
            padding: 0.25rem 0;
            background: transparent;
            border: none;
        }

        .donation-copy-btn {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 3px;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .donation-copy-btn:hover {
            background: var(--color-border);
            color: var(--color-text);
        }

        .donation-copy-btn:active {
            transform: scale(0.95);
        }

        .donation-copy-btn svg {
            width: 14px;
            height: 14px;
        }

        .donation-label {
            margin: 0;
            font-size: 0.65rem;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .donation-copy-btn.copied {
            color: var(--color-secondary);
        }

        .donation-copy-btn.copied svg {
            display: none;
        }

        .donation-copy-btn.copied::after {
            content: '✓';
            font-size: 0.75rem;
            font-weight: bold;
        }

        .solana-logo-btn {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .solana-logo-btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .solana-logo-btn:active {
            transform: scale(0.95);
        }

        .solana-logo {
            width: 20px;
            height: 16px;
        }

        .solana-logo-btn-footer {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.2s ease, opacity 0.2s ease, background-color 0.2s ease;
            opacity: 0.7;
        }

        .solana-logo-btn-footer:hover {
            transform: scale(1.1);
            opacity: 1;
            background-color: rgba(153, 69, 255, 0.1);
        }

        .solana-logo-btn-footer:active {
            transform: scale(1.05);
        }

        .solana-logo-footer {
            width: 32px;
            height: 25px;
        }

        .qr-code-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 400px;
            width: 90%;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }

        .qr-code-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }

        .qr-code-content {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 2rem;
            background: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .qr-code-close-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: rgba(186, 198, 234, 0.2);
            border: none;
            border-radius: 8px;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .qr-code-close-btn:hover {
            background: rgba(186, 198, 234, 0.4);
            color: var(--color-text);
            transform: scale(1.05);
        }

        .qr-code-close-btn:active {
            transform: scale(0.95);
        }

        .qr-code-close-btn svg {
            width: 18px;
            height: 18px;
        }

        .donation-message {
            margin: 0;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            text-align: center;
            font-weight: 600;
            padding: 0.5rem 1rem;
            background: linear-gradient(135deg, rgba(153, 69, 255, 0.1), rgba(20, 241, 149, 0.1));
            border-radius: 8px;
            width: 100%;
        }

        .qr-code-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafa 100%);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            min-height: 240px;
            width: 100%;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .qr-code-wrapper canvas,
        .qr-code-wrapper img {
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
        }

        .qr-code-image {
            width: 220px;
            height: 220px;
        }

        .donation-address-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
        }

        .donation-network-label {
            margin: 0;
            font-size: 0.7rem;
            color: var(--color-text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.25rem 0.75rem;
            background: rgba(153, 69, 255, 0.1);
            border-radius: 6px;
        }

        .donation-address-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--color-card-muted);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            width: 100%;
            max-width: 340px;
            min-width: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .donation-address-code {
            flex: 1;
            padding: 0;
            background: transparent;
            border: none;
            font-family: 'Courier New', monospace;
            font-size: 0.7rem;
            color: var(--color-text);
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            overflow: visible;
            text-align: left;
            margin: 0;
            line-height: 1.5;
            min-width: 0;
        }

        .donation-address-copy-btn {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            background: rgba(186, 198, 234, 0.2);
            border: none;
            border-radius: 6px;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .donation-address-copy-btn:hover {
            background: rgba(186, 198, 234, 0.4);
            color: var(--color-text);
            transform: scale(1.05);
        }

        .donation-address-copy-btn:active {
            transform: scale(0.95);
        }

        .donation-address-copy-btn svg {
            width: 16px;
            height: 16px;
        }

        .donation-address-copy-btn.copied {
            background: var(--color-secondary);
            color: white;
        }

        .donation-address-copy-btn.copied svg {
            display: none;
        }

        .donation-address-copy-btn.copied::after {
            content: '✓';
            font-size: 1rem;
            font-weight: bold;
        }

        .github-link {
            text-decoration: none;
        }

        .github-icon {
            width: 14px;
            height: 14px;
        }

        .layout-toggle-group {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.2rem 0.35rem;
            border-radius: 999px;
            border: 1px dashed rgba(186, 198, 234, 0.6);
            background-color: rgba(237, 252, 255, 0.35);
        }

        .layout-toggle-button {
            width: 30px;
            height: 30px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 999px;
            border: none;
            background: transparent;
            color: var(--color-text-muted);
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
        }

        .layout-toggle-button svg {
            width: 16px;
            height: 16px;
        }

        .layout-toggle-button.active {
            background-color: rgba(0, 66, 74, 0.12);
            color: var(--color-primary);
        }

        .layout-toggle-button:focus-visible {
            outline: 2px solid var(--color-control-active);
            outline-offset: 2px;
        }

        body.theme-dark .brand-header {
            background: linear-gradient(150deg, rgba(30, 41, 59, 0.92), rgba(15, 23, 42, 0.88));
            border-color: rgba(56, 189, 248, 0.28);
            box-shadow: 0 24px 50px -24px rgba(2, 6, 23, 0.8);
        }

        body.theme-dark .brand-kicker::before {
            background: rgba(56, 189, 248, 0.4);
        }

        body.theme-dark .brand-subtitle {
            color: var(--color-text-muted);
        }

        body.theme-dark .theme-toggle-group {
            background-color: rgba(15, 23, 42, 0.75);
            border-color: rgba(56, 189, 248, 0.35);
            box-shadow: 0 10px 20px -14px rgba(2, 6, 23, 0.7);
        }

        body.theme-dark .layout-toggle-group {
            background-color: rgba(15, 23, 42, 0.65);
            border-color: rgba(56, 189, 248, 0.35);
        }

        body.theme-dark .layout-toggle-button.active {
            background-color: rgba(56, 189, 248, 0.18);
            color: var(--color-secondary);
        }

        @media (min-width: 768px) {
            .brand-header {
                flex-direction: row;
                align-items: flex-start;
                justify-content: space-between;
            }

            .header-controls {
                align-self: flex-end;
            }
        }

        .export-panel {
            background-color: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            padding: 0.75rem;
            box-shadow: 0 12px 20px -14px rgba(15, 23, 42, 0.3);
        }

        @media (min-width: 640px) {
            .export-panel {
                background-color: transparent;
                border-color: transparent;
                box-shadow: none;
                padding: 0;
            }
        }

        @media (min-width: 768px) {
            .display-control-panel {
                align-items: center;
            }
        }

        @media (max-width: 640px) {
            .mobile-two-col {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
            .summary-mobile-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
            }
            input[type=range] {
                height: 5.5px;
            }
            input[type=range]::-webkit-slider-thumb,
            input[type=range]::-moz-range-thumb {
                width: 25px;
                height: 25px;
            }
            .slider-stepper {
                width: 38px;
                height: 38px;
            }
        }

        body.layout-mobile {
            background-color: var(--color-bg);
        }

        body.layout-mobile header {
            text-align: left;
        }

        body.layout-mobile .brand-title {
            font-size: clamp(2.1rem, 6vw, 2.65rem);
        }

        body.layout-mobile #app {
            max-width: 100%;
        }

        body.layout-mobile main {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        body.layout-mobile .card {
            padding: 1.25rem;
        }

        body.layout-mobile .summary-mobile-grid {
            grid-template-columns: 1fr !important;
        }

        body.layout-mobile .summary-card {
            text-align: left;
        }

        body.layout-mobile .text-secondary-dark,
        body.layout-mobile .text-tertiary-dark {
            text-align: left;
        }

        body.layout-mobile .overflow-x-auto {
            overflow-x: visible;
        }

        body.layout-mobile table {
            border-collapse: separate;
            border-spacing: 0;
        }

        body.layout-mobile table thead {
            display: none;
        }

        body.layout-mobile table tbody tr {
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
            padding: 0.85rem;
            border: 1px solid var(--color-border);
            border-radius: 0.85rem;
            background-color: var(--color-card);
            margin-bottom: 0.85rem;
        }

        body.layout-mobile table tbody tr:last-child {
            margin-bottom: 0;
        }

        body.layout-mobile table tbody tr.executed-rung {
            background-color: var(--color-executed-bg);
        }

        body.layout-mobile table tbody tr td {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            border: none;
            background: transparent;
            padding: 0;
            font-size: 0.95rem;
        }

        body.layout-mobile table tbody tr td::before {
            content: attr(data-label);
            font-weight: 700;
            color: var(--color-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        body.layout-mobile table tbody tr td input[type="checkbox"] {
            margin-left: auto;
        }

        body.layout-mobile .d3-chart svg {
            min-height: 260px;
        }

        details summary {
            list-style: none;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        /* Intro Modal Styles */
        .intro-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-in-out;
        }

        .intro-modal-overlay.hidden {
            display: none;
        }

        .intro-modal-container {
            background-color: var(--color-card);
            border-radius: 1rem;
            max-width: 900px;
            width: 100%;
            max-height: min(80vh, 760px);
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        .intro-modal-content {
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .intro-text-section {
            text-align: center;
        }

        .intro-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        .intro-description {
            font-size: 1.125rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
            margin-bottom: 1.5rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }

        .intro-features {
            text-align: left;
            max-width: 600px;
            margin: 0 auto;
        }

        .intro-features-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .intro-features-list li {
            color: var(--color-text);
            font-size: 0.95rem;
            line-height: 1.5;
            padding-left: 1.5rem;
            position: relative;
        }

        .intro-features-list li::before {
            content: "✓";
            position: absolute;
            left: 0;
            color: var(--color-secondary);
            font-weight: bold;
        }

        .intro-video-section {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .intro-video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            border-radius: 0.5rem;
            background-color: var(--color-bg);
        }

        .youtube-link-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }

        .youtube-thumbnail {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            border-radius: 0.5rem;
            background-color: var(--color-bg);
            transition: transform 0.2s ease;
        }

        .youtube-link-wrapper:hover .youtube-thumbnail {
            transform: scale(1.02);
        }

        .youtube-thumbnail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .youtube-play-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 68px;
            height: 48px;
            transition: transform 0.2s ease;
        }

        .youtube-link-wrapper:hover .youtube-play-button {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .youtube-overlay-text {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent);
            padding: 1.5rem 1rem 1rem;
            color: white;
            text-align: center;
        }

        .youtube-overlay-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin: 0 0 0.25rem 0;
        }

        .youtube-overlay-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin: 0;
        }

        .intro-video-caption {
            text-align: center;
            font-size: 0.875rem;
            color: var(--color-text-muted);
            font-style: italic;
        }

        .intro-controls-section {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }

        .intro-skip-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            user-select: none;
        }

        .intro-skip-checkbox input[type="checkbox"] {
            cursor: pointer;
        }

        .intro-buttons {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .intro-skip-link {
            background: none;
            border: none;
            color: var(--color-text-muted);
            font-size: 0.875rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            text-decoration: underline;
            transition: color 0.2s;
        }

        .intro-skip-link:hover {
            color: var(--color-text-secondary);
        }

        .intro-primary-button {
            background-color: var(--color-primary);
            color: var(--color-primary-contrast);
            border: none;
            padding: 0.75rem 2rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .intro-primary-button:hover {
            background-color: var(--color-primary-accent);
        }

        .intro-primary-button:active {
            transform: scale(0.98);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 640px) {
            .intro-modal-content {
                padding: 1.5rem;
                gap: 1.5rem;
            }

            .intro-modal-container {
                max-height: 60vh;
            }

            .intro-title {
                font-size: 1.5rem;
            }

            .intro-description {
                font-size: 1rem;
            }

            .intro-buttons {
                flex-direction: column;
                width: 100%;
            }

            .intro-primary-button,
            .intro-skip-link {
                width: 100%;
                text-align: center;
            }
        }

        .intro-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 36px;
            height: 36px;
            border-radius: 999px;
            border: 1px solid var(--color-border);
            background-color: var(--color-card-muted);
            color: var(--color-text);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .intro-modal-close:hover,
        .intro-modal-close:focus-visible {
            outline: none;
            background-color: var(--color-card-alt);
            border-color: var(--color-border-strong);
        }

        /* Prevent body scroll when modal is visible */
        body.intro-modal-open {
            overflow: hidden;
        }
    </style>
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "u4us17in70");
    </script>
</head>
<body class="p-2 sm:p-4 theme-light layout-desktop">
    <!-- Intro Modal -->
    <div id="intro-modal" class="intro-modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="intro-modal-title" aria-hidden="true">
        <div class="intro-modal-container">
            <button type="button" id="intro-modal-close" class="intro-modal-close" aria-label="Close introduction modal">
                <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="intro-modal-content">
                <!-- Introduction Text Section -->
                <div class="intro-text-section">
                    <h2 class="intro-title" id="intro-modal-title">Welcome to Order Skew</h2>
                    <p class="intro-description">
                        Design and optimize your trading ladder strategies with precision. Order Skew helps you plan staged buy and sell orders, calculate allocations, manage fees, and visualize your trading strategy.
                    </p>
                    <div class="intro-features">
                        <ul class="intro-features-list">
                            <li>Create buy and sell ladders with customizable rungs and allocation strategies</li>
                            <li>Calculate fees, profit margins, and ROI for your trading plans</li>
                            <li>Visualize your strategy with interactive charts and detailed order tables</li>
                            <li>Export your plans to CSV, XLS, or PDF for execution</li>
                        </ul>
                    </div>
                </div>

                <!-- Video Section -->
                <div class="intro-video-section">
                    <div class="intro-video-container">
                        <a href="https://www.youtube.com/watch?v=LPaAtWphx2U" target="_blank" rel="noopener noreferrer" class="youtube-link-wrapper">
                            <div class="youtube-thumbnail">
                                <img 
                                    src="https://img.youtube.com/vi/LPaAtWphx2U/maxresdefault.jpg" 
                                    alt="Order Skew Tutorial Video Thumbnail"
                                    class="youtube-thumbnail-image"
                                    onerror="this.src='https://img.youtube.com/vi/LPaAtWphx2U/hqdefault.jpg'">
                                <div class="youtube-play-button">
                                    <svg viewBox="0 0 68 48" width="68" height="48">
                                        <path d="M66.52,7.74c-0.78-2.93-2.49-5.41-5.42-6.19C55.79,.13,34,0,34,0S12.21,.13,6.9,1.55 C3.97,2.33,2.27,4.81,1.48,7.74C0.06,13.05,0,24,0,24s0.06,10.95,1.48,16.26c0.78,2.93,2.49,5.41,5.42,6.19 C12.21,47.87,34,48,34,48s21.79-0.13,27.1-1.55c2.93-0.78,4.63-3.26,5.42-6.19C67.94,34.95,68,24,68,24S67.94,13.05,66.52,7.74z" fill="#f00"></path>
                                        <path d="M 45,24 27,14 27,34" fill="#fff"></path>
                                    </svg>
                                </div>
                                <div class="youtube-overlay-text">
                                    <p class="youtube-overlay-title">Watch Tutorial</p>
                                    <p class="youtube-overlay-subtitle">Opens on YouTube</p>
                                </div>
                            </div>
                        </a>
                    </div>
                    <p class="intro-video-caption">Watch our quick start guide to learn how to use Order Skew</p>
                </div>

                <!-- Controls Section -->
                <div class="intro-controls-section">
                    <label class="intro-skip-checkbox">
                        <input type="checkbox" id="intro-skip-checkbox" class="form-checkbox h-4 w-4 text-primary-dark rounded focus:ring-0">
                        <span>Don't show this intro again</span>
                    </label>
                    <div class="intro-buttons">
                        <button type="button" id="intro-skip-button" class="intro-skip-link">Skip</button>
                        <button type="button" id="intro-get-started-button" class="intro-primary-button">Get Started</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto">
        <header class="py-6">
            <div class="flex flex-col gap-6">
                <div class="brand-header">
                    <div class="brand-header-inner">
                        <span class="brand-kicker">OrderSkew.com</span>
                        <h1 class="brand-title">Order Skew</h1>
                        <p class="brand-subtitle">Design your buy and sell ladders with precision at OrderSkew.com.</p>
                    </div>
                    <div class="header-controls">
                        <div class="header-controls-group">
                            <div class="theme-toggle-group" id="theme-toggle-group">
                                <button type="button" id="theme-toggle" class="theme-toggle-button" aria-pressed="false" aria-label="Toggle theme">
                                    <span class="theme-icon theme-icon--sun">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="12" cy="12" r="5"></circle>
                                            <line x1="12" y1="1.5" x2="12" y2="4.5"></line>
                                            <line x1="12" y1="19.5" x2="12" y2="22.5"></line>
                                            <line x1="4.22" y1="4.22" x2="6.34" y2="6.34"></line>
                                            <line x1="17.66" y1="17.66" x2="19.78" y2="19.78"></line>
                                            <line x1="1.5" y1="12" x2="4.5" y2="12"></line>
                                            <line x1="19.5" y1="12" x2="22.5" y2="12"></line>
                                            <line x1="4.22" y1="19.78" x2="6.34" y2="17.66"></line>
                                            <line x1="17.66" y1="6.34" x2="19.78" y2="4.22"></line>
                                        </svg>
                                    </span>
                                    <span class="theme-icon theme-icon--moon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                                        </svg>
                                    </span>
                                </button>
                            </div>
                            
                            <!-- Understated Icons -->
                            <div class="header-icons-group">
                                <button type="button" id="solana-logo-btn-header" class="header-icon-btn" aria-label="Show QR code for Solana address">
                                    <svg viewBox="0 0 397.7 311.7" xmlns="http://www.w3.org/2000/svg" class="header-solana-icon">
                                        <linearGradient id="solanaGradientHeader" x1="360.879" y1="351.455" x2="141.213" y2="69.836" gradientUnits="userSpaceOnUse">
                                            <stop offset="0" stop-color="#9945FF"/>
                                            <stop offset="1" stop-color="#14F195"/>
                                        </linearGradient>
                                        <path d="M64.6 237.9c2.4-2.4 5.7-3.8 9.2-3.8h317.4c5.8 0 8.7 7 4.6 11.1l-62.7 62.7c-2.4 2.4-5.7 3.8-9.2 3.8H6.5c-5.8 0-8.7-7-4.6-11.1l62.7-62.7z" fill="url(#solanaGradientHeader)"/>
                                        <path d="M64.6 3.8C67.1 1.4 70.4 0 73.8 0h317.4c5.8 0 8.7 7 4.6 11.1l-62.7 62.7c-2.4 2.4-5.7 3.8-9.2 3.8H6.5c-5.8 0-8.7-7-4.6-11.1L64.6 3.8z" fill="url(#solanaGradientHeader)"/>
                                        <path d="M333.1 120.1c-2.4-2.4-5.7-3.8-9.2-3.8H6.5c-5.8 0-8.7 7-4.6 11.1l62.7 62.7c2.4 2.4 5.7 3.8 9.2 3.8h317.4c5.8 0 8.7-7 4.6-11.1l-62.7-62.7z" fill="url(#solanaGradientHeader)"/>
                                    </svg>
                                </button>
                                <a href="https://github.com/yanniedog/OrderSkew" target="_blank" rel="noopener noreferrer" class="header-icon-btn" aria-label="View project on GitHub">
                                    <svg viewBox="0 0 24 24" fill="currentColor" class="header-github-icon">
                                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                    </svg>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                    <button id="export-trigger" type="button" class="btn-secondary text-sm font-semibold py-2 px-4 rounded-lg cursor-pointer inline-flex items-center gap-2 min-h-[48px]">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        <span>Export Plan</span>
                    </button>
                    <div class="section-nav-wrapper">
                        <nav class="section-nav" aria-label="Page navigation">
                            <a href="#configuration" class="section-nav-link" data-nav-target="configuration">Configuration</a>
                            <a href="#plan-summary" class="section-nav-link" data-nav-target="plan-summary">Plan Summary</a>
                            <a href="#buy-ladder" class="section-nav-link" data-nav-target="buy-ladder">Buy Ladder</a>
                            <a href="#sell-ladder" class="section-nav-link" data-nav-target="sell-ladder">Sell Ladder</a>
                        </nav>
                    </div>
                </div>
            </div>
        </header>

        <main class="grid mobile-two-col grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 auto-rows-min">
            <section id="configuration" class="card p-6" tabindex="-1" aria-labelledby="configuration-heading">
                <h2 id="configuration-heading" class="text-2xl font-semibold text-primary-dark mb-6">Configuration</h2>
                <div id="plan-alerts" class="plan-alerts hidden" role="status" aria-live="polite"></div>
                <div class="plan-actions">
                    <label for="saved-plan-select" class="sr-only">Saved plans</label>
                    <select id="saved-plan-select" class="plan-select" aria-label="Saved plans">
                        <option value="" disabled selected>No saved plans</option>
                    </select>
                    <div class="plan-actions-buttons">
                        <button type="button" id="save-plan-btn" class="plan-action-button">Save Plan</button>
                        <button type="button" id="load-plan-btn" class="plan-action-button" disabled>Load Plan</button>
                        <button type="button" id="reset-plan-btn" class="plan-action-link">Reset Defaults</button>
                    </div>
                </div>
                <form id="trading-plan-form" class="space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="starting_capital" class="block text-sm font-medium text-secondary-dark mb-1">Initial Capital ($)</label>
                            <input type="number" id="starting_capital" value="50000" class="form-input w-full rounded-md p-2">
                        </div>
                        <div>
                            <label for="current_price" class="block text-sm font-medium text-secondary-dark mb-1">Current Asset Price ($)</label>
                            <input type="number" id="current_price" value="100" class="form-input w-full rounded-md p-2">
                        </div>
                    </div>
                    <div class="slider-control" data-slider-field="number_of_rungs">
                        <div class="slider-headline">
                            <label id="number_of_rungs_label" for="number_of_rungs" class="block text-sm font-medium text-secondary-dark mb-1">Number of Rungs (<span id="number_of_rungs_display">10</span>)</label>
                            <div class="slider-value-cluster" role="group" aria-label="Adjust number of rungs precisely">
                                <button type="button" class="slider-stepper" data-step-target="number_of_rungs" data-step="-1" aria-label="Decrease number of rungs">-</button>
                                <div class="slider-number-wrapper">
                                    <input type="number" id="number_of_rungs_input" value="10" min="2" max="50" step="1" inputmode="numeric" aria-labelledby="number_of_rungs_label" class="slider-value-input">
                    </div>
                                <button type="button" class="slider-stepper" data-step-target="number_of_rungs" data-step="1" aria-label="Increase number of rungs">+</button>
                    </div>
                        </div>
                        <div class="slider-track-row">
                            <input type="range" id="number_of_rungs" value="10" min="2" max="50" step="1" class="w-full h-2 rounded-lg cursor-pointer" aria-labelledby="number_of_rungs_label">
                        </div>
                    </div>
                    <div class="slider-control" data-slider-field="depth">
                        <div class="slider-headline">
                            <label id="depth_label" for="depth" class="block text-sm font-medium text-secondary-dark mb-1">Width (<span id="depth_display">20</span>%)</label>
                            <div class="slider-value-cluster" role="group" aria-label="Adjust width precisely">
                                <button type="button" class="slider-stepper" data-step-target="depth" data-step="-0.1" aria-label="Decrease width">-</button>
                                <div class="slider-number-wrapper">
                                    <input type="number" id="depth_input" value="20" min="0.1" max="99" step="0.1" inputmode="decimal" aria-labelledby="depth_label" class="slider-value-input">
                                    <span class="slider-value-suffix">%</span>
                                </div>
                                <button type="button" class="slider-stepper" data-step-target="depth" data-step="0.1" aria-label="Increase width">+</button>
                            </div>
                        </div>
                        <div class="slider-track-row">
                            <input type="range" id="depth" value="20" min="0.1" max="99" step="0.1" class="w-full h-2 rounded-lg cursor-pointer" aria-labelledby="depth_label">
                        </div>
                    </div>
                    <div class="slider-control" data-slider-field="skew_value">
                        <div class="slider-headline">
                            <label id="skew_value_label" for="skew_value" class="block text-sm font-medium text-secondary-dark mb-1">Allocation Skew (<span id="skew_value_display">50</span>)</label>
                            <div class="slider-value-cluster" role="group" aria-label="Adjust allocation skew precisely">
                                <button type="button" class="slider-stepper" data-step-target="skew_value" data-step="-1" aria-label="Decrease allocation skew">-</button>
                                <div class="slider-number-wrapper">
                                    <input type="number" id="skew_value_input" value="50" min="0" max="100" step="1" inputmode="numeric" aria-labelledby="skew_value_label" class="slider-value-input">
                                    <span class="slider-value-suffix">%</span>
                                </div>
                                <button type="button" class="slider-stepper" data-step-target="skew_value" data-step="1" aria-label="Increase allocation skew">+</button>
                            </div>
                        </div>
                        <div class="slider-track-row">
                            <input type="range" id="skew_value" min="0" max="100" value="50" class="w-full h-2 rounded-lg cursor-pointer" aria-labelledby="skew_value_label">
                        </div>
                        <div class="flex justify-between text-xs text-tertiary-dark mt-1">
                            <span>None</span>
                            <span>Moderate</span>
                            <span>Heavy</span>
                        </div>
                    </div>
                    <div class="border border-soft rounded-lg p-3 surface-muted space-y-3">
                        <div class="flex items-center justify-between">
                            <label class="flex items-center space-x-2 text-xs font-medium text-secondary-dark cursor-pointer">
                                <input id="advanced_mode" type="checkbox" class="form-checkbox h-3.5 w-3.5 text-primary-dark rounded focus:ring-0">
                                <span>Advanced mode</span>
                            </label>
                            <button type="button" id="advanced-settings-toggle" class="hidden items-center justify-center w-6 h-6 text-secondary-dark hover:text-primary-dark transition-colors" aria-label="Toggle advanced settings" aria-expanded="false">
                                <svg class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                        </div>
                        <div id="advanced-settings" class="space-y-3 hidden">
                            <div class="grid grid-cols-1 sm:grid-cols-4 gap-3">
                                <div class="sm:col-span-4">
                                    <div class="border-2 border-accent surface-accent rounded-lg p-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                        <div>
                                            <p class="text-xs font-semibold text-secondary-dark uppercase tracking-wide">Mode</p>
                                            <p class="text-sm font-semibold text-primary-dark">Sell-only ladder</p>
                                            <p class="text-[11px] text-secondary-dark mt-1">Preserve existing buy orders while fine-tuning the sell ladder.</p>
                                        </div>
                                        <label class="inline-flex items-center space-x-2 text-sm font-medium text-primary-dark">
                                            <input id="sell_only_mode" type="checkbox" class="form-checkbox h-4 w-4 text-primary-dark rounded focus:ring-0">
                                            <span>Enable</span>
                                        </label>
                                    </div>
                                </div>
                                <div>
                                    <label for="fee_type" class="block text-xs font-medium text-secondary-dark mb-1">Trading Fee Type</label>
                                    <select id="fee_type" class="form-input w-full rounded-md p-2 text-sm">
                                        <option value="percent">Percent (%)</option>
                                        <option value="fixed">Flat ($)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="fee_value" class="block text-xs font-medium text-secondary-dark mb-1">Trading Fee</label>
                                    <input type="number" id="fee_value" value="0" min="0" class="form-input w-full rounded-md p-2 text-sm" step="0.0001">
                                </div>
                                <div>
                                    <label for="fee_settlement" class="flex items-center justify-between text-xs font-medium text-secondary-dark mb-1">
                                        <span>Fee Settlement</span>
                                        <button type="button" class="helper-tooltip" title="Choose whether trading fees reduce each order (net settlement) or are paid from a separate pool (external settlement)." aria-label="Fee settlement details">i</button>
                                    </label>
                                    <select id="fee_settlement" class="form-input w-full rounded-md p-2 text-sm">
                                        <option value="netted">Net settlement (deduct from order)</option>
                                        <option value="external">External settlement (separate funds)</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label for="spacing_mode" class="flex items-center justify-between text-xs font-medium text-secondary-dark mb-1">
                                    <span>Spacing Between Rungs</span>
                                    <button type="button" class="helper-tooltip" title="Relative spacing compounds the rung width as a percent change, creating exponential steps." aria-label="Spacing mode information">i</button>
                                </label>
                                <select id="spacing_mode" class="form-input w-full rounded-md p-2 text-sm">
                                    <option value="absolute">Absolute (Equal Steps)</option>
                                    <option value="relative">Relative (% per rung)</option>
                                </select>
                            </div>
                            <div>
                                <label class="flex items-center justify-between text-xs font-medium text-secondary-dark mb-1">
                                    <span class="flex items-center space-x-2">
                                        <input id="equal_quantity_mode" type="checkbox" class="form-checkbox h-3.5 w-3.5 text-primary-dark rounded focus:ring-0">
                                        <span>Equal quantity per rung</span>
                                    </span>
                                    <button type="button" class="helper-tooltip" title="Override skew settings and distribute the same asset size across each rung." aria-label="Equal quantity details">i</button>
                                </label>
                            </div>
                            <div id="sell-only-inputs" class="grid grid-cols-1 sm:grid-cols-2 gap-3 hidden">
                                <div>
                                    <label for="existing_quantity" class="block text-xs font-medium text-secondary-dark mb-1">Existing Quantity</label>
                                    <input type="number" id="existing_quantity" value="0" min="0" class="form-input w-full rounded-md p-2 text-sm" step="0.0001">
                                </div>
                                <div>
                                    <label for="existing_avg_price" class="block text-xs font-medium text-secondary-dark mb-1">Known Average Buy Price ($)</label>
                                    <input type="number" id="existing_avg_price" value="0" min="0" class="form-input w-full rounded-md p-2 text-sm" step="0.0001">
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </section>

            <section id="plan-summary" class="card p-5" tabindex="-1" aria-labelledby="plan-summary-heading">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="plan-summary-heading" class="text-2xl font-semibold text-primary-dark">Plan Summary</h2>
                </div>
                <div id="summary" class="grid summary-mobile-grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div class="summary-card p-4 rounded-lg">
                        <p class="text-sm text-secondary-dark">Avg. Buy Price</p>
                        <p id="summary-avg-buy" class="text-xl font-bold text-primary-dark">-</p>
                        <p class="text-xs text-secondary-dark mt-3">Buy Floor</p>
                        <p id="summary-buy-floor" class="text-sm font-semibold text-primary-dark">-</p>
                    </div>
                    <div class="summary-card p-4 rounded-lg">
                        <p class="text-sm text-secondary-dark">Avg. Sell Price</p>
                        <p id="summary-avg-sell" class="text-xl font-bold text-primary-dark">-</p>
                        <p class="text-xs text-secondary-dark mt-3">Sell Ceiling</p>
                        <p id="summary-sell-ceiling" class="text-sm font-semibold text-primary-dark">-</p>
                    </div>
                    <div class="summary-card p-4 rounded-lg">
                        <p class="text-sm text-secondary-dark">Profit After Fees</p>
                        <p id="summary-net-profit" class="text-xl font-bold text-primary-dark">-</p>
                    </div>
                    <div class="summary-card p-4 rounded-lg">
                        <p class="text-sm text-secondary-dark">Total Vol</p>
                        <p id="summary-total-quantity" class="text-xl font-bold text-primary-dark">-</p>
                    </div>
                    <div class="summary-card p-4 rounded-lg">
                        <p class="text-sm text-secondary-dark">ROI on Cost Basis</p>
                        <p id="summary-roi" class="text-xl font-bold text-primary-dark">-</p>
                    </div>
                    <div class="summary-card p-4 rounded-lg">
                        <p class="text-sm text-secondary-dark">Total Fees Paid</p>
                        <p id="summary-total-fees" class="text-xl font-bold text-primary-dark">-</p>
                        <p id="summary-total-fees-percent" class="text-xs text-secondary-dark mt-1">-</p>
                    </div>
                </div>
            </section>

            <!-- Buy Chart -->
            <section class="card p-5" id="buy-ladder" tabindex="-1" aria-labelledby="buy-ladder-heading">
                <h3 id="buy-ladder-heading" class="text-xl font-semibold text-primary-dark mb-4">Buy Ladder</h3>
                <div class="chart-scroll-container">
                <div id="visualization" class="d3-chart">
                    <svg id="allocation-chart"></svg>
                </div>
            </div>
            </section>
            
            <!-- Sell Chart -->
            <section class="card p-5" id="sell-ladder" tabindex="-1" aria-labelledby="sell-ladder-heading">
                <h3 id="sell-ladder-heading" class="text-xl font-semibold text-primary-dark mb-4">Sell Ladder</h3>
                <div class="chart-scroll-container">
                <div id="sell-visualization" class="d3-chart">
                    <svg id="sell-allocation-chart"></svg>
                </div>
            </div>
            </section>

            <div class="order-toggle-bar w-full col-span-full">
                <button type="button" class="order-toggle-button" data-order-toggle="collapse">Collapse All</button>
                <button type="button" class="order-toggle-button" data-order-toggle="expand">Expand All</button>
            </div>

            <div class="card p-5 order-card" id="buy-orders-card">
                <h3 class="text-xl font-semibold text-primary-dark mb-4">Buy Orders</h3>
                <p class="order-collapsed-message">Orders hidden. Use “Expand All” to view details.</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-primary-dark uppercase table-header">
                            <tr id="buy-table-header-row">
                                <th scope="col" class="px-2 py-2 rounded-l-lg">#</th>
                                <th scope="col" class="px-2 py-2">Price</th>
                                <th scope="col" class="px-2 py-2">Vol</th>
                                <th scope="col" class="px-2 py-2">Alloc</th>
                                <th scope="col" class="px-2 py-2">Value</th>
                                <th scope="col" class="px-2 py-2 rounded-r-lg">Avg Buy Price</th>
                            </tr>
                        </thead>
                        <tbody id="buy-ladder-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="card p-5 order-card" id="sell-orders-card">
                <h3 class="text-xl font-semibold text-primary-dark mb-4">Sell Orders</h3>
                <p class="order-collapsed-message">Orders hidden. Use “Expand All” to view details.</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-primary-dark uppercase table-header">
                            <tr id="sell-table-header-row">
                                <th scope="col" class="px-2 py-2 rounded-l-lg">#</th>
                                <th scope="col" class="px-2 py-2">Price</th>
                                <th scope="col" class="px-2 py-2">Vol</th>
                                <th scope="col" class="px-2 py-2">Alloc</th>
                                <th scope="col" class="px-2 py-2">Value</th>
                                <th scope="col" class="px-2 py-2">Avg Sell Price</th>
                                <th scope="col" class="px-2 py-2 rounded-r-lg">Profit</th>
                            </tr>
                        </thead>
                        <tbody id="sell-ladder-body"></tbody>
                    </table>
                </div>
            </div>
        </main>

        <button type="button" id="back-to-top" class="back-to-top" aria-label="Back to top">
            <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="18 15 12 9 6 15"></polyline>
                <line x1="12" y1="9" x2="12" y2="21"></line>
            </svg>
        </button>

        <footer class="display-footer">
            <span class="text-[10px] font-semibold tracking-[0.3em] uppercase opacity-70">Layout</span>
            <div class="layout-toggle-group" id="layout-toggle-group" role="group" aria-label="Switch layout">
                <button type="button" class="layout-toggle-button" data-layout-toggle="desktop" aria-pressed="false" aria-label="Show desktop layout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="12" rx="2"></rect>
                        <line x1="8" y1="20" x2="16" y2="20"></line>
                        <line x1="12" y1="16" x2="12" y2="20"></line>
                    </svg>
                </button>
                <button type="button" class="layout-toggle-button" data-layout-toggle="mobile" aria-pressed="false" aria-label="Show mobile layout">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="7" y="2" width="10" height="20" rx="2"></rect>
                        <line x1="11" y1="18" x2="13" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <!-- QR Code Modal -->
            <div id="qr-code-overlay" class="qr-code-overlay hidden"></div>
            <div id="qr-code-container" class="qr-code-container hidden">
                <div class="qr-code-content">
                    <button type="button" id="qr-code-close-btn" class="qr-code-close-btn" aria-label="Close QR code">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                    <p class="donation-message">Donations are much appreciated! 💜</p>
                    <div class="qr-code-wrapper">
                        <img src="QRcode.jpg" alt="Solana QR Code" class="qr-code-image" />
                    </div>
                    <div class="donation-address-display">
                        <p class="donation-network-label">Solana (SOL) Network</p>
                        <div class="donation-address-row">
                            <code class="donation-address-code" id="donation-address-display">F6mjNXKBKzjmKTK1Z9cWabFHZYtxMg8rojuNuppX2EG1</code>
                            <button type="button" id="donation-address-copy-btn" class="donation-address-copy-btn" aria-label="Copy Solana address">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <span id="display-status-announcer" class="sr-only" aria-live="polite"></span>
        </footer>
        <div id="export-sheet-overlay" class="export-sheet-overlay hidden" aria-hidden="true"></div>
        <section id="export-sheet" class="export-sheet hidden" role="dialog" aria-modal="true" aria-labelledby="export-sheet-title" aria-hidden="true">
            <div class="export-sheet-header">
                <div>
                    <p class="export-sheet-subtitle">Share or download your current plan.</p>
                    <h2 id="export-sheet-title">Export Plan</h2>
                </div>
                <button type="button" id="export-sheet-close" class="export-sheet-close" aria-label="Close export options">
                    <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="export-sheet-actions">
                <button type="button" class="export-sheet-button" data-export-format="csv">Download CSV</button>
                <button type="button" class="export-sheet-button" data-export-format="xls">Download XLS</button>
                <button type="button" class="export-sheet-button" data-export-format="pdf">Download PDF</button>
            </div>
            <div id="export-sheet-status" class="export-sheet-status" aria-live="polite">
                <span id="export-sheet-spinner" class="export-sheet-spinner hidden" aria-hidden="true"></span>
                <span class="export-sheet-status-text">Preparing export…</span>
            </div>
        </section>
    </div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Store plan data for CSV export
            let currentPlanData = null;
            let baselineBuySnapshot = null;
            const sellOnlyState = {
                highestExecutedRung: null,
                checkboxElements: []
            };
            const cloneBuyLadder = (ladder) => Array.isArray(ladder)
                ? ladder.map(rung => ({ ...rung }))
                : [];

            // Intro modal elements
            const introModal = document.getElementById('intro-modal');
            const introSkipCheckbox = document.getElementById('intro-skip-checkbox');
            const introGetStartedButton = document.getElementById('intro-get-started-button');
            const introSkipButton = document.getElementById('intro-skip-button');
            const introCloseButton = document.getElementById('intro-modal-close');
            const videoIframe = document.querySelector('.intro-video-iframe');
            const videoErrorMessage = document.getElementById('video-error-message');

            const form = document.getElementById('trading-plan-form');
            const skewSlider = document.getElementById('skew_value');
            const rungSlider = document.getElementById('number_of_rungs');
            const depthSlider = document.getElementById('depth');
            const skewNumericInput = document.getElementById('skew_value_input');
            const advancedToggle = document.getElementById('advanced_mode');
            const advancedSettings = document.getElementById('advanced-settings');
            const advancedSettingsToggle = document.getElementById('advanced-settings-toggle');
            const feeTypeSelect = document.getElementById('fee_type');
            const feeValueInput = document.getElementById('fee_value');
            const feeSettlementSelect = document.getElementById('fee_settlement');
            const sellOnlyCheckbox = document.getElementById('sell_only_mode');
            const sellOnlyInputs = document.getElementById('sell-only-inputs');
            const existingQuantityInput = document.getElementById('existing_quantity');
            const existingAvgPriceInput = document.getElementById('existing_avg_price');
            const spacingModeSelect = document.getElementById('spacing_mode');
            const equalQuantityCheckbox = document.getElementById('equal_quantity_mode');
            const buyChartCard = document.getElementById('buy-ladder');
            const buyOrdersCard = document.getElementById('buy-orders-card');
            const buyHeaderRow = document.getElementById('buy-table-header-row');
            const sellHeaderRow = document.getElementById('sell-table-header-row');
            const layoutToggleButtons = Array.from(document.querySelectorAll('[data-layout-toggle]'));
            const themeToggleButton = document.getElementById('theme-toggle');
            const displayStatusAnnouncer = document.getElementById('display-status-announcer');
            const planAlertsContainer = document.getElementById('plan-alerts');
            const navLinks = Array.from(document.querySelectorAll('.section-nav-link'));
            const backToTopButton = document.getElementById('back-to-top');
            const orderCards = Array.from(document.querySelectorAll('.order-card'));
            const orderToggleButtons = Array.from(document.querySelectorAll('[data-order-toggle]'));
            const exportSheet = document.getElementById('export-sheet');
            const exportSheetOverlay = document.getElementById('export-sheet-overlay');
            const exportSheetCloseBtn = document.getElementById('export-sheet-close');
            const exportSheetStatus = document.getElementById('export-sheet-status');
            const exportStatusText = exportSheetStatus?.querySelector('.export-sheet-status-text');
            const exportSheetSpinner = document.getElementById('export-sheet-spinner');
            const exportTriggerButton = document.getElementById('export-trigger');
            const exportFormatButtons = Array.from(document.querySelectorAll('[data-export-format]'));
            const savedPlanSelect = document.getElementById('saved-plan-select');
            const savePlanButton = document.getElementById('save-plan-btn');
            const loadPlanButton = document.getElementById('load-plan-btn');
            const resetPlanButton = document.getElementById('reset-plan-btn');

            const trackEvent = () => {};

            const trackInteraction = () => {};

            const startTimer = () => () => {};

            function debounce(func, wait = 200) {
                let timeout;
                return function debounced(...args) {
                    const context = this;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }

            const PLAN_UPDATE_DELAY_MS = 200;
            const schedulePlanUpdate = debounce(() => calculatePlan(), PLAN_UPDATE_DELAY_MS);
            const DEFAULT_PLAN_VALUES = {
                startingCapital: '50000',
                currentPrice: '100',
                numberOfRungs: '10',
                depth: '20',
                skewValue: '50',
                advancedMode: false,
                sellOnlyMode: false,
                feeType: 'percent',
                feeValue: '0',
                feeSettlement: 'netted',
                spacingMode: 'absolute',
                equalQuantityMode: false,
                existingQuantity: '0',
                existingAvgPrice: '0',
                sellOnlyHighestRung: null
            };

            const safeNumericSummary = (value, digits = 4) => {
                if (!Number.isFinite(value)) {
                    return null;
                }
                const precisionFactor = Math.pow(10, digits);
                return Math.round(value * precisionFactor) / precisionFactor;
            };

            const THEME_STORAGE_KEY = 'tpc-theme-mode';
            const LAYOUT_BREAKPOINT = 1024;

            const detectLayoutMode = (width = window.innerWidth) => (width < LAYOUT_BREAKPOINT ? 'mobile' : 'desktop');
            const detectThemePreference = () => (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const prefersReducedMotionQuery = window.matchMedia ? window.matchMedia('(prefers-reduced-motion: reduce)') : { matches: false, addEventListener: () => {} };

            const getCssVariable = (name, fallback = '') => {
                const value = getComputedStyle(document.body).getPropertyValue(name);
                return value ? value.trim() : fallback;
            };

            const updateToggleGroup = (buttons, attribute, activeValue) => {
                if (!Array.isArray(buttons)) {
                    return;
                }
                buttons.forEach((button) => {
                    const value = button.getAttribute(attribute);
                    const isActive = value === activeValue;
                    button.classList.toggle('active', isActive);
                    button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                });
            };

            const titleCase = (value) => value.charAt(0).toUpperCase() + value.slice(1);

            let currentLayoutMode = 'desktop';
            let currentThemeMode = 'light';
            let themeLocked = false;
            let displayTestsExecuted = false;

            const announceDisplayStatus = () => {
                if (!displayStatusAnnouncer) {
                    return;
                }
                displayStatusAnnouncer.textContent = `Layout: ${titleCase(currentLayoutMode)} · Theme: ${titleCase(currentThemeMode)}`;
            };

            const applyLayoutMode = (mode, options = {}) => {
                const { announce = true, source = 'system' } = options;
                const normalizedMode = mode === 'mobile' ? 'mobile' : 'desktop';
                currentLayoutMode = normalizedMode;
                document.body.classList.toggle('layout-mobile', normalizedMode === 'mobile');
                document.body.classList.toggle('layout-desktop', normalizedMode === 'desktop');
                document.body.dataset.layoutMode = normalizedMode;
                updateToggleGroup(layoutToggleButtons, 'data-layout-toggle', normalizedMode);
                if (announce) {
                    announceDisplayStatus();
                }
                updateBackToTopVisibility();
                trackEvent('display', 'layout:apply', {
                    mode: normalizedMode,
                    source
                });
                console.info(`[Display] Layout mode set to ${normalizedMode} (${source}).`);
            };

            const applyThemeMode = (mode, options = {}) => {
                const { announce = true, source = 'system' } = options;
                const normalizedTheme = mode === 'dark' ? 'dark' : 'light';
                currentThemeMode = normalizedTheme;
                document.body.classList.toggle('theme-dark', normalizedTheme === 'dark');
                document.body.classList.toggle('theme-light', normalizedTheme === 'light');
                document.body.dataset.themeMode = normalizedTheme;
                if (themeToggleButton) {
                    themeToggleButton.setAttribute('aria-pressed', normalizedTheme === 'dark' ? 'true' : 'false');
                    themeToggleButton.setAttribute('aria-label', normalizedTheme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme');
                }
                if (announce) {
                    announceDisplayStatus();
                }
                trackEvent('display', 'theme:apply', {
                    theme: normalizedTheme,
                    source
                });
                console.info(`[Display] Theme mode set to ${normalizedTheme} (${source}).`);
            };

            const formatCurrency = (value, minimumFractionDigits = 2) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits, maximumFractionDigits: 4 }).format(Number.isFinite(value) ? value : 0);
            const formatPercent = (value) => Number.isFinite(value) ? `${value.toFixed(2)}%` : '0.00%';
            const formatNumber = (value, digits = 4) => Number.isFinite(value) ? value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: digits }) : '0';
            
            // Format number with specified significant figures
            const formatSignificant = (value, sigFigs = 5) => {
                if (!Number.isFinite(value)) return '0';
                if (value === 0) return '0';
                return parseFloat(value.toPrecision(sigFigs)).toString();
            };
            
            // Format currency with 5 significant figures
            const formatCurrencySignificant = (value, sigFigs = 5) => {
                if (!Number.isFinite(value)) return '$0.00';
                if (value === 0) return '$0.00';
                
                const rounded = parseFloat(value.toPrecision(sigFigs));
                
                // Determine decimal places needed to show sigFigs
                const absValue = Math.abs(rounded);
                let decimals;
                if (absValue >= 1) {
                    const magnitude = Math.floor(Math.log10(absValue));
                    decimals = Math.max(2, Math.min(6, sigFigs - 1 - magnitude));
                } else if (absValue > 0) {
                    const magnitude = Math.floor(Math.log10(absValue));
                    decimals = Math.max(2, sigFigs - 1 - magnitude);
                } else {
                    decimals = 2;
                }
                
                return new Intl.NumberFormat('en-US', { 
                    style: 'currency', 
                    currency: 'USD',
                    minimumFractionDigits: Math.min(decimals, 2),
                    maximumFractionDigits: decimals
                }).format(rounded);
            };
            const clampNumber = (value, min, max) => Math.min(Math.max(value, min), max);
            const MAX_SKEW_RATIO = 10;
            const ALERT_ICON_SVG = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9v4"></path><path d="M12 17h.01"></path><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path></svg>`;

            const renderPlanAlerts = (messages = []) => {
                if (!planAlertsContainer) {
                    return;
                }
                if (!messages || messages.length === 0) {
                    planAlertsContainer.classList.add('hidden');
                    planAlertsContainer.innerHTML = '';
                    return;
                }
                planAlertsContainer.classList.remove('hidden');
                planAlertsContainer.innerHTML = '';
                messages.forEach((message) => {
                    const banner = document.createElement('div');
                    banner.className = 'alert-banner';
                    banner.setAttribute('role', 'alert');
                    banner.innerHTML = `${ALERT_ICON_SVG}<span class="alert-message"></span>`;
                    const textEl = banner.querySelector('.alert-message');
                    if (textEl) {
                        textEl.textContent = message;
                    }
                    planAlertsContainer.appendChild(banner);
                });
            };

            // Storage keys
            const LEGACY_INTRO_SKIP_KEY = 'orderskew_intro_skip';
            const INTRO_DISMISS_STORAGE_KEY = 'onboardingDismissed';
            const STORAGE_PREFIX = 'orderskew_';
            const SAVED_PLANS_KEY = STORAGE_PREFIX + 'saved_plans';
            const STORAGE_KEYS = {
                startingCapital: STORAGE_PREFIX + 'starting_capital',
                currentPrice: STORAGE_PREFIX + 'current_price',
                numberOfRungs: STORAGE_PREFIX + 'number_of_rungs',
                depth: STORAGE_PREFIX + 'depth',
                skewValue: STORAGE_PREFIX + 'skew_value',
                advancedMode: STORAGE_PREFIX + 'advanced_mode',
                sellOnlyMode: STORAGE_PREFIX + 'sell_only_mode',
                feeType: STORAGE_PREFIX + 'fee_type',
                feeValue: STORAGE_PREFIX + 'fee_value',
                feeSettlement: STORAGE_PREFIX + 'fee_settlement',
                spacingMode: STORAGE_PREFIX + 'spacing_mode',
                equalQuantityMode: STORAGE_PREFIX + 'equal_quantity_mode',
                existingQuantity: STORAGE_PREFIX + 'existing_quantity',
                existingAvgPrice: STORAGE_PREFIX + 'existing_avg_price'
            };

            const getStoredValue = (key) => {
                try {
                    return localStorage.getItem(key);
                } catch (error) {
                    console.warn('[Storage] Unable to read key', key, error);
                    return null;
                }
            };

            const setStoredValue = (key, value) => {
                try {
                    localStorage.setItem(key, value);
                } catch (error) {
                    console.warn('[Storage] Unable to persist key', key, error);
                }
            };

            const removeStoredValue = (key) => {
                try {
                    localStorage.removeItem(key);
                } catch (error) {
                    console.warn('[Storage] Unable to remove key', key, error);
                }
            };

            // Form persistence functions
            const saveFormValue = (key, value) => {
                if (value !== null && value !== undefined) {
                    setStoredValue(key, String(value));
                }
            };

            const loadFormValue = (key, defaultValue = null) => {
                const stored = getStoredValue(key);
                return stored !== null ? stored : defaultValue;
            };

            const sliderControlConfigs = [
                {
                    id: 'number_of_rungs',
                    numericInputId: 'number_of_rungs_input',
                    displayId: 'number_of_rungs_display',
                    labelId: 'number_of_rungs_label',
                    min: 2,
                    max: 50,
                    step: 1,
                    shiftStep: 5,
                    storageKey: STORAGE_KEYS.numberOfRungs,
                    displayFormatter: (value) => Math.round(value),
                    normalize: (value) => {
                        const parsed = Number(value);
                        const numeric = Number.isFinite(parsed) ? parsed : 2;
                        return clampNumber(Math.round(numeric), 2, 50);
                    }
                },
                {
                    id: 'depth',
                    numericInputId: 'depth_input',
                    displayId: 'depth_display',
                    labelId: 'depth_label',
                    min: 0.1,
                    max: 99,
                    step: 0.1,
                    shiftStep: 1,
                    storageKey: STORAGE_KEYS.depth,
                    displayFormatter: (value) => (value < 2 ? value.toFixed(1) : Math.round(value)),
                    normalize: (value) => {
                        let numeric = parseFloat(value);
                        if (!Number.isFinite(numeric)) {
                            numeric = 0.1;
                        }
                        if (numeric >= 2) {
                            numeric = Math.round(numeric);
                        } else {
                            numeric = Math.round(numeric * 10) / 10;
                        }
                        return clampNumber(numeric, 0.1, 99);
                    }
                },
                {
                    id: 'skew_value',
                    numericInputId: 'skew_value_input',
                    displayId: 'skew_value_display',
                    labelId: 'skew_value_label',
                    min: 0,
                    max: 100,
                    step: 1,
                    shiftStep: 10,
                    storageKey: STORAGE_KEYS.skewValue,
                    displayFormatter: (value) => Math.round(value),
                    normalize: (value) => {
                        const parsed = Number(value);
                        const numeric = Number.isFinite(parsed) ? parsed : 0;
                        return clampNumber(Math.round(numeric), 0, 100);
                    }
                }
            ];

            const sliderControlInstances = new Map();

            const updateSliderAriaAttributes = (sliderElement, config, value, formattedText) => {
                if (!sliderElement) {
                    return;
                }
                if (typeof config.min === 'number') {
                    sliderElement.setAttribute('aria-valuemin', String(config.min));
                }
                if (typeof config.max === 'number') {
                    sliderElement.setAttribute('aria-valuemax', String(config.max));
                }
                sliderElement.setAttribute('aria-valuenow', String(value));
                if (formattedText !== undefined) {
                    sliderElement.setAttribute('aria-valuetext', String(formattedText));
                }
                sliderElement.setAttribute('role', 'slider');
            };

            const createSliderControl = (config) => {
                const slider = document.getElementById(config.id);
                const numericInput = document.getElementById(config.numericInputId);
                const display = document.getElementById(config.displayId);
                if (!slider || !numericInput || !display) {
                    return null;
                }

                const stepperButtons = Array.from(document.querySelectorAll(`[data-step-target="${config.id}"]`));
                const shiftStep = typeof config.shiftStep === 'number'
                    ? config.shiftStep
                    : Math.max((config.step || 1) * 5, 1);
                const formatDisplay = (value) => {
                    if (typeof config.displayFormatter === 'function') {
                        return config.displayFormatter(value);
                    }
                    return Number.isFinite(value) ? value : '';
                };
                const normalize = (value) => {
                    if (typeof config.normalize === 'function') {
                        return config.normalize(value);
                    }
                    let numeric = parseFloat(value);
                    if (!Number.isFinite(numeric)) {
                        numeric = typeof config.min === 'number' ? config.min : 0;
                    }
                    if (!config.decimals && (config.step && config.step >= 1)) {
                        numeric = Math.round(numeric);
                    } else if (typeof config.decimals === 'number') {
                        const factor = Math.pow(10, config.decimals);
                        numeric = Math.round(numeric * factor) / factor;
                    }
                    if (typeof config.min === 'number') {
                        numeric = Math.max(config.min, numeric);
                    }
                    if (typeof config.max === 'number') {
                        numeric = Math.min(config.max, numeric);
                    }
                    return numeric;
                };

                const label = config.labelId
                    ? document.getElementById(config.labelId)
                    : document.querySelector(`label[for="${config.id}"]`);
                if (label) {
                    const labelText = label.textContent?.trim();
                    if (labelText) {
                        slider.setAttribute('aria-label', labelText);
                    }
                }

                const state = {
                    value: normalize(slider.value)
                };

                const applyValue = (rawValue, options = {}) => {
                    const normalized = normalize(rawValue);
                    if (!options.force && state.value === normalized) {
                        return normalized;
                    }
                    state.value = normalized;
                    slider.value = normalized;
                    numericInput.value = normalized;
                    const formatted = formatDisplay(normalized);
                    display.textContent = formatted;
                    updateSliderAriaAttributes(slider, config, normalized, formatted);
                    if (options.persist !== false && config.storageKey) {
                        saveFormValue(config.storageKey, normalized);
                    }
                    if (options.schedule !== false) {
                        schedulePlanUpdate();
                    }
                    return normalized;
                };

                const handleSliderInput = (event) => {
                    applyValue(event.target.value);
                    trackInteraction('slider-adjust', {
                        id: config.id,
                        source: 'slider',
                        value: Number(event.target.value)
                    });
                };

                slider.addEventListener('input', handleSliderInput);

                numericInput.addEventListener('input', (event) => {
                    const raw = event.target.value;
                    if (raw === '' || raw === '-' || raw === '.') {
                        return;
                    }
                    applyValue(raw);
                    trackInteraction('slider-adjust', {
                        id: config.id,
                        source: 'input',
                        value: Number(raw)
                    });
                });

                numericInput.addEventListener('blur', () => {
                    applyValue(numericInput.value);
                });

                const adjustByDelta = (delta) => {
                    if (!Number.isFinite(delta)) {
                        return;
                    }
                    applyValue(state.value + delta, { force: true });
                };

                stepperButtons.forEach((button) => {
                    button.addEventListener('click', () => {
                        const explicitStep = parseFloat(button.dataset.step);
                        const delta = Number.isFinite(explicitStep) ? explicitStep : (config.step || 1);
                        adjustByDelta(delta);
                        trackInteraction('slider-stepper', {
                            id: config.id,
                            delta
                        });
                    });
                });

                const handleKeyControl = (event) => {
                    const { key } = event;
                    const baseStep = config.step || 1;
                    const largerStep = shiftStep || baseStep * 5;
                    let delta = 0;
                    if (key === 'ArrowRight' || key === 'ArrowUp') {
                        delta = event.shiftKey ? largerStep : baseStep;
                    } else if (key === 'ArrowLeft' || key === 'ArrowDown') {
                        delta = event.shiftKey ? -largerStep : -baseStep;
                    } else if (key === 'Home' && typeof config.min === 'number') {
                        event.preventDefault();
                        applyValue(config.min, { force: true });
                        return;
                    } else if (key === 'End' && typeof config.max === 'number') {
                        event.preventDefault();
                        applyValue(config.max, { force: true });
                        return;
                    } else if (key === 'PageUp') {
                        delta = largerStep;
                    } else if (key === 'PageDown') {
                        delta = -largerStep;
                    } else {
                        return;
                    }
                    event.preventDefault();
                    adjustByDelta(delta);
                };

                slider.addEventListener('keydown', handleKeyControl);
                numericInput.addEventListener('keydown', handleKeyControl);

                const storedValue = config.storageKey ? loadFormValue(config.storageKey) : null;
                if (storedValue !== null) {
                    applyValue(storedValue, { schedule: false, persist: false, force: true });
                } else {
                    applyValue(slider.value, { schedule: false, persist: false, force: true });
                }

                return {
                    id: config.id,
                    get value() {
                        return state.value;
                    },
                    setValue: (value, options = {}) => applyValue(value, { ...options, force: true }),
                    disable: (disabled) => {
                        if (disabled) {
                            slider.setAttribute('disabled', 'true');
                            numericInput.setAttribute('disabled', 'true');
                            slider.classList.add('opacity-50', 'cursor-not-allowed');
                            numericInput.classList.add('cursor-not-allowed');
                            stepperButtons.forEach(btn => btn.setAttribute('disabled', 'true'));
                        } else {
                            slider.removeAttribute('disabled');
                            numericInput.removeAttribute('disabled');
                            slider.classList.remove('opacity-50', 'cursor-not-allowed');
                            numericInput.classList.remove('cursor-not-allowed');
                            stepperButtons.forEach(btn => btn.removeAttribute('disabled'));
                        }
                    }
                };
            };

            const initializeSliderControls = () => {
                sliderControlConfigs.forEach((config) => {
                    const instance = createSliderControl(config);
                    if (instance) {
                        sliderControlInstances.set(config.id, instance);
                    }
                });
            };

            const getSavedPlans = () => {
                const raw = getStoredValue(SAVED_PLANS_KEY);
                if (!raw) {
                    return {};
                }
                try {
                    return JSON.parse(raw);
                } catch (error) {
                    console.warn('[Storage] Unable to parse saved plans', error);
                    return {};
                }
            };

            const persistSavedPlans = (plans) => {
                setStoredValue(SAVED_PLANS_KEY, JSON.stringify(plans));
            };

            const refreshSavedPlansOptions = (activeName = '') => {
                if (!savedPlanSelect) {
                    return;
                }
                const plans = getSavedPlans();
                savedPlanSelect.innerHTML = '';
                const names = Object.keys(plans);
                if (names.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No saved plans';
                    option.disabled = true;
                    option.selected = true;
                    savedPlanSelect.appendChild(option);
                    loadPlanButton?.setAttribute('disabled', 'true');
                    return;
                }
                const placeholder = document.createElement('option');
                placeholder.value = '';
                placeholder.textContent = 'Select a plan';
                placeholder.disabled = true;
                placeholder.selected = !activeName;
                savedPlanSelect.appendChild(placeholder);
                names.forEach((name) => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    if (activeName === name) {
                        option.selected = true;
                    }
                    savedPlanSelect.appendChild(option);
                });
                if (activeName && savedPlanSelect.value !== activeName) {
                    savedPlanSelect.value = activeName;
                }
                if (savedPlanSelect.value) {
                    loadPlanButton?.removeAttribute('disabled');
                } else {
                    loadPlanButton?.setAttribute('disabled', 'true');
                }
            };

            const collectPlanStateFromForm = () => ({
                startingCapital: document.getElementById('starting_capital')?.value ?? DEFAULT_PLAN_VALUES.startingCapital,
                currentPrice: document.getElementById('current_price')?.value ?? DEFAULT_PLAN_VALUES.currentPrice,
                numberOfRungs: document.getElementById('number_of_rungs')?.value ?? DEFAULT_PLAN_VALUES.numberOfRungs,
                depth: document.getElementById('depth')?.value ?? DEFAULT_PLAN_VALUES.depth,
                skewValue: document.getElementById('skew_value')?.value ?? DEFAULT_PLAN_VALUES.skewValue,
                advancedMode: !!advancedToggle?.checked,
                sellOnlyMode: !!sellOnlyCheckbox?.checked,
                feeType: feeTypeSelect?.value ?? DEFAULT_PLAN_VALUES.feeType,
                feeValue: feeValueInput?.value ?? DEFAULT_PLAN_VALUES.feeValue,
                feeSettlement: feeSettlementSelect?.value ?? DEFAULT_PLAN_VALUES.feeSettlement,
                spacingMode: spacingModeSelect?.value ?? DEFAULT_PLAN_VALUES.spacingMode,
                equalQuantityMode: !!equalQuantityCheckbox?.checked,
                existingQuantity: existingQuantityInput?.value ?? DEFAULT_PLAN_VALUES.existingQuantity,
                existingAvgPrice: existingAvgPriceInput?.value ?? DEFAULT_PLAN_VALUES.existingAvgPrice,
                sellOnlyHighestRung: sellOnlyState.highestExecutedRung
            });

            const applyPlanStateToForm = (state) => {
                const applyInputValue = (id, value, storageKey) => {
                    const element = document.getElementById(id);
                    if (!element || value === undefined || value === null) {
                        return;
                    }
                    element.value = value;
                    if (storageKey) {
                        saveFormValue(storageKey, value);
                    }
                };

                applyInputValue('starting_capital', state.startingCapital ?? DEFAULT_PLAN_VALUES.startingCapital, STORAGE_KEYS.startingCapital);
                applyInputValue('current_price', state.currentPrice ?? DEFAULT_PLAN_VALUES.currentPrice, STORAGE_KEYS.currentPrice);
                sliderControlInstances.get('number_of_rungs')?.setValue(state.numberOfRungs ?? DEFAULT_PLAN_VALUES.numberOfRungs, { schedule: false, persist: true });
                sliderControlInstances.get('depth')?.setValue(state.depth ?? DEFAULT_PLAN_VALUES.depth, { schedule: false, persist: true });
                sliderControlInstances.get('skew_value')?.setValue(state.skewValue ?? DEFAULT_PLAN_VALUES.skewValue, { schedule: false, persist: true });
                applyInputValue('fee_value', state.feeValue ?? DEFAULT_PLAN_VALUES.feeValue, STORAGE_KEYS.feeValue);
                applyInputValue('existing_quantity', state.existingQuantity ?? DEFAULT_PLAN_VALUES.existingQuantity, STORAGE_KEYS.existingQuantity);
                applyInputValue('existing_avg_price', state.existingAvgPrice ?? DEFAULT_PLAN_VALUES.existingAvgPrice, STORAGE_KEYS.existingAvgPrice);
                if (feeTypeSelect && state.feeType) {
                    feeTypeSelect.value = state.feeType;
                    saveFormValue(STORAGE_KEYS.feeType, state.feeType);
                }
                if (feeSettlementSelect && state.feeSettlement) {
                    feeSettlementSelect.value = state.feeSettlement;
                    saveFormValue(STORAGE_KEYS.feeSettlement, state.feeSettlement);
                }
                if (spacingModeSelect && state.spacingMode) {
                    spacingModeSelect.value = state.spacingMode;
                    saveFormValue(STORAGE_KEYS.spacingMode, state.spacingMode);
                }

                if (advancedToggle) {
                    advancedToggle.checked = !!state.advancedMode;
                    if (advancedToggle.checked) {
                        advancedSettings?.classList.remove('hidden');
                        if (advancedSettingsToggle) {
                            advancedSettingsToggle.classList.remove('hidden');
                            advancedSettingsToggle.classList.add('flex');
                            advancedSettingsToggle.setAttribute('aria-expanded', 'true');
                            advancedSettingsToggle.querySelector('svg')?.classList.add('rotate-180');
                        }
                    } else {
                        advancedSettings?.classList.add('hidden');
                        if (advancedSettingsToggle) {
                            advancedSettingsToggle.classList.add('hidden');
                            advancedSettingsToggle.classList.remove('flex');
                            advancedSettingsToggle.setAttribute('aria-expanded', 'false');
                            advancedSettingsToggle.querySelector('svg')?.classList.remove('rotate-180');
                        }
                    }
                    saveFormValue(STORAGE_KEYS.advancedMode, advancedToggle.checked);
                }

                if (sellOnlyCheckbox) {
                    sellOnlyCheckbox.checked = !!state.sellOnlyMode;
                    if (sellOnlyCheckbox.checked) {
                        sellOnlyInputs?.classList.remove('hidden');
                    } else {
                        sellOnlyInputs?.classList.add('hidden');
                    }
                    saveFormValue(STORAGE_KEYS.sellOnlyMode, sellOnlyCheckbox.checked);
                }

                if (equalQuantityCheckbox) {
                    equalQuantityCheckbox.checked = !!state.equalQuantityMode;
                    setSkewDisabled(equalQuantityCheckbox.checked);
                    saveFormValue(STORAGE_KEYS.equalQuantityMode, equalQuantityCheckbox.checked);
                }

                setSellOnlyHighestExecutedRung(state.sellOnlyHighestRung ?? null);
                calculatePlan();
            };

            const resetPlanToDefaults = () => {
                Object.values(STORAGE_KEYS).forEach((key) => removeStoredValue(key));
                applyPlanStateToForm(DEFAULT_PLAN_VALUES);
                if (savedPlanSelect) {
                    savedPlanSelect.value = '';
                }
                loadPlanButton?.setAttribute('disabled', 'true');
            };

            savePlanButton?.addEventListener('click', () => {
                const plans = getSavedPlans();
                const suggestedName = savedPlanSelect?.value && getSavedPlans()[savedPlanSelect.value]
                    ? savedPlanSelect.value
                    : `Plan ${Object.keys(plans).length + 1}`;
                const name = window.prompt('Name this plan', suggestedName);
                if (!name) {
                    return;
                }
                const trimmed = name.trim();
                if (!trimmed) {
                    alert('Please provide a valid plan name.');
                    return;
                }
                if (plans[trimmed] && !window.confirm(`Overwrite "${trimmed}"?`)) {
                    return;
                }
                plans[trimmed] = collectPlanStateFromForm();
                persistSavedPlans(plans);
                refreshSavedPlansOptions(trimmed);
                trackEvent('plan', 'save', { name: trimmed });
            });

            loadPlanButton?.addEventListener('click', () => {
                if (!savedPlanSelect) {
                    return;
                }
                const selected = savedPlanSelect.value;
                if (!selected) {
                    return;
                }
                const plans = getSavedPlans();
                if (!plans[selected]) {
                    alert('Unable to find that saved plan.');
                    refreshSavedPlansOptions();
                    return;
                }
                applyPlanStateToForm(plans[selected]);
                trackEvent('plan', 'load', { name: selected });
            });

            resetPlanButton?.addEventListener('click', () => {
                if (window.confirm('Reset configuration to defaults?')) {
                    resetPlanToDefaults();
                    trackEvent('plan', 'reset', {});
                }
            });

            savedPlanSelect?.addEventListener('change', () => {
                if (!loadPlanButton) {
                    return;
                }
                if (savedPlanSelect.value) {
                    loadPlanButton.removeAttribute('disabled');
                } else {
                    loadPlanButton.setAttribute('disabled', 'true');
                }
            });

            const loadFormValues = () => {
                // Load number inputs
                const startingCapitalInput = document.getElementById('starting_capital');
                const currentPriceInput = document.getElementById('current_price');
                if (startingCapitalInput) {
                    const saved = loadFormValue(STORAGE_KEYS.startingCapital);
                    if (saved !== null) startingCapitalInput.value = saved;
                }
                if (currentPriceInput) {
                    const saved = loadFormValue(STORAGE_KEYS.currentPrice);
                    if (saved !== null) currentPriceInput.value = saved;
                }

                // Load checkboxes
                if (advancedToggle) {
                    const saved = loadFormValue(STORAGE_KEYS.advancedMode);
                    if (saved === 'true') {
                        advancedToggle.checked = true;
                        if (advancedSettings) {
                            advancedSettings.classList.remove('hidden');
                            if (advancedSettingsToggle) {
                                advancedSettingsToggle.classList.remove('hidden');
                                advancedSettingsToggle.classList.add('flex');
                                advancedSettingsToggle.setAttribute('aria-expanded', 'true');
                                advancedSettingsToggle.querySelector('svg')?.classList.add('rotate-180');
                            }
                        }
                        // Also need to handle equal quantity checkbox state if it was checked
                        if (equalQuantityCheckbox) {
                            const equalQuantitySaved = loadFormValue(STORAGE_KEYS.equalQuantityMode);
                            if (equalQuantitySaved === 'true') {
                                equalQuantityCheckbox.checked = true;
                            }
                        }
                    }
                }
                if (sellOnlyCheckbox) {
                    const saved = loadFormValue(STORAGE_KEYS.sellOnlyMode);
                    if (saved === 'true') {
                        sellOnlyCheckbox.checked = true;
                        if (sellOnlyInputs) sellOnlyInputs.classList.remove('hidden');
                    }
                }
                if (equalQuantityCheckbox && advancedToggle && advancedToggle.checked) {
                    const saved = loadFormValue(STORAGE_KEYS.equalQuantityMode);
                    if (saved === 'true') {
                        equalQuantityCheckbox.checked = true;
                    }
                }

                // Load selects
                if (feeTypeSelect) {
                    const saved = loadFormValue(STORAGE_KEYS.feeType);
                    if (saved !== null) feeTypeSelect.value = saved;
                }
                if (feeSettlementSelect) {
                    const saved = loadFormValue(STORAGE_KEYS.feeSettlement);
                    if (saved !== null) feeSettlementSelect.value = saved;
                }
                if (spacingModeSelect) {
                    const saved = loadFormValue(STORAGE_KEYS.spacingMode);
                    if (saved !== null) spacingModeSelect.value = saved;
                }

                // Load number inputs in advanced mode
                if (feeValueInput) {
                    const saved = loadFormValue(STORAGE_KEYS.feeValue);
                    if (saved !== null) feeValueInput.value = saved;
                }
                if (existingQuantityInput) {
                    const saved = loadFormValue(STORAGE_KEYS.existingQuantity);
                    if (saved !== null) existingQuantityInput.value = saved;
                }
                if (existingAvgPriceInput) {
                    const saved = loadFormValue(STORAGE_KEYS.existingAvgPrice);
                    if (saved !== null) existingAvgPriceInput.value = saved;
                }
                refreshSavedPlansOptions();
            };

            if (getStoredValue('tpc-layout-mode')) {
                removeStoredValue('tpc-layout-mode');
            }

            applyLayoutMode(detectLayoutMode(), { announce: false, source: 'auto-detect' });

            const storedThemePreference = getStoredValue(THEME_STORAGE_KEY);
            if (storedThemePreference === 'dark' || storedThemePreference === 'light') {
                themeLocked = true;
                applyThemeMode(storedThemePreference, { announce: false, source: 'preference' });
            } else {
                applyThemeMode(detectThemePreference(), { announce: false, source: 'system' });
            }

            announceDisplayStatus();

            if (layoutToggleButtons.length > 0) {
                layoutToggleButtons.forEach((button) => {
                    button.addEventListener('click', () => {
                        const value = button.getAttribute('data-layout-toggle');
                        if (!value) {
                            return;
                        }
                        const previousMode = currentLayoutMode;
                        trackInteraction('layout-toggle', {
                            requested: value,
                            previous: previousMode
                        });
                        applyLayoutMode(value, { source: 'user' });
                    });
                });
            }

            if (themeToggleButton) {
                themeToggleButton.addEventListener('click', () => {
                    const nextTheme = currentThemeMode === 'dark' ? 'light' : 'dark';
                    themeLocked = true;
                    setStoredValue(THEME_STORAGE_KEY, nextTheme);
                    trackInteraction('theme-toggle', {
                        requested: nextTheme,
                        previous: currentThemeMode
                    });
                    applyThemeMode(nextTheme, { source: 'user' });
                });
            }

            if (window.matchMedia) {
                const colorSchemeMedia = window.matchMedia('(prefers-color-scheme: dark)');
                if (colorSchemeMedia && typeof colorSchemeMedia.addEventListener === 'function') {
                    colorSchemeMedia.addEventListener('change', (event) => {
                        if (themeLocked) {
                            return;
                        }
                        trackEvent('display', 'theme:media-change', {
                            prefersDark: !!event.matches
                        });
                        applyThemeMode(event.matches ? 'dark' : 'light', { source: 'system' });
                    });
                }
            }

            const deriveExecutedBuyTotals = (buyLadder, highestRung) => {
                if (!Array.isArray(buyLadder) || buyLadder.length === 0 || !Number.isFinite(highestRung)) {
                    return {
                        quantity: 0,
                        netCapital: 0,
                        fees: 0,
                        avgPrice: 0
                    };
                }
                const executed = buyLadder.filter(rung => rung.rung <= highestRung && rung.assetSize > 0);
                if (executed.length === 0) {
                    return {
                        quantity: 0,
                        netCapital: 0,
                        fees: 0,
                        avgPrice: 0
                    };
                }
                const quantity = executed.reduce((sum, rung) => sum + rung.assetSize, 0);
                const netCapital = executed.reduce((sum, rung) => sum + rung.netCapital, 0);
                const fees = executed.reduce((sum, rung) => sum + rung.fee, 0);
                const avgPrice = quantity > 0 ? netCapital / quantity : 0;
                return {
                    quantity,
                    netCapital,
                    fees,
                    avgPrice
                };
            };

            const updateSellOnlyCheckboxDisplay = () => {
                const { checkboxElements, highestExecutedRung } = sellOnlyState;
                if (!Array.isArray(checkboxElements)) {
                    return;
                }
                checkboxElements.forEach(checkbox => {
                    const rung = Number(checkbox.dataset.rung);
                    if (!Number.isFinite(rung)) {
                        checkbox.checked = false;
                        return;
                    }
                    checkbox.checked = Number.isFinite(highestExecutedRung) && highestExecutedRung !== null
                        ? rung <= highestExecutedRung
                        : false;
                });
            };

            const setSellOnlyHighestExecutedRung = (rung) => {
                if (Number.isFinite(rung) && rung > 0) {
                    sellOnlyState.highestExecutedRung = rung;
                } else {
                    sellOnlyState.highestExecutedRung = null;
                }
                updateSellOnlyCheckboxDisplay();
            };

            const bindSellOnlyCheckboxEvents = () => {
                sellOnlyState.checkboxElements = Array.from(document.querySelectorAll('.buy-rung-executed'));
                if (sellOnlyState.checkboxElements.length === 0) {
                    return;
                }
                sellOnlyState.checkboxElements.forEach(checkbox => {
                    checkbox.removeEventListener('click', checkbox.__sellOnlyHandler);
                    const handler = (event) => {
                        event.preventDefault();
                        const target = event.currentTarget;
                        const rung = Number(target.dataset.rung);
                        if (!Number.isFinite(rung)) {
                            setSellOnlyHighestExecutedRung(null);
                            calculatePlan();
                            return;
                        }
                        const previousHighest = sellOnlyState.highestExecutedRung;
                        let newHighest;
                        if (Number.isFinite(previousHighest) && previousHighest === rung) {
                            newHighest = rung > 1 ? rung - 1 : null;
                        } else {
                            newHighest = rung;
                        }
                        trackInteraction('sell-only-execution-toggle', {
                            rung,
                            previousHighest,
                            newHighest
                        });
                        setSellOnlyHighestExecutedRung(newHighest);
                        calculatePlan();
                    };
                    checkbox.__sellOnlyHandler = handler;
                    checkbox.addEventListener('click', handler);
                });
                updateSellOnlyCheckboxDisplay();
            };

            const applyDerivedSellOnlyInputs = (derivedTotals, options = {}) => {
                const { force = false } = options;
                if (!existingQuantityInput || !existingAvgPriceInput) {
                    return;
                }
                if (!derivedTotals || derivedTotals.quantity <= 0 || derivedTotals.avgPrice <= 0) {
                    return;
                }
                const currentQuantity = parseFloat(existingQuantityInput.value);
                const currentAvgPrice = parseFloat(existingAvgPriceInput.value);
                const quantityInUse = Number.isFinite(currentQuantity) && currentQuantity > 0;
                const avgInUse = Number.isFinite(currentAvgPrice) && currentAvgPrice > 0;
                if (!force && (quantityInUse || avgInUse)) {
                    return;
                }
                existingQuantityInput.value = derivedTotals.quantity;
                existingAvgPriceInput.value = derivedTotals.avgPrice;
            };

            const buildSkewWeights = (count, skewValue) => {
                if (count <= 0) {
                    return [];
                }
                if (skewValue <= 0) {
                    return Array(count).fill(1);
                }
                const normalizedSkew = clampNumber(skewValue, 0, 100) / 100;
                const targetRatio = 1 + Math.pow(normalizedSkew, 1.2) * (MAX_SKEW_RATIO - 1);
                const minWeight = 1 / targetRatio;
                const curvature = 1 + normalizedSkew;

                return Array.from({ length: count }, (_, index) => {
                    if (count === 1) {
                        return 1;
                    }
                    const relativeIndex = index / (count - 1);
                    const shapedIndex = Math.pow(relativeIndex, curvature);
                    const curveValue = Math.pow(targetRatio, shapedIndex);
                    return Math.max(curveValue - 1 + minWeight, Number.EPSILON);
                });
            };

            const computeEqualGrossAllocations = (totalQuantity, prices) => {
                const allocations = Array(prices.length).fill(0);
                const validEntries = prices
                    .map((price, idx) => ({ price, idx }))
                    .filter(entry => entry.price > 0);

                if (totalQuantity <= 0 || validEntries.length === 0) {
                    return { allocations, quantityPerRung: 0 };
                }

                const sharedQuantity = totalQuantity / validEntries.length;

                validEntries.forEach(({ idx }) => {
                    allocations[idx] = sharedQuantity;
                });

                return { allocations, quantityPerRung: sharedQuantity };
            };

            const ensurePlanAvailable = () => {
                if (currentPlanData) {
                    return currentPlanData;
                }
                trackEvent('calculation', 'plan:missing', {});
                const firstInvalidLabel = document.querySelector('.label-invalid');
                if (firstInvalidLabel) {
                    firstInvalidLabel.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    const infoBtn = firstInvalidLabel.querySelector('.info-button');
                    if (infoBtn) {
                        infoBtn.focus({ preventScroll: true });
                    }
                }
                return null;
            };

            const escapeForHtml = (value) => {
                if (value === null || value === undefined) {
                    return '';
                }
                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            };

            const buildTableCell = (label, content, classList = []) => {
                const classes = ['px-2', 'py-2', ...classList].filter(Boolean).join(' ');
                const safeLabel = escapeForHtml(label);
                return `<td class="${classes}" data-label="${safeLabel}">${content}</td>`;
            };

            const collectExportSettings = () => ({
                date: new Date().toLocaleString(),
                startingCapital: document.getElementById('starting_capital')?.value ?? '',
                rungs: document.getElementById('number_of_rungs')?.value ?? '',
                currentPrice: document.getElementById('current_price')?.value ?? '',
                depth: document.getElementById('depth')?.value ?? '',
                skew: document.getElementById('skew_value')?.value ?? '',
                advancedMode: advancedToggle ? advancedToggle.checked : false,
                sellOnly: sellOnlyCheckbox ? sellOnlyCheckbox.checked : false,
                equalQuantity: equalQuantityCheckbox ? equalQuantityCheckbox.checked : false,
                feeType: feeTypeSelect ? feeTypeSelect.value : '',
                feeSettlement: feeSettlementSelect ? feeSettlementSelect.value : '',
                feeValue: feeValueInput ? feeValueInput.value : '',
                spacingMode: spacingModeSelect ? spacingModeSelect.value : 'absolute'
            });

            const buildCsvContent = (plan, settings) => {
                let csvContent = "";

                csvContent += "Setting,Value\r\n";
                csvContent += `Date,"${settings.date}"\r\n`;
                csvContent += `Initial Capital,${settings.startingCapital}\r\n`;
                csvContent += `Number of Rungs,${settings.rungs}\r\n`;
                csvContent += `Current Asset Price,${settings.currentPrice}\r\n`;
                csvContent += `Width (%),${settings.depth}\r\n`;
                csvContent += `Allocation Skew,${settings.skew}\r\n`;
                csvContent += `Advanced Mode Enabled,${settings.advancedMode ? 'Yes' : 'No'}\r\n`;
                csvContent += `Sell-only Mode,${settings.sellOnly ? 'Yes' : 'No'}\r\n`;
                csvContent += `Equal Quantity Per Rung,${settings.equalQuantity ? 'Yes' : 'No'}\r\n`;
                if (settings.advancedMode) {
                    csvContent += `Trading Fee Type,${settings.feeType}\r\n`;
                    csvContent += `Fee Settlement Mode,${settings.feeSettlement}\r\n`;
                    csvContent += `Trading Fee Value,${settings.feeValue}\r\n`;
                    csvContent += `Spacing Mode,${plan.spacing && plan.spacing.mode === 'relative' ? 'Relative (% per rung)' : 'Absolute'}\r\n`;
                }
                csvContent += "\r\n";

                csvContent += "Summary Metric,Value\r\n";
                csvContent += `Avg. Buy Price,${plan.summary.avgBuyPrice}\r\n`;
                const csvRungLabel = (rung, price) => (rung ? `Rung ${rung} @ ${formatCurrency(price)}` : '-');
                csvContent += `Avg. Sell Price (Net),${plan.summary.avgSellPrice}\r\n`;
                csvContent += `Lowest Buy Rung,${csvRungLabel(plan.summary.lowestBuyRung, plan.summary.lowestBuyPrice)}\r\n`;
                csvContent += `Highest Sell Rung,${csvRungLabel(plan.summary.highestSellRung, plan.summary.highestSellPrice)}\r\n`;
                csvContent += `Gross Profit,${plan.summary.grossProfit}\r\n`;
                csvContent += `Total Fees Paid,${plan.summary.totalFees}\r\n`;
                csvContent += `Total Vol,${plan.summary.totalQuantity}\r\n`;
                csvContent += `ROI on Cost Basis (%),${plan.summary.roi}\r\n`;
                csvContent += "\r\n";

                const csvShowFeeColumns = !!(plan.feeSettings && plan.feeSettings.enabled);
                const feeHeaderCsv = csvShowFeeColumns
                    ? (plan.feeSettings.type === 'percent' ? "Fee ($)" : "Fee (%)")
                    : '';
                const buyHeaderCsv = [
                    "Buy Rung",
                    "Buy Price",
                    "Buy Vol",
                    "Buy Alloc (%)",
                    "Buy Value",
                    ...(csvShowFeeColumns ? [`Buy ${feeHeaderCsv}`] : []),
                    "Buy Avg Buy Price"
                ];
                const sellHeaderCsv = [
                    "Sell Rung",
                    "Sell Price",
                    "Sell Vol",
                    "Sell Alloc (%)",
                    "Sell Value",
                    ...(csvShowFeeColumns ? [`Sell ${feeHeaderCsv}`] : []),
                    "Sell Avg Sell Price",
                    "Sell Net Profit"
                ];

                csvContent += `${buyHeaderCsv.join(",")},,${sellHeaderCsv.join(",")}\r\n`;

                const numRungs = Math.max(plan.buyLadder.length, plan.sellLadder.length);
                for (let i = 0; i < numRungs; i += 1) {
                    const buyRung = plan.buyLadder[i];
                    const sellRung = plan.sellLadder[i];

                    const buyRowValues = buyRung ? [
                        buyRung.rung,
                        buyRung.price,
                        buyRung.assetSize,
                        buyRung.allocation,
                        buyRung.capital,
                        ...(csvShowFeeColumns ? [
                            plan.feeSettings.type === 'percent'
                                ? buyRung.fee
                                : (buyRung.capital > 0 ? (buyRung.fee / buyRung.capital) * 100 : 0)
                        ] : []),
                        buyRung.progressiveAvgPrice
                    ] : [];
                    const sellRowValues = sellRung ? [
                        sellRung.rung,
                        sellRung.price,
                        sellRung.assetSize,
                        sellRung.allocation,
                        sellRung.capital,
                        ...(csvShowFeeColumns ? [
                            plan.feeSettings.type === 'percent'
                                ? sellRung.fee
                                : (sellRung.capital > 0 ? (sellRung.fee / sellRung.capital) * 100 : 0)
                        ] : []),
                        sellRung.progressiveAvgSellPrice,
                        sellRung.netProfit
                    ] : [];

                    const buyRow = buyRowValues.length > 0 ? buyRowValues.join(',') : Array(buyHeaderCsv.length).fill('').join(',');
                    const sellRow = sellRowValues.length > 0 ? sellRowValues.join(',') : Array(sellHeaderCsv.length).fill('').join(',');

                    csvContent += `${buyRow},,${sellRow}\r\n`;
                }

                return csvContent;
            };

            const buildXlsContent = (plan, settings) => {
                const showFeeColumns = !!(plan.feeSettings && plan.feeSettings.enabled);
                const feeHeaderLabel = showFeeColumns
                    ? (plan.feeSettings.type === 'percent' ? 'Fee ($)' : 'Fee (%)')
                    : '';

                const feeDisplay = (rung) => {
                    if (!showFeeColumns) {
                        return '';
                    }
                    if (plan.feeSettings.type === 'percent') {
                        return formatCurrency(rung.fee);
                    }
                    const pct = rung.capital > 0 ? (rung.fee / rung.capital) * 100 : 0;
                    return formatPercent(pct);
                };

                const settingsRows = [
                    ['Date', settings.date],
                    ['Initial Capital', settings.startingCapital],
                    ['Number of Rungs', settings.rungs],
                    ['Current Asset Price', settings.currentPrice],
                    ['Width (%)', settings.depth],
                    ['Allocation Skew', settings.skew],
                    ['Advanced Mode Enabled', settings.advancedMode ? 'Yes' : 'No'],
                    ['Sell-only Mode', settings.sellOnly ? 'Yes' : 'No'],
                    ['Equal Quantity Per Rung', settings.equalQuantity ? 'Yes' : 'No']
                ];
                if (settings.advancedMode) {
                    settingsRows.push(['Trading Fee Type', settings.feeType]);
                    settingsRows.push(['Fee Settlement Mode', settings.feeSettlement]);
                    settingsRows.push(['Trading Fee Value', settings.feeValue]);
                    settingsRows.push(['Spacing Mode', plan.spacing && plan.spacing.mode === 'relative' ? 'Relative (% per rung)' : 'Absolute']);
                }

                const rungLabel = (rung, price) => (rung ? `Rung ${rung} @ ${formatCurrency(price)}` : '-');

                const summaryRows = [
                    ['Avg. Buy Price', formatCurrency(plan.summary.avgBuyPrice)],
                    ['Avg. Sell Price (Net)', formatCurrency(plan.summary.avgSellPrice)],
                    ['Lowest Buy Rung', rungLabel(plan.summary.lowestBuyRung, plan.summary.lowestBuyPrice)],
                    ['Highest Sell Rung', rungLabel(plan.summary.highestSellRung, plan.summary.highestSellPrice)],
                    ['Gross Profit', formatCurrency(plan.summary.grossProfit)],
                    ['Total Fees Paid', formatCurrency(plan.summary.totalFees)],
                    ['Total Vol', formatNumber(plan.summary.totalQuantity, 4)],
                    ['ROI on Cost Basis', formatPercent(plan.summary.roi)]
                ];

                const buyHeader = [
                    '#',
                    'Price',
                    'Vol',
                    'Alloc',
                    'Value',
                    ...(showFeeColumns ? [feeHeaderLabel] : []),
                    'Avg Buy Price'
                ];
                const sellHeader = [
                    '#',
                    'Price',
                    'Vol',
                    'Alloc',
                    'Value',
                    ...(showFeeColumns ? [feeHeaderLabel] : []),
                    'Avg Sell Price',
                    'Profit'
                ];

                const buyRows = plan.buyLadder.map(rung => {
                    const cells = [
                        escapeForHtml(rung.rung),
                        escapeForHtml(formatCurrency(rung.price, 4)),
                        escapeForHtml(formatNumber(rung.assetSize)),
                        escapeForHtml(formatPercent(rung.allocation)),
                        escapeForHtml(formatCurrency(rung.capital, 4))
                    ];
                    if (showFeeColumns) {
                        cells.push(escapeForHtml(feeDisplay(rung)));
                    }
                    cells.push(escapeForHtml(formatCurrency(rung.progressiveAvgPrice, 4)));
                    return `<tr>${cells.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
                }).join('');

                const sellRows = plan.sellLadder.map(rung => {
                    const cells = [
                        escapeForHtml(rung.rung),
                        escapeForHtml(formatCurrency(rung.price, 4)),
                        escapeForHtml(formatNumber(rung.assetSize)),
                        escapeForHtml(formatPercent(rung.allocation)),
                        escapeForHtml(formatCurrency(rung.capital, 4))
                    ];
                    if (showFeeColumns) {
                        cells.push(escapeForHtml(feeDisplay(rung)));
                    }
                    cells.push(escapeForHtml(formatCurrency(rung.progressiveAvgSellPrice, 4)));
                    cells.push(escapeForHtml(formatCurrency(rung.netProfit, 4)));
                    return `<tr>${cells.map(cell => `<td>${cell}</td>`).join('')}</tr>`;
                }).join('');

                const settingsTable = settingsRows.map(([label, value]) => `<tr><th>${escapeForHtml(label)}</th><td>${escapeForHtml(value)}</td></tr>`).join('');
                const summaryTable = summaryRows.map(([label, value]) => `<tr><th>${escapeForHtml(label)}</th><td>${escapeForHtml(value)}</td></tr>`).join('');

                return `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<style>
body { font-family: Arial, sans-serif; color: #273f43; }
table { border-collapse: collapse; margin-bottom: 16px; width: 100%; }
th, td { border: 1px solid #93c5fd; padding: 6px 10px; text-align: left; }
th { background-color: #dbf6fa; }
caption { font-weight: 600; margin-bottom: 6px; }
</style>
</head>
<body>
<table>
<caption>Settings</caption>
<tbody>${settingsTable}</tbody>
</table>
<table>
<caption>Summary</caption>
<tbody>${summaryTable}</tbody>
</table>
<table>
<caption>Buy Ladder</caption>
<thead><tr>${buyHeader.map(h => `<th>${escapeForHtml(h)}</th>`).join('')}</tr></thead>
<tbody>${buyRows}</tbody>
</table>
<table>
<caption>Sell Ladder</caption>
<thead><tr>${sellHeader.map(h => `<th>${escapeForHtml(h)}</th>`).join('')}</tr></thead>
<tbody>${sellRows}</tbody>
</table>
</body>
</html>`;
            };
            const setSkewDisabled = (disabled) => {
                const skewControl = sliderControlInstances.get('skew_value');
                if (skewControl) {
                    skewControl.disable(disabled);
                    return;
                }
                if (skewSlider) {
                if (disabled) {
                    skewSlider.setAttribute('disabled', 'true');
                    skewSlider.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    skewSlider.removeAttribute('disabled');
                    skewSlider.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }
                if (skewNumericInput) {
                    if (disabled) {
                        skewNumericInput.setAttribute('disabled', 'true');
                        skewNumericInput.classList.add('cursor-not-allowed');
                    } else {
                        skewNumericInput.removeAttribute('disabled');
                        skewNumericInput.classList.remove('cursor-not-allowed');
                    }
                }
            };

            function setFieldValidity(fieldId, isValid, message = '') {
                const input = document.getElementById(fieldId);
                if (input) {
                    if (isValid) {
                        input.classList.remove('input-invalid');
                        input.removeAttribute('aria-invalid');
                    } else {
                        input.classList.add('input-invalid');
                        input.setAttribute('aria-invalid', 'true');
                    }
                }

                const label = document.querySelector(`label[for="${fieldId}"]`);
                if (!label) return;

                if (isValid) {
                    label.classList.remove('label-invalid', 'label-with-info');
                    const infoBtn = label.querySelector('.info-button');
                    if (infoBtn) {
                        infoBtn.remove();
                    }
                    return;
                }

                label.classList.add('label-invalid', 'label-with-info');

                let infoBtn = label.querySelector('.info-button');
                if (!infoBtn) {
                    infoBtn = document.createElement('button');
                    infoBtn.type = 'button';
                    infoBtn.className = 'info-button';
                    infoBtn.textContent = 'i';
                    label.appendChild(infoBtn);
                }

                if (message) {
                    infoBtn.setAttribute('title', message);
                    infoBtn.setAttribute('aria-label', message);
                } else {
                    infoBtn.removeAttribute('title');
                    infoBtn.setAttribute('aria-label', 'Additional information');
                }
            }

            function calculatePlan() {
                const finishCalculation = startTimer('calculatePlan', {
                    layout: currentLayoutMode,
                    theme: currentThemeMode
                });
                // 1. Get inputs
                const C = parseFloat(document.getElementById('starting_capital').value);
                const N = parseInt(document.getElementById('number_of_rungs').value);
                const S = parseInt(document.getElementById('skew_value').value);
                const currentPrice = parseFloat(document.getElementById('current_price').value);
                const depth = parseFloat(document.getElementById('depth').value);

                const advancedEnabled = advancedToggle ? advancedToggle.checked : false;
                const feeType = advancedEnabled && feeTypeSelect ? feeTypeSelect.value : 'percent';
                const feeSettlementRaw = advancedEnabled && feeSettlementSelect ? feeSettlementSelect.value : 'netted';
                const feeSettlement = feeSettlementRaw === 'external' ? 'external' : 'netted';
                const rawFeeValue = advancedEnabled && feeValueInput ? parseFloat(feeValueInput.value) : 0;
                const feeValue = Number.isFinite(rawFeeValue) ? Math.max(rawFeeValue, 0) : 0;
                const sellOnlyMode = advancedEnabled && sellOnlyCheckbox ? sellOnlyCheckbox.checked : false;
                const existingQuantityRaw = sellOnlyMode && existingQuantityInput ? parseFloat(existingQuantityInput.value) : 0;
                const existingAvgBuyPriceRaw = sellOnlyMode && existingAvgPriceInput ? parseFloat(existingAvgPriceInput.value) : 0;
                const existingQuantity = Number.isFinite(existingQuantityRaw) ? existingQuantityRaw : 0;
                const existingAvgBuyPrice = Number.isFinite(existingAvgBuyPriceRaw) ? existingAvgBuyPriceRaw : 0;
                const spacingMode = advancedEnabled && spacingModeSelect ? spacingModeSelect.value : 'absolute';
                const isRelativeSpacing = spacingMode === 'relative';
                const selectedHighestExecutedRung = sellOnlyMode ? sellOnlyState.highestExecutedRung : null;
                const equalQuantityRequested = advancedEnabled && equalQuantityCheckbox ? equalQuantityCheckbox.checked : false;

                trackEvent('calculation', 'calculate:inputs', {
                    capital: safeNumericSummary(C, 2),
                    rungs: Number.isFinite(N) ? N : null,
                    skew: Number.isFinite(S) ? S : null,
                    currentPrice: safeNumericSummary(currentPrice, 4),
                    depthPercent: safeNumericSummary(depth, 4),
                    advancedEnabled,
                    feeType,
                    feeSettlement,
                    feeValue: safeNumericSummary(feeValue, 6),
                    sellOnlyMode,
                    spacingMode,
                    equalQuantityRequested,
                    selectedHighestExecutedRung
                });

                const validations = [
                    {
                        id: 'starting_capital',
                        enabled: !sellOnlyMode,
                        isValid: Number.isFinite(C) && C > 0,
                        message: 'Enter initial capital greater than zero.'
                    },
                    {
                        id: 'number_of_rungs',
                        enabled: true,
                        isValid: Number.isFinite(N) && N >= 2,
                        message: 'Rungs must be at least 2.'
                    },
                    {
                        id: 'skew_value',
                        enabled: true,
                        isValid: Number.isFinite(S) && S >= 0 && S <= 100,
                        message: 'Allocation skew must be between 0 and 100.'
                    },
                    {
                        id: 'current_price',
                        enabled: true,
                        isValid: Number.isFinite(currentPrice) && currentPrice > 0,
                        message: 'Enter a current asset price greater than zero.'
                    },
                    {
                        id: 'depth',
                        enabled: true,
                        isValid: Number.isFinite(depth) && depth > 0,
                        message: 'Width must be greater than zero.'
                    },
                    {
                        id: 'fee_value',
                        enabled: advancedEnabled && !!feeValueInput,
                        isValid: Number.isFinite(feeValue) && feeValue >= 0,
                        message: 'Trading fee must be zero or greater.'
                    },
                    {
                        id: 'existing_quantity',
                        enabled: sellOnlyMode && !(Number.isFinite(selectedHighestExecutedRung) && selectedHighestExecutedRung !== null),
                        isValid: Number.isFinite(existingQuantity) && existingQuantity >= 0,
                        message: 'Provide the quantity you already hold or select executed rungs.'
                    },
                    {
                        id: 'existing_avg_price',
                        enabled: sellOnlyMode && !(Number.isFinite(selectedHighestExecutedRung) && selectedHighestExecutedRung !== null),
                        isValid: Number.isFinite(existingAvgBuyPrice) && existingAvgBuyPrice >= 0,
                        message: 'Provide the known average buy price for held assets or select executed rungs.'
                    }
                ];

                let hasInvalidInput = false;
                validations.forEach(({ id, enabled, isValid, message }) => {
                    if (!enabled) {
                        setFieldValidity(id, true);
                        return;
                    }
                    if (!isValid) {
                        setFieldValidity(id, false, message);
                        hasInvalidInput = true;
                    } else {
                        setFieldValidity(id, true);
                    }
                });

                if (hasInvalidInput) {
                    const invalidFields = validations
                        .filter(({ enabled, isValid }) => enabled && !isValid)
                        .map(({ id }) => id);
                    trackEvent('calculation', 'calculate:invalid', {
                        invalidFields
                    }, 'warn');
                    renderPlanAlerts([]);
                    finishCalculation({
                        status: 'invalid-input',
                        invalidFields
                    });
                    currentPlanData = null;
                    pendingChartData = null;
                    return;
                }

                const feeEnabled = feeValue > 0 && advancedEnabled;
                const feeRate = feeType === 'percent' ? feeValue / 100 : 0;
                const isFeeNetted = feeSettlement !== 'external';
                const useEqualQuantity = equalQuantityRequested;

                const deriveBuyAmounts = (allocatedCapital) => {
                    if (!feeEnabled) {
                        return { net: allocatedCapital, fee: 0, gross: allocatedCapital };
                    }
                    if (isFeeNetted) {
                        if (feeType === 'percent') {
                            const net = allocatedCapital / (1 + feeRate);
                            const fee = Math.max(allocatedCapital - net, 0);
                            return { net, fee, gross: allocatedCapital };
                        }
                        const fee = Math.min(feeValue, allocatedCapital);
                        const net = Math.max(allocatedCapital - fee, 0);
                        return { net, fee, gross: net + fee };
                    }
                    if (feeType === 'percent') {
                        const net = allocatedCapital;
                        const fee = net * feeRate;
                        return { net, fee, gross: net };
                    }
                    const net = allocatedCapital;
                    const fee = net > 0 ? feeValue : 0;
                    return { net, fee, gross: net };
                };

                const deriveSellAmounts = (grossRevenue) => {
                    if (!feeEnabled) {
                        return { net: grossRevenue, fee: 0 };
                    }
                    const rawFee = feeType === 'percent'
                        ? grossRevenue * feeRate
                        : (grossRevenue > 0 ? feeValue : 0);
                    const fee = isFeeNetted ? Math.min(rawFee, grossRevenue) : rawFee;
                    const net = isFeeNetted ? Math.max(grossRevenue - fee, 0) : grossRevenue;
                    return { net, fee };
                };

                // 2. Calculate Skew Weights
                let rawWeights = Array(N).fill(1);
                if (!useEqualQuantity && N > 0) {
                    rawWeights = buildSkewWeights(N, S);
                }
                const totalWeight = rawWeights.reduce((sum, w) => sum + w, 0) || 0;

                // 3. Calculate Price Points
                const depthVal = depth / 100;
                const buyPriceEnd = currentPrice * (1 - depthVal);
                const sellPriceEnd = currentPrice * (1 + depthVal);
                const buyRange = currentPrice - buyPriceEnd;
                const sellRange = sellPriceEnd - currentPrice;
                const buyPriceStep = (!isRelativeSpacing && N > 0) ? buyRange / N : 0;
                const sellPriceStep = (!isRelativeSpacing && N > 0) ? sellRange / N : 0;
                const buyPriceRatio = (isRelativeSpacing && N > 0) ? Math.pow(Math.max(1 - depthVal, 0), 1 / N) : 1;
                const sellPriceRatio = (isRelativeSpacing && N > 0) ? Math.pow(1 + depthVal, 1 / N) : 1;
                const buyPrices = Array.from({ length: N }, (_, i) => {
                    if (isRelativeSpacing) {
                        return currentPrice * Math.pow(buyPriceRatio, i + 1);
                    }
                    return currentPrice - ((i + 1) * buyPriceStep);
                });
                const sellPrices = Array.from({ length: N }, (_, i) => {
                    if (isRelativeSpacing) {
                        return currentPrice * Math.pow(sellPriceRatio, i + 1);
                    }
                    return currentPrice + ((i + 1) * sellPriceStep);
                });

                // 4. Calculate Buy Ladder
                let buyLadder = [];
                let totalAssetBought = 0;
                let totalNetCapitalSpent = 0;
                let totalBuyFees = 0;

                const canReuseBuySnapshot = sellOnlyMode
                    && baselineBuySnapshot
                    && Array.isArray(baselineBuySnapshot.buyLadder)
                    && baselineBuySnapshot.buyLadder.length > 0;

                if (canReuseBuySnapshot) {
                    buyLadder = cloneBuyLadder(baselineBuySnapshot.buyLadder);
                    totalAssetBought = baselineBuySnapshot.totalAssetBought;
                    totalNetCapitalSpent = baselineBuySnapshot.totalNetCapitalSpent;
                    totalBuyFees = baselineBuySnapshot.totalBuyFees;
                } else {
                    if (useEqualQuantity) {
                        const activeBuyEntries = buyPrices
                            .map((price, idx) => ({ price, idx }))
                            .filter(entry => entry.price > 0);
                        const activeCount = activeBuyEntries.length;
                        const activeIndexSet = new Set(activeBuyEntries.map(entry => entry.idx));
                        const totalPriceSum = activeBuyEntries.reduce((sum, entry) => sum + entry.price, 0);
                        let sharedQuantity = 0;
                        if (activeCount > 0 && Number.isFinite(C) && C > 0 && totalPriceSum > 0) {
                            if (!feeEnabled || !isFeeNetted) {
                                sharedQuantity = C / totalPriceSum;
                            } else if (feeType === 'percent') {
                                const denominator = totalPriceSum * (1 + feeRate);
                                sharedQuantity = denominator > 0 ? C / denominator : 0;
                            } else {
                                const effectiveBudget = C - (activeCount * feeValue);
                                sharedQuantity = effectiveBudget > 0 ? effectiveBudget / totalPriceSum : 0;
                            }
                        }
                        sharedQuantity = Math.max(sharedQuantity, 0);

                        buyLadder = buyPrices.map((price, i) => {
                            const hasVolume = sharedQuantity > 0 && activeIndexSet.has(i);
                            const assetSize = hasVolume ? sharedQuantity : 0;
                            const netCapital = assetSize * price;
                            let fee = 0;
                            if (assetSize > 0 && feeEnabled) {
                                if (feeType === 'percent') {
                                    fee = netCapital * feeRate;
                                } else {
                                    fee = feeValue;
                                }
                            }
                            if (assetSize === 0) {
                                fee = 0;
                            }
                            const grossAllocation = isFeeNetted ? netCapital + fee : netCapital;
                            totalAssetBought += assetSize;
                            totalNetCapitalSpent += netCapital;
                            totalBuyFees += fee;
                            return {
                                rung: i + 1,
                                price,
                                capital: grossAllocation,
                                netCapital,
                                allocation: 0,
                                assetSize,
                                fee
                            };
                        });
                    } else {
                        const capitalAllocations = (C > 0 && totalWeight > 0)
                            ? rawWeights.map(w => (C * w) / totalWeight)
                            : Array(N).fill(0);
                        buyLadder = capitalAllocations.map((allocation, i) => {
                            const price = buyPrices[i];
                            const { net: netCapital, fee, gross } = deriveBuyAmounts(allocation);
                            const assetSize = price > 0 && netCapital > 0 ? netCapital / price : 0;
                            totalAssetBought += assetSize;
                            totalNetCapitalSpent += netCapital;
                            totalBuyFees += fee;
                            return {
                                rung: i + 1,
                                price,
                                capital: gross,
                                netCapital,
                                allocation: 0,
                                assetSize,
                                fee
                            };
                        });
                    }
                }

                let cumulativeNetCapital = 0;
                let cumulativeAsset = 0;
                const totalAssetForAllocation = totalAssetBought;
                buyLadder = buyLadder.map(rung => {
                    cumulativeNetCapital += rung.netCapital;
                    cumulativeAsset += rung.assetSize;
                    const progressiveAvgPrice = cumulativeAsset > 0 ? (cumulativeNetCapital / cumulativeAsset) : 0;
                    return {
                        ...rung,
                        allocation: totalAssetForAllocation > 0 ? (rung.assetSize / totalAssetForAllocation) * 100 : 0,
                        progressiveAvgPrice
                    };
                });

                let effectiveAssetBought = totalAssetBought;
                let effectiveNetCapitalSpent = totalNetCapitalSpent;
                let effectiveBuyFees = totalBuyFees;

                let derivedTotals = null;
                if (sellOnlyMode) {
                    // Check if user has manually provided existing quantity and avg buy price
                    const hasManualInputs = existingQuantity > 0 && existingAvgBuyPrice > 0;
                    
                    if (Number.isFinite(selectedHighestExecutedRung) && selectedHighestExecutedRung !== null) {
                        derivedTotals = deriveExecutedBuyTotals(buyLadder, selectedHighestExecutedRung);
                        if (derivedTotals.quantity > 0 && derivedTotals.avgPrice > 0) {
                            effectiveAssetBought = derivedTotals.quantity;
                            effectiveNetCapitalSpent = derivedTotals.netCapital;
                            effectiveBuyFees = derivedTotals.fees;
                            // Don't prefill inputs - user should enter values manually
                        } else {
                            derivedTotals = null;
                        }
                    }

                    // Only use snapshot if user hasn't provided manual inputs AND snapshot values are reasonable
                    // Don't use snapshot if it would result in invalid calculations (e.g., avg price way off from current price)
                    if (!derivedTotals && canReuseBuySnapshot && !hasManualInputs) {
                        const snapshotQuantity = baselineBuySnapshot.totalAssetBought;
                        const snapshotNetCapital = baselineBuySnapshot.totalNetCapitalSpent;
                        const snapshotFees = baselineBuySnapshot.totalBuyFees;
                        const snapshotAvgPrice = snapshotQuantity > 0
                            ? snapshotNetCapital / snapshotQuantity
                            : 0;
                        // Validate snapshot: avg price should be within reasonable range of current price (e.g., within 10x)
                        // This prevents using stale snapshots from completely different scenarios
                        const priceRatio = currentPrice > 0 && snapshotAvgPrice > 0 
                            ? Math.max(snapshotAvgPrice / currentPrice, currentPrice / snapshotAvgPrice)
                            : Infinity;
                        const isSnapshotValid = snapshotQuantity > 0 && snapshotAvgPrice > 0 && priceRatio <= 10;
                        
                        if (isSnapshotValid) {
                            derivedTotals = {
                                quantity: snapshotQuantity,
                                netCapital: snapshotNetCapital,
                                fees: snapshotFees,
                                avgPrice: snapshotAvgPrice
                            };
                            effectiveAssetBought = snapshotQuantity;
                            effectiveNetCapitalSpent = snapshotNetCapital;
                            effectiveBuyFees = snapshotFees;
                            // Don't prefill inputs - user should enter values manually
                        }
                    }

                    // Use manual inputs if available and no other source
                    if (!derivedTotals) {
                        effectiveAssetBought = existingQuantity > 0 ? existingQuantity : 0;
                        effectiveNetCapitalSpent = existingQuantity > 0 && existingAvgBuyPrice > 0
                            ? existingQuantity * existingAvgBuyPrice
                            : 0;
                        effectiveBuyFees = 0;
                    }
                }

                const avgBuyPrice = effectiveAssetBought > 0
                    ? (sellOnlyMode ? (effectiveNetCapitalSpent / effectiveAssetBought) : (totalNetCapitalSpent / totalAssetBought))
                    : 0;

                // 5. Determine quantities available for sells
                let totalQuantityForSell = 0;
                let assetAllocations = [];

                if (sellOnlyMode) {
                    // In sell-only mode, only calculate if we have valid asset quantity and avg buy price
                    if (effectiveAssetBought > 0 && avgBuyPrice > 0) {
                        totalQuantityForSell = effectiveAssetBought;
                        if (useEqualQuantity) {
                            const equalDistribution = computeEqualGrossAllocations(totalQuantityForSell, sellPrices);
                            assetAllocations = equalDistribution.allocations;
                        } else {
                            assetAllocations = (totalWeight > 0 && totalQuantityForSell > 0)
                                ? rawWeights.map(w => (totalQuantityForSell * w) / totalWeight)
                                : Array(N).fill(0);
                        }
                    } else {
                        // No valid quantity/price in sell-only mode - set everything to zero
                        assetAllocations = Array(N).fill(0);
                        totalQuantityForSell = 0;
                    }
                } else {
                    assetAllocations = buyLadder.map(rung => rung.assetSize);
                    totalQuantityForSell = assetAllocations.reduce((sum, size) => sum + size, 0);
                    if (useEqualQuantity) {
                        const equalDistribution = computeEqualGrossAllocations(totalQuantityForSell, sellPrices);
                        assetAllocations = equalDistribution.allocations;
                    }
                }

                totalQuantityForSell = assetAllocations.reduce((sum, size) => sum + size, 0);

                let totalRevenueGross = 0;
                let totalRevenueNet = 0;
                let totalSellFees = 0;
                let totalGrossProfit = 0;

                let sellLadder = assetAllocations.map((assetSize, i) => {
                    const price = sellPrices[i];
                    const grossRevenue = assetSize * price;
                    const { net: netRevenue, fee: sellFee } = deriveSellAmounts(grossRevenue);
                    // Only calculate profit if we have valid avg buy price
                    const costBasis = (avgBuyPrice > 0 && assetSize > 0) ? (assetSize * avgBuyPrice) : 0;
                    const grossProfit = grossRevenue - costBasis;
                    const netProfit = netRevenue - costBasis;

                    totalRevenueGross += grossRevenue;
                    totalRevenueNet += netRevenue;
                    totalSellFees += sellFee;
                    totalGrossProfit += grossProfit;

                    return {
                        rung: i + 1,
                        price,
                        assetSize,
                        capital: grossRevenue,
                        allocation: 0,
                        fee: sellFee,
                        netRevenue,
                        grossProfit,
                        netProfit
                    };
                });

                sellLadder.forEach(rung => {
                    rung.allocation = totalQuantityForSell > 0 ? (rung.assetSize / totalQuantityForSell) * 100 : 0;
                });

                let cumulativeNetRevenue = 0;
                let cumulativeAssetSold = 0;
                sellLadder = sellLadder.map(rung => {
                    cumulativeNetRevenue += rung.netRevenue;
                    cumulativeAssetSold += rung.assetSize;
                    const progressiveAvgSellPrice = cumulativeAssetSold > 0 ? (cumulativeNetRevenue / cumulativeAssetSold) : 0;
                    return {
                        ...rung,
                        progressiveAvgSellPrice
                    };
                });

                const avgSellPrice = totalQuantityForSell > 0 ? (totalRevenueNet / totalQuantityForSell) : 0;
                const totalFees = (sellOnlyMode ? effectiveBuyFees : totalBuyFees) + totalSellFees;
                const costBasis = sellOnlyMode ? effectiveNetCapitalSpent : totalNetCapitalSpent + totalBuyFees;
                const netProfitAfterFees = totalRevenueNet - costBasis - (isFeeNetted ? 0 : totalSellFees);
                const roi = costBasis > 0 ? (netProfitAfterFees / costBasis) * 100 : 0;

                const planWarnings = [];
                if (!sellOnlyMode && Number.isFinite(C)) {
                    const grossBuyRequirement = totalNetCapitalSpent + (isFeeNetted ? totalBuyFees : 0);
                    if (grossBuyRequirement - C > 0.0001) {
                        planWarnings.push(`Buy ladder requires ${formatCurrency(grossBuyRequirement)} but available capital is ${formatCurrency(C)}.`);
                    }
                }
                const holdingsForComparison = sellOnlyMode ? effectiveAssetBought : totalAssetBought;
                if (holdingsForComparison > 0 && (totalQuantityForSell - holdingsForComparison) > 1e-6) {
                    planWarnings.push(`Sell ladder allocates ${formatNumber(totalQuantityForSell, 4)} units while only ${formatNumber(holdingsForComparison, 4)} are available.`);
                }
                renderPlanAlerts(planWarnings);

                // In sell-only mode, buy floor should use known avg buy price, not from stale buy ladder
                const lowestBuyActive = sellOnlyMode 
                    ? (avgBuyPrice > 0 ? { price: avgBuyPrice, rung: null } : null)
                    : buyLadder.reduce((acc, rung) => {
                        if (rung.assetSize <= 0) {
                            return acc;
                        }
                        if (!acc || rung.price < acc.price) {
                            return rung;
                        }
                        return acc;
                    }, null);

                const highestSellActive = sellLadder.reduce((acc, rung) => {
                    if (rung.assetSize <= 0) {
                        return acc;
                    }
                    if (!acc || rung.price > acc.price) {
                        return rung;
                    }
                    return acc;
                }, null);

                const plan = {
                    summary: {
                        avgBuyPrice,
                        avgSellPrice,
                        grossProfit: totalGrossProfit,
                        netProfit: netProfitAfterFees,
                        totalFees,
                        totalQuantity: totalQuantityForSell,
                        roi,
                        costBasis,
                        totalRevenueGross,
                        totalRevenueNet,
                        totalBuyFees: sellOnlyMode ? effectiveBuyFees : totalBuyFees,
                        totalSellFees,
                        lowestBuyPrice: lowestBuyActive ? lowestBuyActive.price : 0,
                        lowestBuyRung: lowestBuyActive ? lowestBuyActive.rung : null,
                        highestSellPrice: highestSellActive ? highestSellActive.price : 0,
                        highestSellRung: highestSellActive ? highestSellActive.rung : null
                    },
                    buyLadder,
                    sellLadder,
                    modes: {
                        advancedEnabled,
                        sellOnly: sellOnlyMode,
                        equalQuantity: useEqualQuantity
                    },
                    selection: {
                        highestExecutedBuyRung: sellOnlyMode && Number.isFinite(selectedHighestExecutedRung)
                            ? selectedHighestExecutedRung
                            : null,
                        derivedTotals: sellOnlyMode && derivedTotals ? derivedTotals : null
                    },
                    feeSettings: {
                        enabled: feeEnabled,
                        type: feeType,
                        value: feeValue,
                        settlement: feeSettlement
                    },
                    spacing: {
                        mode: spacingMode
                    }
                };

                if (!sellOnlyMode && buyLadder.length > 0) {
                    baselineBuySnapshot = {
                        buyLadder: cloneBuyLadder(buyLadder),
                        totalAssetBought,
                        totalNetCapitalSpent,
                        totalBuyFees
                    };
                }

                const summarySnapshot = {
                    avgBuyPrice: safeNumericSummary(plan.summary.avgBuyPrice, 6),
                    avgSellPrice: safeNumericSummary(plan.summary.avgSellPrice, 6),
                    totalQuantity: safeNumericSummary(plan.summary.totalQuantity, 6),
                    totalFees: safeNumericSummary(plan.summary.totalFees, 4),
                    grossProfit: safeNumericSummary(plan.summary.grossProfit, 4),
                    netProfit: safeNumericSummary(plan.summary.netProfit, 4),
                    roi: safeNumericSummary(plan.summary.roi, 4)
                };

                trackEvent('calculation', 'plan:prepared', {
                    summary: summarySnapshot,
                    buyRungs: Array.isArray(plan.buyLadder) ? plan.buyLadder.length : 0,
                    sellRungs: Array.isArray(plan.sellLadder) ? plan.sellLadder.length : 0,
                    modes: plan.modes,
                    feeSettings: plan.feeSettings,
                    spacing: plan.spacing
                });

                let uiError = null;
                try {
                    updateUI(plan);
                } catch (error) {
                    uiError = error;
                    console.error('[UI] Update error', error);
                    throw error;
                } finally {
                    finishCalculation({
                        status: uiError ? 'ui-error' : 'success',
                        summary: summarySnapshot,
                        sellOnly: plan.modes.sellOnly,
                        equalQuantity: plan.modes.equalQuantity,
                        error: uiError || null
                    });
                }
            }

            function updateUI(plan) {
                const finishUiUpdate = startTimer('ui:update', {
                    layout: currentLayoutMode,
                    theme: currentThemeMode
                });
                trackEvent('ui', 'update:start', {
                    buyRungs: Array.isArray(plan?.buyLadder) ? plan.buyLadder.length : 0,
                    sellRungs: Array.isArray(plan?.sellLadder) ? plan.sellLadder.length : 0,
                    sellOnly: !!(plan?.modes && plan.modes.sellOnly)
                });

                // Store data for CSV export
                currentPlanData = plan;

                const summary = plan.summary;
                const showFeeColumns = !!(plan.feeSettings && plan.feeSettings.enabled);

                const feeHeaderLabel = showFeeColumns
                    ? (plan.feeSettings.type === 'percent' ? 'Fee ($)' : 'Fee (%)')
                    : '';

                const showExecutionCheckboxes = plan.modes && plan.modes.sellOnly;

                if (buyHeaderRow) {
                    const buyHeaders = [
                        ...(showExecutionCheckboxes ? ['Executed'] : []),
                        '#',
                        'Price',
                        'Vol',
                        'Alloc',
                        'Value',
                        ...(showFeeColumns ? [feeHeaderLabel] : []),
                        'Avg Buy Price'
                    ];
                    buyHeaderRow.innerHTML = buyHeaders.map((label, idx) => {
                        const classes = ['px-2', 'py-2'];
                        if (showExecutionCheckboxes) {
                            if (idx === 0) {
                                classes.push('w-16', 'text-center', 'rounded-l-lg');
                            } else if (idx === 1) {
                                classes.push('w-12', 'text-center');
                            }
                        } else if (idx === 0) {
                            classes.push('w-12', 'text-center', 'rounded-l-lg');
                        }
                        if (idx === buyHeaders.length - 1) {
                            classes.push('rounded-r-lg');
                        }
                        return `<th scope="col" class="${classes.join(' ')}">${label}</th>`;
                    }).join('');
                }

                if (sellHeaderRow) {
                    const sellHeaders = [
                        '#',
                        'Price',
                        'Vol',
                        'Alloc',
                        'Value',
                        ...(showFeeColumns ? [feeHeaderLabel] : []),
                        'Avg Sell Price',
                        'Profit'
                    ];
                    sellHeaderRow.innerHTML = sellHeaders.map((label, idx) => {
                        const classes = [
                            'px-2',
                            'py-2',
                            idx === 0 ? 'w-12 text-center' : '',
                            idx === 0 ? 'rounded-l-lg' : '',
                            idx === sellHeaders.length - 1 ? 'rounded-r-lg' : ''
                        ].filter(Boolean).join(' ');
                        return `<th scope="col" class="${classes}">${label}</th>`;
                    }).join('');
                }

                document.getElementById('summary-avg-buy').textContent = formatCurrencySignificant(summary.avgBuyPrice);
                document.getElementById('summary-avg-sell').textContent = formatCurrencySignificant(summary.avgSellPrice);
                document.getElementById('summary-net-profit').textContent = formatCurrencySignificant(summary.netProfit);
                document.getElementById('summary-total-fees').textContent = formatCurrencySignificant(summary.totalFees);
                const initialCapital = parseFloat(document.getElementById('starting_capital')?.value || 0);
                const feesPercent = initialCapital > 0 ? (summary.totalFees / initialCapital) * 100 : 0;
                const feesPercentElement = document.getElementById('summary-total-fees-percent');
                if (feesPercentElement) {
                    feesPercentElement.textContent = Number.isFinite(feesPercent) ? `${formatPercent(feesPercent)} of initial capital` : '-';
                }
                document.getElementById('summary-total-quantity').textContent = formatSignificant(summary.totalQuantity);
                document.getElementById('summary-roi').textContent = formatPercent(summary.roi);
                const formatSummaryPrice = price => (price ? formatCurrencySignificant(price) : '-');
                document.getElementById('summary-buy-floor').textContent = formatSummaryPrice(summary.lowestBuyPrice);
                document.getElementById('summary-sell-ceiling').textContent = formatSummaryPrice(summary.highestSellPrice);

                // Toggle visibility for buy components in sell-only mode
                if (buyChartCard && buyOrdersCard) {
                    if (plan.modes && plan.modes.sellOnly) {
                        buyChartCard.classList.add('hidden');
                        buyOrdersCard.classList.add('hidden');
                    } else {
                        buyChartCard.classList.remove('hidden');
                        buyOrdersCard.classList.remove('hidden');
                    }
                }

                // Update tables
                const buyBody = document.getElementById('buy-ladder-body');
                const sellBody = document.getElementById('sell-ladder-body');
                buyBody.innerHTML = '';
                sellBody.innerHTML = '';

                const highestExecuted = plan.selection && Number.isFinite(plan.selection.highestExecutedBuyRung)
                    ? plan.selection.highestExecutedBuyRung
                    : null;

                plan.buyLadder.forEach((rung, i) => {
                    const rowClass = i % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                    const cellMarkup = [];
                    if (showExecutionCheckboxes) {
                        const checkbox = `
                            <input type="checkbox"
                                   class="form-checkbox buy-rung-executed h-4 w-4 text-primary-dark rounded focus:ring-0"
                                   data-rung="${escapeForHtml(rung.rung)}">
                        `;
                        cellMarkup.push(buildTableCell('Executed', checkbox, ['text-center']));
                    }
                    cellMarkup.push(buildTableCell('Rung', `<span class="font-medium">${escapeForHtml(rung.rung)}</span>`, ['font-medium', 'text-center']));
                    cellMarkup.push(buildTableCell('Price', formatCurrency(rung.price, 4), ['text-right', 'whitespace-nowrap']));
                    cellMarkup.push(buildTableCell('Volume', formatNumber(rung.assetSize), ['text-right']));
                    cellMarkup.push(buildTableCell('Allocation', formatPercent(rung.allocation), ['text-right']));
                    cellMarkup.push(buildTableCell('Value', formatCurrency(rung.capital, 4), ['text-right', 'whitespace-nowrap']));
                    if (showFeeColumns) {
                        const feeCellValue = plan.feeSettings.type === 'percent'
                            ? formatCurrency(rung.fee)
                            : formatPercent(rung.capital > 0 ? (rung.fee / rung.capital) * 100 : 0);
                        cellMarkup.push(buildTableCell(feeHeaderLabel, feeCellValue, ['text-right', 'whitespace-nowrap']));
                    }
                    cellMarkup.push(buildTableCell('Avg Buy Price', formatCurrency(rung.progressiveAvgPrice, 4), ['text-right', 'whitespace-nowrap']));
                    const executedClass = Number.isFinite(highestExecuted) && highestExecuted !== null && rung.rung <= highestExecuted
                        ? ' executed-rung'
                        : '';
                    buyBody.innerHTML += `<tr class="${rowClass}${executedClass}">${cellMarkup.join('')}</tr>`;
                });

                plan.sellLadder.forEach((rung, i) => {
                    const rowClass = i % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                    const cellMarkup = [];
                    cellMarkup.push(buildTableCell('Rung', `<span class="font-medium">${escapeForHtml(rung.rung)}</span>`, ['font-medium', 'text-center']));
                    cellMarkup.push(buildTableCell('Price', formatCurrency(rung.price, 4), ['text-right', 'whitespace-nowrap']));
                    cellMarkup.push(buildTableCell('Volume', formatNumber(rung.assetSize), ['text-right']));
                    cellMarkup.push(buildTableCell('Allocation', formatPercent(rung.allocation), ['text-right']));
                    cellMarkup.push(buildTableCell('Value', formatCurrency(rung.capital, 4), ['text-right', 'whitespace-nowrap']));
                    if (showFeeColumns) {
                        const feeCellValue = plan.feeSettings.type === 'percent'
                            ? formatCurrency(rung.fee)
                            : formatPercent(rung.capital > 0 ? (rung.fee / rung.capital) * 100 : 0);
                        cellMarkup.push(buildTableCell(feeHeaderLabel, feeCellValue, ['text-right', 'whitespace-nowrap']));
                    }
                    cellMarkup.push(buildTableCell('Avg Sell Price', formatCurrency(rung.progressiveAvgSellPrice, 4), ['text-right', 'whitespace-nowrap']));
                    cellMarkup.push(buildTableCell('Net Profit', formatCurrency(rung.netProfit, 4), ['text-right', 'whitespace-nowrap']));
                    sellBody.innerHTML += `<tr class="${rowClass}">${cellMarkup.join('')}</tr>`;
                });

                const buyRowCount = Array.isArray(plan.buyLadder) ? plan.buyLadder.length : 0;
                const sellRowCount = Array.isArray(plan.sellLadder) ? plan.sellLadder.length : 0;

                trackEvent('ui', 'tables:rendered', {
                    buyRows: buyRowCount,
                    sellRows: sellRowCount,
                    showFeeColumns,
                    sellOnly: !!(plan.modes && plan.modes.sellOnly)
                });

                if (showExecutionCheckboxes) {
                    bindSellOnlyCheckboxEvents();
                } else {
                    sellOnlyState.checkboxElements = [];
                }

                // Draw charts (lazy rendering support)
                const combinedVolumes = [...plan.buyLadder, ...plan.sellLadder]
                    .map(rung => (typeof rung?.assetSize === 'number' ? rung.assetSize : 0));
                const sharedMaxVolume = combinedVolumes.length > 0 ? Math.max(...combinedVolumes) : 1;

                if (!chartsLazySupported) {
                    if (plan.buyLadder.length > 0 && !(plan.modes && plan.modes.sellOnly)) {
                        drawBuyChart(plan.buyLadder, sharedMaxVolume);
                    } else {
                        d3.select("#allocation-chart").selectAll("*").remove();
                    }
                    if (plan.sellLadder.length > 0) {
                        drawSellChart(plan.sellLadder, sharedMaxVolume);
                    } else {
                        d3.select("#sell-allocation-chart").selectAll("*").remove();
                    }
                } else {
                    pendingChartData = {
                        buy: (plan.buyLadder.length > 0 && !(plan.modes && plan.modes.sellOnly)) ? plan.buyLadder : null,
                        sell: plan.sellLadder.length > 0 ? plan.sellLadder : null,
                        sharedMaxVolume
                    };
                    if (!pendingChartData.buy) {
                        d3.select("#allocation-chart").selectAll("*").remove();
                    }
                    if (!pendingChartData.sell) {
                        d3.select("#sell-allocation-chart").selectAll("*").remove();
                    }
                    triggerChartRender();
                }
                trackEvent('chart', 'render:requested', {
                    buyChartEnabled: plan.buyLadder.length > 0 && !(plan.modes && plan.modes.sellOnly),
                    sellChartEnabled: plan.sellLadder.length > 0,
                    sharedMaxVolume: safeNumericSummary(sharedMaxVolume, 4)
                });

                finishUiUpdate({
                    buyRows: buyRowCount,
                    sellRows: sellRowCount,
                    showFeeColumns,
                    sellOnly: !!(plan.modes && plan.modes.sellOnly),
                    sharedMaxVolume: safeNumericSummary(sharedMaxVolume, 4)
                });
            }
            
            function drawBuyChart(data, sharedMaxVolume) {
                const container = d3.select("#visualization");
                if (container.node() === null) {
                    trackEvent('chart', 'buy:container-missing', {}, 'warn');
                    return;
                }

                d3.select("#allocation-chart").selectAll("*").remove();
                if (!data || data.length === 0) {
                    trackEvent('chart', 'buy:empty', {
                        sharedMaxVolume: safeNumericSummary(sharedMaxVolume, 4)
                    }, 'warn');
                    return;
                }

                const margin = { top: 20, right: 80, bottom: 70, left: 80 }; // Balanced margins for symmetry
                let width;
                try {
                    width = container.node().getBoundingClientRect().width - margin.left - margin.right;
                } catch (e) {
                    console.error("Could not get container width:", e);
                    width = 500 - margin.left - margin.right; // Fallback width
                }
                width = Math.max(width, 100); // Ensure width is positive
                const height = 300 - margin.top - margin.bottom;

                const svg = d3.select("#allocation-chart")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const sortedData = [...data].sort((a, b) => a.price - b.price);

                const x = d3.scaleBand()
                    .range([0, width])
                    .domain(sortedData.map(d => d.price)) // X-axis is now price
                    .padding(0.2);

                const axisTextColor = getCssVariable('--color-chart-axis-text', '#2f3b58');

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => formatCurrency(parseFloat(d))))
                    .selectAll("text")
                        .style("text-anchor", "end")
                        .attr("dx", "-.8em")
                        .attr("dy", ".15em")
                        .attr("transform", "rotate(-45)"); // Rotate labels
                
                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom - 10) // Adjusted y
                    .text("Buy Price")
                    .style("fill", axisTextColor)
                    .style("font-size", "12px");

                const localMax = d3.max(data, d => d.assetSize);
                const yMax = sharedMaxVolume && sharedMaxVolume > 0 ? sharedMaxVolume : (localMax > 0 ? localMax : 1);
                const y = d3.scaleLinear()
                    .domain([0, yMax > 0 ? yMax : 1]) 
                    .range([height, 0]);

                svg.append("g")
                    .attr("transform", `translate(${width},0)`)
                    .call(d3.axisRight(y).ticks(5).tickFormat(d => formatNumber(d, 2)));

                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("transform", `translate(${width + 40}, ${height / 2}) rotate(90)`)
                    .text("Vol")
                    .style("fill", axisTextColor)
                    .style("font-size", "12px");

                const tooltip = d3.select("#tooltip");

                svg.selectAll(".buy-bar")
                    .data(sortedData)
                    .enter()
                    .append("rect")
                    .attr("class", "buy-bar")
                    .attr("x", d => x(d.price)) // Use price for x
                    .attr("width", x.bandwidth())
                    .attr("y", d => y(0))
                    .attr("height", d => height - y(0))
                    .on("mouseover", function(event, d) {
                        tooltip.style("opacity", 1);
                        d3.select(this).style("opacity", 0.7);
                    })
                    .on("mousemove", function(event, d) {
                        tooltip.html(`Rung ${d.rung}<br>Price: ${formatCurrency(d.price)}<br>Vol: ${formatNumber(d.assetSize, 4)}<br>Value (incl. fee): ${formatCurrency(d.capital)}<br>Alloc: ${formatPercent(d.allocation)}`)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.style("opacity", 0);
                        d3.select(this).style("opacity", 1);
                    });

                svg.selectAll("rect.buy-bar")
                    .transition()
                    .duration(800)
                    .attr("y", d => y(d.assetSize))
                    .attr("height", d => height - y(d.assetSize))
                    .delay((d, i) => i * 20);
                trackEvent('chart', 'buy:rendered', {
                    bars: Array.isArray(sortedData) ? sortedData.length : 0,
                    width,
                    height,
                    sharedMaxVolume: safeNumericSummary(sharedMaxVolume, 4)
                });
            }

            function drawSellChart(data, sharedMaxVolume) {
                const container = d3.select("#sell-visualization");
                if (container.node() === null) {
                    trackEvent('chart', 'sell:container-missing', {}, 'warn');
                    return;
                }

                d3.select("#sell-allocation-chart").selectAll("*").remove();
                if (!data || data.length === 0) {
                    trackEvent('chart', 'sell:empty', {
                        sharedMaxVolume: safeNumericSummary(sharedMaxVolume, 4)
                    }, 'warn');
                    return;
                }

                const margin = { top: 20, right: 80, bottom: 70, left: 80 }; // Balanced margins for symmetry
                let width;
                try {
                     width = container.node().getBoundingClientRect().width - margin.left - margin.right;
                } catch (e) {
                    console.error("Could not get container width:", e);
                    width = 500 - margin.left - margin.right; // Fallback width
                }
                width = Math.max(width, 100); // Ensure width is positive
                const height = 300 - margin.top - margin.bottom;

                const svg = d3.select("#sell-allocation-chart")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const sortedData = [...data].sort((a, b) => a.price - b.price);

                const x = d3.scaleBand()
                    .range([0, width])
                    .domain(sortedData.map(d => d.price))
                    .padding(0.2);

                const axisTextColor = getCssVariable('--color-chart-axis-text', '#2f3b58');

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x).tickFormat(d => formatCurrency(parseFloat(d))))
                    .selectAll("text")
                        .style("text-anchor", "end")
                        .attr("dx", "-.8em")
                        .attr("dy", ".15em")
                        .attr("transform", "rotate(-45)"); // Rotate labels
                
                svg.append("text")
                    .attr("text-anchor", "middle")
                    .attr("x", width / 2)
                    .attr("y", height + margin.bottom - 10) // Adjusted y
                    .text("Sell Price")
                    .style("fill", axisTextColor)
                    .style("font-size", "12px");

                const localMax = d3.max(sortedData, d => d.assetSize);
                const yMax = sharedMaxVolume && sharedMaxVolume > 0 ? sharedMaxVolume : (localMax > 0 ? localMax : 1);
                const y = d3.scaleLinear()
                    .domain([0, yMax > 0 ? yMax : 1]) 
                    .range([height, 0]);

                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5).tickFormat(d => formatNumber(d, 2)));

                svg.append("text")
                    .attr("text-anchor", "end")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -height / 2 + 20)
                    .text("Vol")
                    .style("fill", axisTextColor)
                    .style("font-size", "12px");

                const tooltip = d3.select("#tooltip");

                svg.selectAll(".sell-bar")
                    .data(sortedData)
                    .enter()
                    .append("rect")
                    .attr("class", "sell-bar")
                    .attr("x", d => x(d.price)) // Use price for x
                    .attr("width", x.bandwidth())
                    .attr("y", d => y(0))
                    .attr("height", d => height - y(0))
                    .on("mouseover", function(event, d) {
                        tooltip.style("opacity", 1);
                        d3.select(this).style("opacity", 0.7);
                    })
                    .on("mousemove", function(event, d) {
                        tooltip.html(`Rung ${d.rung}<br>Price: ${formatCurrency(d.price)}<br>Vol: ${formatNumber(d.assetSize, 4)}<br>Gross Value: ${formatCurrency(d.capital)}<br>Net Revenue: ${formatCurrency(d.netRevenue)}<br>Net Profit: ${formatCurrency(d.netProfit)}<br>Alloc: ${formatPercent(d.allocation)}`)
                            .style("left", (event.pageX + 15) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function(d) {
                        tooltip.style("opacity", 0);
                        d3.select(this).style("opacity", 1);
                    });

                svg.selectAll("rect.sell-bar")
                    .transition()
                    .duration(800)
                    .attr("y", d => y(d.assetSize))
                    .attr("height", d => height - y(d.assetSize))
                    .delay((d, i) => i * 20);
                trackEvent('chart', 'sell:rendered', {
                    bars: Array.isArray(sortedData) ? sortedData.length : 0,
                    width,
                    height,
                    sharedMaxVolume: safeNumericSummary(sharedMaxVolume, 4)
                });
            }

            // --- Real-time updates ---

            const inputsToTrack = [
                'starting_capital',
                'current_price'
            ];

            inputsToTrack.forEach((id) => {
                const input = document.getElementById(id);
                if (!input) {
                    return;
                }
                    input.addEventListener('input', (event) => {
                        trackInteraction('input-change', {
                            id,
                            value: event.target.value
                        });
                    schedulePlanUpdate();
                    });
                    input.addEventListener('blur', () => {
                        trackInteraction('input-blur', {
                            id,
                            value: input.value
                        });
                    });
            });

            // Section navigation & back-to-top
            const sectionTargets = navLinks
                .map((link) => link.getAttribute('data-nav-target'))
                .map((id) => document.getElementById(id))
                .filter(Boolean);

            const scrollBehavior = () => (prefersReducedMotionQuery.matches ? 'auto' : 'smooth');

            navLinks.forEach((link) => {
                link.addEventListener('click', (event) => {
                    const targetId = link.getAttribute('data-nav-target');
                    const target = targetId ? document.getElementById(targetId) : null;
                    if (!target) {
                        return;
                    }
                    event.preventDefault();
                    target.scrollIntoView({ behavior: scrollBehavior(), block: 'start' });
                    target.focus({ preventScroll: true });
                });
            });

            if ('IntersectionObserver' in window && sectionTargets.length > 0 && navLinks.length > 0) {
                const navObserver = new IntersectionObserver((entries) => {
                    const visibleEntry = entries
                        .filter((entry) => entry.isIntersecting)
                        .sort((a, b) => b.intersectionRatio - a.intersectionRatio)[0];
                    if (!visibleEntry) {
                        return;
                    }
                    const visibleId = visibleEntry.target.getAttribute('id');
                    navLinks.forEach((link) => {
                        const isActive = link.getAttribute('data-nav-target') === visibleId;
                        link.classList.toggle('active', isActive);
                        if (isActive) {
                            link.setAttribute('aria-current', 'true');
                        } else {
                            link.removeAttribute('aria-current');
                        }
                    });
                }, { rootMargin: '-40% 0px -50% 0px', threshold: 0.2 });
                sectionTargets.forEach((section) => navObserver.observe(section));
            } else if (navLinks.length > 0) {
                navLinks[0].classList.add('active');
                navLinks[0].setAttribute('aria-current', 'true');
            }

            const setOrderCardsCollapsed = (collapsed) => {
                orderCards.forEach((card) => {
                    card.classList.toggle('collapsed', collapsed);
                });
            };

            orderToggleButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const action = button.getAttribute('data-order-toggle');
                    const isCollapse = action === 'collapse';
                    setOrderCardsCollapsed(isCollapse);
                    trackInteraction('order-table-toggle', {
                        action,
                        collapsed: isCollapse
                    });
                });
            });

            const chartsLazySupported = 'IntersectionObserver' in window;
            const chartSections = [
                { id: 'buy-ladder', key: 'buy', element: null },
                { id: 'sell-ladder', key: 'sell', element: null }
            ];
            const chartVisibility = { buy: false, sell: false };
            let pendingChartData = null;

            const triggerChartRender = () => {
                if (!pendingChartData) {
                    return;
                }
                if (chartVisibility.buy && pendingChartData.buy && !(currentPlanData?.modes && currentPlanData.modes.sellOnly)) {
                    drawBuyChart(pendingChartData.buy, pendingChartData.sharedMaxVolume);
                    pendingChartData.buy = null;
                }
                if (chartVisibility.sell && pendingChartData.sell) {
                    drawSellChart(pendingChartData.sell, pendingChartData.sharedMaxVolume);
                    pendingChartData.sell = null;
                }
                if ((!pendingChartData.buy || chartVisibility.buy) && (!pendingChartData.sell || chartVisibility.sell)) {
                    pendingChartData = null;
                }
            };

            if (chartsLazySupported) {
                const chartObserver = new IntersectionObserver((entries) => {
                    entries.forEach((entry) => {
                        const match = chartSections.find((section) => section.element === entry.target);
                        if (!match) {
                            return;
                        }
                        chartVisibility[match.key] = entry.isIntersecting;
                    });
                    triggerChartRender();
                }, { threshold: 0.2 });
                chartSections.forEach((section) => {
                    section.element = document.getElementById(section.id);
                    if (section.element) {
                        chartObserver.observe(section.element);
                    }
                });
            }

            const exportFocusableSelector = 'button:not([disabled]), [data-export-format], a[href], input:not([disabled])';
            let exportSheetLastFocus = null;
            let exportScrollRestore = '';
            let pdfLibraryPromise = null;

            const setExportLoading = (isLoading, message = 'Preparing export…') => {
                if (!exportSheetStatus) {
                    return;
                }
                exportSheetStatus.classList.toggle('active', isLoading);
                exportSheetSpinner?.classList.toggle('hidden', !isLoading);
                if (exportStatusText) {
                    exportStatusText.textContent = message;
                }
            };

            const focusFirstExportElement = () => {
                if (!exportSheet) {
                    return;
                }
                const focusable = Array.from(exportSheet.querySelectorAll(exportFocusableSelector))
                    .filter((el) => !el.hasAttribute('disabled') && el.getAttribute('tabindex') !== '-1');
                (focusable[0] || exportSheetCloseBtn || exportSheet)?.focus({ preventScroll: true });
            };

            const openExportSheet = () => {
                if (!exportSheet || !exportSheetOverlay) {
                    return;
                }
                exportSheetLastFocus = document.activeElement instanceof HTMLElement ? document.activeElement : null;
                exportScrollRestore = document.body.style.overflow;
                document.body.style.overflow = 'hidden';
                exportSheet.classList.remove('hidden');
                exportSheetOverlay.classList.remove('hidden');
                requestAnimationFrame(() => {
                    exportSheet.classList.add('is-visible');
                    exportSheetOverlay.classList.add('is-visible');
                });
                exportSheet.setAttribute('aria-hidden', 'false');
                exportSheetOverlay.setAttribute('aria-hidden', 'false');
                setExportLoading(false);
                focusFirstExportElement();
            };

            const closeExportSheet = () => {
                if (!exportSheet || !exportSheetOverlay) {
                    return;
                }
                exportSheet.classList.remove('is-visible');
                exportSheetOverlay.classList.remove('is-visible');
                const finalize = () => {
                    exportSheet.classList.add('hidden');
                    exportSheetOverlay.classList.add('hidden');
                document.body.style.overflow = exportScrollRestore || '';
                };
                exportSheet.addEventListener('transitionend', finalize, { once: true });
                exportSheet.setAttribute('aria-hidden', 'true');
                exportSheetOverlay.setAttribute('aria-hidden', 'true');
                setExportLoading(false);
                if (exportSheetLastFocus && typeof exportSheetLastFocus.focus === 'function') {
                    exportSheetLastFocus.focus({ preventScroll: true });
                }
                exportSheetLastFocus = null;
            };

            const handleExportSheetKeyDown = (event) => {
                if (event.key !== 'Tab' || !exportSheet?.classList.contains('is-visible')) {
                    return;
                }
                const focusable = Array.from(exportSheet.querySelectorAll(exportFocusableSelector))
                    .filter((el) => !el.hasAttribute('disabled') && el.getAttribute('tabindex') !== '-1');
                if (focusable.length === 0) {
                    return;
                }
                const first = focusable[0];
                const last = focusable[focusable.length - 1];
                if (event.shiftKey && document.activeElement === first) {
                    event.preventDefault();
                    last.focus();
                } else if (!event.shiftKey && document.activeElement === last) {
                    event.preventDefault();
                    first.focus();
                }
            };

            const loadJsPdf = () => {
                if (window.jspdf?.jsPDF) {
                    return Promise.resolve(window.jspdf.jsPDF);
                }
                if (!pdfLibraryPromise) {
                    pdfLibraryPromise = new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                        script.onload = () => {
                            if (window.jspdf?.jsPDF) {
                                resolve(window.jspdf.jsPDF);
                            } else {
                                reject(new Error('jsPDF unavailable after load.'));
                            }
                        };
                        script.onerror = () => reject(new Error('Unable to load PDF library.'));
                        document.body.appendChild(script);
                    });
                }
                return pdfLibraryPromise;
            };

            exportTriggerButton?.addEventListener('click', openExportSheet);
            exportSheetOverlay?.addEventListener('click', closeExportSheet);
            exportSheetCloseBtn?.addEventListener('click', closeExportSheet);
            exportSheet?.addEventListener('keydown', handleExportSheetKeyDown);
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && exportSheet?.classList.contains('is-visible')) {
                    event.preventDefault();
                    closeExportSheet();
                }
            });

            exportFormatButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const format = button.getAttribute('data-export-format');
                    if (format === 'csv') {
                        handleCsvDownload();
                    } else if (format === 'xls') {
                        handleXlsDownload();
                    } else if (format === 'pdf') {
                        handlePdfDownload();
                    }
                });
            });

            function updateBackToTopVisibility() {
                if (!backToTopButton) {
                    return;
                }
                const shouldShow = currentLayoutMode === 'mobile' && window.scrollY > 400;
                backToTopButton.classList.toggle('visible', shouldShow);
                backToTopButton.setAttribute('aria-hidden', shouldShow ? 'false' : 'true');
            }

            if (backToTopButton) {
                backToTopButton.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: scrollBehavior() });
                });
                backToTopButton.setAttribute('aria-hidden', 'true');
            }

            let backToTopTicking = false;
            window.addEventListener('scroll', () => {
                if (backToTopTicking) {
                    return;
                }
                backToTopTicking = true;
                window.requestAnimationFrame(() => {
                    updateBackToTopVisibility();
                    backToTopTicking = false;
                });
            });
            updateBackToTopVisibility();

            // Toggle advanced settings collapse/expand (independent of checkbox state)
            if (advancedSettingsToggle && advancedSettings) {
                advancedSettingsToggle.addEventListener('click', () => {
                    const isExpanded = advancedSettingsToggle.getAttribute('aria-expanded') === 'true';
                    const shouldExpand = !isExpanded;
                    
                    // Only allow collapsing/expanding if advanced mode is enabled
                    if (!advancedToggle || !advancedToggle.checked) {
                        return;
                    }
                    
                    if (shouldExpand) {
                        advancedSettings.classList.remove('hidden');
                        advancedSettingsToggle.setAttribute('aria-expanded', 'true');
                        advancedSettingsToggle.querySelector('svg').classList.add('rotate-180');
                    } else {
                        advancedSettings.classList.add('hidden');
                        advancedSettingsToggle.setAttribute('aria-expanded', 'false');
                        advancedSettingsToggle.querySelector('svg').classList.remove('rotate-180');
                    }
                    
                    trackInteraction('advanced-settings-toggle', {
                        expanded: shouldExpand
                    });
                });
            }

            if (advancedToggle) {
                advancedToggle.addEventListener('change', () => {
                    trackInteraction('advanced-mode-toggle', {
                        enabled: advancedToggle.checked
                    });
                    if (advancedToggle.checked) {
                        // Show settings and expand by default when enabling advanced mode
                        advancedSettings?.classList.remove('hidden');
                        if (advancedSettingsToggle) {
                            advancedSettingsToggle.classList.remove('hidden');
                            advancedSettingsToggle.classList.add('flex');
                            advancedSettingsToggle.setAttribute('aria-expanded', 'true');
                            advancedSettingsToggle.querySelector('svg')?.classList.add('rotate-180');
                        }
                        if (equalQuantityCheckbox) {
                            setSkewDisabled(equalQuantityCheckbox.checked);
                        }
                    } else {
                        // Hide settings when disabling advanced mode
                        advancedSettings?.classList.add('hidden');
                        if (advancedSettingsToggle) {
                            advancedSettingsToggle.classList.add('hidden');
                            advancedSettingsToggle.classList.remove('flex');
                            advancedSettingsToggle.setAttribute('aria-expanded', 'false');
                            advancedSettingsToggle.querySelector('svg')?.classList.remove('rotate-180');
                        }
                        if (sellOnlyCheckbox) {
                            sellOnlyCheckbox.checked = false;
                            // Reset sell-only state when advanced mode is disabled
                            setSellOnlyHighestExecutedRung(null);
                            sellOnlyState.checkboxElements = [];
                        }
                        if (sellOnlyInputs) {
                            sellOnlyInputs.classList.add('hidden');
                        }
                        if (spacingModeSelect) {
                            spacingModeSelect.value = 'absolute';
                        }
                        if (equalQuantityCheckbox) {
                            equalQuantityCheckbox.checked = false;
                        }
                        setSkewDisabled(false);
                    }
                    calculatePlan();
                });
                if (!advancedToggle.checked) {
                    advancedSettings?.classList.add('hidden');
                    if (advancedSettingsToggle) {
                        advancedSettingsToggle.classList.add('hidden');
                        advancedSettingsToggle.setAttribute('aria-expanded', 'false');
                        advancedSettingsToggle.querySelector('svg')?.classList.remove('rotate-180');
                    }
                    setSkewDisabled(false);
                } else {
                    // Advanced mode is enabled on load, show settings expanded
                    advancedSettings?.classList.remove('hidden');
                    if (advancedSettingsToggle) {
                        advancedSettingsToggle.classList.remove('hidden');
                        advancedSettingsToggle.classList.add('flex');
                        advancedSettingsToggle.setAttribute('aria-expanded', 'true');
                        advancedSettingsToggle.querySelector('svg')?.classList.add('rotate-180');
                    }
                    if (equalQuantityCheckbox) {
                        setSkewDisabled(equalQuantityCheckbox.checked);
                    }
                }
            }

            if (sellOnlyCheckbox) {
                sellOnlyCheckbox.addEventListener('change', () => {
                    trackInteraction('sell-only-toggle', {
                        enabled: sellOnlyCheckbox.checked
                    });
                    if (sellOnlyCheckbox.checked) {
                        sellOnlyInputs?.classList.remove('hidden');
                    } else {
                        sellOnlyInputs?.classList.add('hidden');
                        setSellOnlyHighestExecutedRung(null);
                        sellOnlyState.checkboxElements = [];
                    }
                    calculatePlan();
                });
                if (!sellOnlyCheckbox.checked) {
                    sellOnlyInputs?.classList.add('hidden');
                }
            }

            if (equalQuantityCheckbox) {
                equalQuantityCheckbox.addEventListener('change', () => {
                    trackInteraction('equal-quantity-toggle', {
                        enabled: equalQuantityCheckbox.checked
                    });
                    setSkewDisabled(equalQuantityCheckbox.checked);
                    calculatePlan();
                });
                if (equalQuantityCheckbox.checked) {
                    setSkewDisabled(true);
                }
            }

            if (feeTypeSelect) {
                feeTypeSelect.addEventListener('change', () => {
                    trackInteraction('fee-type-change', {
                        value: feeTypeSelect.value
                    });
                    calculatePlan();
                });
            }

            if (feeValueInput) {
                feeValueInput.addEventListener('input', (event) => {
                    trackInteraction('fee-value-change', {
                        value: event.target.value
                    });
                    schedulePlanUpdate();
                });
            }

            if (feeSettlementSelect) {
                feeSettlementSelect.addEventListener('change', () => {
                    trackInteraction('fee-settlement-change', {
                        value: feeSettlementSelect.value
                    });
                    calculatePlan();
                });
            }

            if (existingQuantityInput) {
                existingQuantityInput.addEventListener('input', (event) => {
                    trackInteraction('existing-quantity-change', {
                        value: event.target.value
                    });
                    schedulePlanUpdate();
                });
            }

            if (existingAvgPriceInput) {
                existingAvgPriceInput.addEventListener('input', (event) => {
                    trackInteraction('existing-avg-price-change', {
                        value: event.target.value
                    });
                    schedulePlanUpdate();
                });
            }

            if (spacingModeSelect) {
                spacingModeSelect.addEventListener('change', () => {
                    trackInteraction('spacing-mode-change', {
                        mode: spacingModeSelect.value
                    });
                    calculatePlan();
                });
            }
            
            // --- Export Handlers ---
            if (exportCollapse) {
                exportCollapse.addEventListener('toggle', () => {
                    trackInteraction('export-menu-toggle', {
                        open: exportCollapse.open
                    });
                    const indicator = exportCollapse.querySelector('summary span');
                    if (indicator) {
                        indicator.textContent = exportCollapse.open ? '▲' : '▼';
                    }
                });
            }

            const handleCsvDownload = () => {
                const plan = ensurePlanAvailable();
                if (!plan) {
                    trackEvent('export', 'csv:aborted', {
                        reason: 'missing-plan'
                    }, 'warn');
                    return;
                }
                const settings = collectExportSettings();
                trackEvent('export', 'csv:prepare', {
                    settings,
                    summary: plan.summary ? {
                        totalQuantity: safeNumericSummary(plan.summary.totalQuantity, 4),
                        netProfit: safeNumericSummary(plan.summary.netProfit, 2)
                    } : {}
                });
                setExportLoading(true, 'Preparing CSV…');
                try {
                    const csvContent = buildCsvContent(plan, settings);
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `order_skew_plan_${new Date().toISOString().slice(0, 10)}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    trackEvent('export', 'csv:completed', {
                        bytes: csvContent.length,
                        settings
                    });
                    closeExportSheet();
                } finally {
                    setExportLoading(false);
                }
            };

            const handleXlsDownload = () => {
                const plan = ensurePlanAvailable();
                if (!plan) {
                    trackEvent('export', 'xls:aborted', {
                        reason: 'missing-plan'
                    }, 'warn');
                    return;
                }
                const settings = collectExportSettings();
                trackEvent('export', 'xls:prepare', {
                    settings,
                    summary: plan.summary ? {
                        totalQuantity: safeNumericSummary(plan.summary.totalQuantity, 4),
                        netProfit: safeNumericSummary(plan.summary.netProfit, 2)
                    } : {}
                });
                setExportLoading(true, 'Preparing XLS…');
                try {
                    const workbook = buildXlsContent(plan, settings);
                    const blob = new Blob([workbook], { type: 'application/vnd.ms-excel' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `order_skew_plan_${new Date().toISOString().slice(0, 10)}.xls`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    trackEvent('export', 'xls:completed', {
                        bytes: workbook.byteLength || workbook.length || 0,
                        settings
                    });
                    closeExportSheet();
                } finally {
                    setExportLoading(false);
                }
            };

            const handlePdfDownload = async () => {
                const plan = ensurePlanAvailable();
                if (!plan) {
                    trackEvent('export', 'pdf:aborted', {
                        reason: 'missing-plan'
                    }, 'warn');
                    return;
                }
                const settings = collectExportSettings();
                setExportLoading(true, 'Preparing PDF…');
                try {
                    const jsPDF = await loadJsPdf();
                    const doc = new jsPDF({ unit: 'pt', format: 'letter' });
                    doc.setFontSize(16);
                    doc.text('Order Skew Plan', 40, 60);
                    doc.setFontSize(11);
                    const summaryLines = [
                        `Avg Buy: ${formatCurrency(plan.summary.avgBuyPrice)}`,
                        `Avg Sell: ${formatCurrency(plan.summary.avgSellPrice)}`,
                        `Total Volume: ${formatNumber(plan.summary.totalQuantity, 4)}`,
                        `ROI: ${formatPercent(plan.summary.roi)}`
                    ];
                    summaryLines.forEach((line, index) => {
                        doc.text(line, 40, 90 + (index * 18));
                    });
                    doc.setFontSize(12);
                    doc.text('Top Buy Rungs', 40, 180);
                    plan.buyLadder.slice(0, 5).forEach((rung, index) => {
                        doc.text(`${rung.rung}. ${formatCurrency(rung.price)} · ${formatNumber(rung.assetSize, 4)} units`, 40, 200 + (index * 16));
                    });
                    doc.text('Top Sell Rungs', 40, 300);
                    plan.sellLadder.slice(0, 5).forEach((rung, index) => {
                        doc.text(`${rung.rung}. ${formatCurrency(rung.price)} · ${formatNumber(rung.assetSize, 4)} units`, 40, 320 + (index * 16));
                    });
                    doc.save(`order_skew_plan_${new Date().toISOString().slice(0, 10)}.pdf`);
                    trackEvent('export', 'pdf:completed', {
                        settings,
                        summary: plan.summary ? {
                            totalQuantity: safeNumericSummary(plan.summary.totalQuantity, 4),
                            netProfit: safeNumericSummary(plan.summary.netProfit, 2)
                        } : {}
                    });
                    closeExportSheet();
                } catch (error) {
                    console.error('PDF export failed', error);
                    alert('Unable to generate PDF at the moment. Please try again.');
                } finally {
                    setExportLoading(false);
                }
            };

            const runDisplayTests = () => {
                if (displayTestsExecuted) {
                    trackEvent('system', 'display-tests:skip', {});
                    return;
                }
                displayTestsExecuted = true;
                trackEvent('system', 'display-tests:start', {});

                const originalLayout = currentLayoutMode;
                const originalTheme = currentThemeMode;

                const mobileDetection = detectLayoutMode(480);
                console.assert(mobileDetection === 'mobile', 'Mobile detection failed at 480px width.');
                const desktopDetection = detectLayoutMode(1280);
                console.assert(desktopDetection === 'desktop', 'Desktop detection failed at 1280px width.');

                applyLayoutMode('desktop', { announce: false, source: 'self-test' });
                console.assert(document.body.classList.contains('layout-desktop'), 'layout-desktop class missing after desktop apply.');

                applyLayoutMode('mobile', { announce: false, source: 'self-test' });
                console.assert(document.body.classList.contains('layout-mobile'), 'layout-mobile class missing after mobile apply.');

                applyThemeMode('light', { announce: false, source: 'self-test' });
                const lightBackground = getCssVariable('--color-bg');
                console.assert(lightBackground !== '', 'Light theme background variable unavailable.');

                applyThemeMode('dark', { announce: false, source: 'self-test' });
                const darkBackground = getCssVariable('--color-bg');
                console.assert(darkBackground !== '', 'Dark theme background variable unavailable.');

                const tableCell = document.querySelector('#buy-ladder-body td');
                if (tableCell) {
                    console.assert(tableCell.hasAttribute('data-label'), 'Responsive table cells missing data-label attribute.');
                }

                applyLayoutMode(originalLayout, { announce: false, source: 'self-test' });
                applyThemeMode(originalTheme, { announce: false, source: 'self-test' });
                announceDisplayStatus();
                console.log('[Display] Self-tests completed for layout detection, theme toggling, and responsive tables.');
                trackEvent('system', 'display-tests:complete', {});
            };

            // --- Resize and Initial Load ---
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    const detectedLayout = detectLayoutMode();
                    trackEvent('display', 'window:resize', {
                        width: window.innerWidth,
                        height: window.innerHeight,
                        detectedLayout
                    });
                    if (detectedLayout !== currentLayoutMode) {
                        applyLayoutMode(detectedLayout, { source: 'auto-detect' });
                    }
                    if (currentPlanData) {
                        calculatePlan();
                    }
                }, 250);
            });

            // Intro modal functionality
            const introFocusableSelector = 'a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex="-1"])';
            const introModalContainer = introModal?.querySelector('.intro-modal-container');
            let introLastFocusedElement = null;
            let introStoredBodyOverflow = '';

            const isIntroVisible = () => introModal && !introModal.classList.contains('hidden');

            const focusFirstIntroElement = () => {
                if (!introModal) {
                    return;
                }
                const focusable = Array.from(introModal.querySelectorAll(introFocusableSelector))
                    .filter((el) => !el.hasAttribute('disabled') && el.getAttribute('tabindex') !== '-1' && el.offsetParent !== null);
                const target = focusable[0] || introCloseButton || introModal;
                target?.focus({ preventScroll: true });
            };

            const showIntroModal = () => {
                if (!introModal) {
                    return;
                }
                introLastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;
                introStoredBodyOverflow = document.body.style.overflow;
                    introModal.classList.remove('hidden');
                introModal.setAttribute('aria-hidden', 'false');
                    document.body.classList.add('intro-modal-open');
                document.body.style.overflow = 'hidden';
                focusFirstIntroElement();
            };

            const hideIntroModal = () => {
                if (!introModal) {
                    return;
                }
                    introModal.classList.add('hidden');
                introModal.setAttribute('aria-hidden', 'true');
                    document.body.classList.remove('intro-modal-open');
                document.body.style.overflow = introStoredBodyOverflow || '';
                if (introLastFocusedElement && typeof introLastFocusedElement.focus === 'function') {
                    introLastFocusedElement.focus({ preventScroll: true });
                }
                introLastFocusedElement = null;
            };

            const closeIntroAndSavePreference = () => {
                const skipIntro = introSkipCheckbox && introSkipCheckbox.checked;
                if (skipIntro) {
                    setStoredValue(INTRO_DISMISS_STORAGE_KEY, 'true');
                    setStoredValue(LEGACY_INTRO_SKIP_KEY, 'true');
                }
                hideIntroModal();
            };

            // Check if intro should be shown
            const shouldShowIntro = () => {
                const dismissed = getStoredValue(INTRO_DISMISS_STORAGE_KEY);
                if (dismissed === 'true') {
                    return false;
                }
                const legacySkip = getStoredValue(LEGACY_INTRO_SKIP_KEY);
                if (legacySkip === 'true') {
                    setStoredValue(INTRO_DISMISS_STORAGE_KEY, 'true');
                    return false;
                }
                return true;
            };

            // Show intro modal if preference allows
            if (shouldShowIntro()) {
                showIntroModal();
            }

            const handleIntroBackdropClick = (event) => {
                if (event.target === introModal) {
                    closeIntroAndSavePreference();
                    trackInteraction('intro', 'close-backdrop', {
                        skipIntro: introSkipCheckbox?.checked || false
                    });
                }
            };

            const trapIntroFocus = (event) => {
                if (event.key !== 'Tab' || !isIntroVisible() || !introModalContainer) {
                    return;
                }
                const focusable = Array.from(introModalContainer.querySelectorAll(introFocusableSelector))
                    .filter((el) => !el.hasAttribute('disabled') && el.getAttribute('tabindex') !== '-1' && el.offsetParent !== null);
                if (focusable.length === 0) {
                    return;
                }
                const first = focusable[0];
                const last = focusable[focusable.length - 1];
                if (event.shiftKey && document.activeElement === first) {
                    event.preventDefault();
                    last.focus();
                } else if (!event.shiftKey && document.activeElement === last) {
                    event.preventDefault();
                    first.focus();
                }
            };

            const handleIntroEscape = (event) => {
                if (event.key === 'Escape' && isIntroVisible()) {
                    event.preventDefault();
                    closeIntroAndSavePreference();
                }
            };

            introModal?.addEventListener('click', handleIntroBackdropClick);
            introModalContainer?.addEventListener('click', (event) => event.stopPropagation());
            introModalContainer?.addEventListener('keydown', trapIntroFocus);
            document.addEventListener('keydown', handleIntroEscape);

            // Event handlers for intro modal
            if (introGetStartedButton) {
                introGetStartedButton.addEventListener('click', () => {
                    closeIntroAndSavePreference();
                    trackInteraction('intro', 'get-started', {
                        skipIntro: introSkipCheckbox?.checked || false
                    });
                });
            }

            if (introSkipButton) {
                introSkipButton.addEventListener('click', () => {
                    closeIntroAndSavePreference();
                    trackInteraction('intro', 'skip', {
                        skipIntro: introSkipCheckbox?.checked || false
                    });
                });
            }

            if (introCloseButton) {
                introCloseButton.addEventListener('click', () => {
                        closeIntroAndSavePreference();
                    trackInteraction('intro', 'close-button', {
                            skipIntro: introSkipCheckbox?.checked || false
                        });
                });
            }


            // Load saved form values on page load (before first calculation)
            initializeSliderControls();
            loadFormValues();

            // Set up form value persistence - save values when they change
            const startingCapitalInput = document.getElementById('starting_capital');
            const currentPriceInput = document.getElementById('current_price');
            
            if (startingCapitalInput) {
                startingCapitalInput.addEventListener('input', () => {
                    saveFormValue(STORAGE_KEYS.startingCapital, startingCapitalInput.value);
                });
            }
            if (currentPriceInput) {
                currentPriceInput.addEventListener('input', () => {
                    saveFormValue(STORAGE_KEYS.currentPrice, currentPriceInput.value);
                });
            }
            if (advancedToggle) {
                // Save when changed (in addition to existing change handler)
                const originalAdvancedHandler = advancedToggle.onchange;
                advancedToggle.addEventListener('change', () => {
                    saveFormValue(STORAGE_KEYS.advancedMode, advancedToggle.checked);
                });
            }
            if (sellOnlyCheckbox) {
                // Save when changed (in addition to existing change handler)
                sellOnlyCheckbox.addEventListener('change', () => {
                    saveFormValue(STORAGE_KEYS.sellOnlyMode, sellOnlyCheckbox.checked);
                });
            }
            if (equalQuantityCheckbox) {
                // Save when changed (in addition to existing change handler)
                equalQuantityCheckbox.addEventListener('change', () => {
                    saveFormValue(STORAGE_KEYS.equalQuantityMode, equalQuantityCheckbox.checked);
                });
            }
            if (feeTypeSelect) {
                feeTypeSelect.addEventListener('change', () => {
                    saveFormValue(STORAGE_KEYS.feeType, feeTypeSelect.value);
                });
            }
            if (feeSettlementSelect) {
                feeSettlementSelect.addEventListener('change', () => {
                    saveFormValue(STORAGE_KEYS.feeSettlement, feeSettlementSelect.value);
                });
            }
            if (spacingModeSelect) {
                spacingModeSelect.addEventListener('change', () => {
                    saveFormValue(STORAGE_KEYS.spacingMode, spacingModeSelect.value);
                });
            }
            if (feeValueInput) {
                feeValueInput.addEventListener('input', () => {
                    saveFormValue(STORAGE_KEYS.feeValue, feeValueInput.value);
                });
            }
            if (existingQuantityInput) {
                existingQuantityInput.addEventListener('input', () => {
                    saveFormValue(STORAGE_KEYS.existingQuantity, existingQuantityInput.value);
                });
            }
            if (existingAvgPriceInput) {
                existingAvgPriceInput.addEventListener('input', () => {
                    saveFormValue(STORAGE_KEYS.existingAvgPrice, existingAvgPriceInput.value);
                });
            }

            // Initial calculation on page load (after loading saved values)
            calculatePlan();
            runDisplayTests();

            // Solana logo QR code functionality
            const solanaLogoBtnHeader = document.getElementById('solana-logo-btn-header');
            const solanaLogoBtnFooter = document.getElementById('solana-logo-btn');
            const qrCodeContainer = document.getElementById('qr-code-container');
            const qrCodeOverlay = document.getElementById('qr-code-overlay');
            const qrCodeCloseBtn = document.getElementById('qr-code-close-btn');
            const donationAddressCopyBtn = document.getElementById('donation-address-copy-btn');
            const SOL_ADDRESS = 'F6mjNXKBKzjmKTK1Z9cWabFHZYtxMg8rojuNuppX2EG1';

            // Function to show QR code modal
            const showQRCode = () => {
                if (qrCodeContainer && qrCodeOverlay) {
                    qrCodeOverlay.classList.remove('hidden');
                    qrCodeContainer.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Prevent background scrolling
                }
            };

            // Function to hide QR code modal
            const hideQRCode = () => {
                if (qrCodeContainer && qrCodeOverlay) {
                    qrCodeOverlay.classList.add('hidden');
                    qrCodeContainer.classList.add('hidden');
                    document.body.style.overflow = ''; // Restore scrolling
                }
            };

            // Show QR code when Solana logo is clicked (header or footer)
            if (solanaLogoBtnHeader) {
                solanaLogoBtnHeader.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showQRCode();
                });
            }
            if (solanaLogoBtnFooter) {
                solanaLogoBtnFooter.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    showQRCode();
                });
            }

            // Close QR code when close button is clicked
            if (qrCodeCloseBtn) {
                qrCodeCloseBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    hideQRCode();
                });
            }

            // Close QR code when overlay is clicked
            if (qrCodeOverlay) {
                qrCodeOverlay.addEventListener('click', (e) => {
                    if (e.target === qrCodeOverlay) {
                        hideQRCode();
                    }
                });
            }

            // Close QR code when Escape key is pressed
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && qrCodeContainer && !qrCodeContainer.classList.contains('hidden')) {
                    hideQRCode();
                }
            });

            // Copy address button functionality
            if (donationAddressCopyBtn) {
                donationAddressCopyBtn.addEventListener('click', async () => {
                    try {
                        await navigator.clipboard.writeText(SOL_ADDRESS);
                        donationAddressCopyBtn.classList.add('copied');
                        donationAddressCopyBtn.setAttribute('aria-label', 'Address copied!');
                        
                        setTimeout(() => {
                            donationAddressCopyBtn.classList.remove('copied');
                            donationAddressCopyBtn.setAttribute('aria-label', 'Copy Solana address');
                        }, 2000);
                    } catch (err) {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = SOL_ADDRESS;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            donationAddressCopyBtn.classList.add('copied');
                            donationAddressCopyBtn.setAttribute('aria-label', 'Address copied!');
                            
                            setTimeout(() => {
                                donationAddressCopyBtn.classList.remove('copied');
                                donationAddressCopyBtn.setAttribute('aria-label', 'Copy Solana address');
                            }, 2000);
                        } catch (fallbackErr) {
                            console.warn('Failed to copy address:', fallbackErr);
                        }
                        document.body.removeChild(textArea);
                    }
                });
            }
            
        });
    </script>
</body>
</html>