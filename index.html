<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Skew | Trading Plan Calculator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22 fill=%22none%22 stroke=%22%230ea5e9%22 stroke-width=%228%22 stroke-linecap=%22round%22><line x1=%2220%22 y1=%2280%22 x2=%2235%22 y2=%2280%22 /><line x1=%2220%22 y1=%2260%22 x2=%2250%22 y2=%2260%22 /><line x1=%2220%22 y1=%2240%22 x2=%2265%22 y2=%2240%22 /><line x1=%2220%22 y1=%2220%22 x2=%2280%22 y2=%2220%22 /></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Michroma&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES --- */
        :root {
            --color-bg: #cde7ec;
            --color-card: #edfcff;
            --color-card-alt: #dbf6fa;
            --color-card-muted: #f0f7f8;
            --color-text: #273f43;
            --color-text-secondary: #4a656b;
            --color-text-muted: #6c858b;
            --color-border: #c8e6eb;
            --color-border-strong: #bac6ea;
            --color-primary: #00424a;
            --color-primary-accent: #005f6b;
            --color-primary-contrast: #ffffff;
            --color-secondary: #008a7b;
            --color-secondary-hover: #006b5e;
            --color-tooltip-bg: #00424a;
            --color-tooltip-text: #ffffff;
            --color-table-row-even: #f8fafa;
            --color-table-row-odd: #ffffff;
            --color-summary-bg: #e0f7fa;
            --color-summary-border: #006064;
            --color-executed-bg: #dcfce7;
            --color-invalid: #ef4444;
            --color-slider-track: #cbd5e1;
            --color-slider-thumb: #00424a;
            --color-chart-buy-start: #ef4444;
            --color-chart-buy-end: #ef4444;
            --color-chart-sell-start: #22c55e;
            --color-chart-sell-end: #22c55e;
            --focus-ring-color: rgba(0, 66, 74, 0.2);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body.theme-dark {
            --color-bg: #0f172a;
            --color-card: #1e293b;
            --color-card-alt: #334155;
            --color-card-muted: #253146;
            --color-text: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;
            --color-border: #334155;
            --color-border-strong: #475569;
            --color-primary: #38bdf8;
            --color-primary-accent: #0ea5e9;
            --color-primary-contrast: #0f172a;
            --color-secondary: #22d3ee;
            --color-secondary-hover: #06b6d4;
            --color-tooltip-bg: #e0f2fe;
            --color-tooltip-text: #0f172a;
            --color-table-row-even: #1e293b;
            --color-table-row-odd: #243146;
            --color-summary-bg: rgba(56, 189, 248, 0.1);
            --color-summary-border: #38bdf8;
            --color-executed-bg: rgba(34, 197, 94, 0.15);
            --color-invalid: #f87171;
            --color-slider-track: #334155;
            --color-slider-thumb: #38bdf8;
            --color-chart-buy-start: #f87171;
            --color-chart-buy-end: #f87171;
            --color-chart-sell-start: #4ade80;
            --color-chart-sell-end: #4ade80;
            --focus-ring-color: rgba(56, 189, 248, 0.35);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }

        /* --- BASE --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color .3s ease, color .3s ease;
            -webkit-font-smoothing: antialiased;
            /* Reduced padding to avoid excessive gap but still clear footer */
            padding-bottom: 80px; 
        }
        
        .font-solana {
            font-family: 'Michroma', sans-serif;
            letter-spacing: -0.02em;
        }
        
        @media (min-width: 1024px) { body { padding-bottom: 0; } #panel-buy, #panel-sell { padding-bottom: 2rem; } }
        @media (max-width: 1023px) { #panel-buy, #panel-sell { padding-bottom: 0.5rem; } #buy-ladder-body, #sell-ladder-body { padding-bottom: 1rem; } }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

        /* --- FORM ELEMENTS --- */
        .form-input, select.form-input {
            background-color: var(--color-card-muted);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            transition: all .2s ease;
            font-size: 0.9rem;
        }

        .form-input:focus, select.form-input:focus {
            outline: 0;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--focus-ring-color);
            background-color: var(--color-card);
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 6px;
            background: var(--color-slider-track);
            border-radius: 3px; outline: 0; opacity: .85;
            transition: opacity .2s;
        }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px;
            background: var(--color-slider-thumb);
            cursor: pointer; border-radius: 50%;
            border: 2px solid var(--color-card);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* --- BUTTONS --- */
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-contrast);
            transition: all .2s ease;
            box-shadow: var(--shadow-sm);
        }
        .btn-primary:hover { 
            background-color: var(--color-primary-accent); 
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .btn-secondary {
            background-color: var(--color-card-alt);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            transition: all .2s ease;
        }
        .btn-secondary:hover { 
            background-color: var(--color-border);
            color: var(--color-primary);
        }

        .helper-tooltip {
            background-color: transparent;
            border: 1px solid var(--color-border-strong);
            color: var(--color-text-muted);
            border-radius: 50%;
            width: 16px; height: 16px;
            font-size: .7rem;
            display: flex; align-items: center; justify-content: center;
            cursor: help;
            transition: all .2s;
            flex-shrink: 0;
        }
        .helper-tooltip:hover { border-color: var(--color-primary); color: var(--color-primary); }

        .fee-type-btn, .chart-toggle-btn {
            border: none;
            outline: none;
            cursor: pointer;
        }
        .fee-type-btn.active, .chart-toggle-btn.active {
            background-color: var(--color-primary);
            color: var(--color-primary-contrast);
        }
        .fee-type-btn:not(.active), .chart-toggle-btn:not(.active) {
            background-color: transparent;
            color: var(--color-text-secondary);
        }
        .fee-type-btn:not(.active):hover, .chart-toggle-btn:not(.active):hover {
            color: var(--color-text);
            background-color: var(--color-card);
        }

        /* Mode Cards */
        .mode-card {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .mode-card:hover {
            transform: translateY(-2px);
        }
        .mode-card.active {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        /* Sell Mode Active State */
        .sell-mode-active .buy-only-content {
            display: none !important;
        }
        .sell-mode-active #tab-buy {
            display: none !important;
        }
        .sell-mode-active .chart-buy-legend {
            display: none !important;
        }

        /* --- CARDS --- */
        .card {
            background-color: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            box-shadow: var(--shadow-sm);
            transition: all .3s ease;
        }
        .card:hover { box-shadow: var(--shadow-md); border-color: var(--color-border-strong); }

        /* --- TABLES --- */
        .table-header th { 
            background-color: var(--color-card-alt); 
            color: var(--color-text-secondary);
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        
        .table-row-odd td { background-color: var(--color-table-row-odd); }
        .table-row-even td { background-color: var(--color-table-row-even); }
        
        .executed-rung td {
            background-color: var(--color-executed-bg);
            color: var(--color-text);
            font-weight: 500;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .copy-cursor { cursor: copy; }
        .copy-cursor:active { transform: scale(0.98); background-color: var(--color-card-alt); }

        /* --- CHARTS --- */
        .d3-chart text { fill: var(--color-text-muted); font-family: 'Inter', sans-serif; font-size: 10px; }
        .d3-chart .domain, .d3-chart .tick line { stroke: var(--color-border-strong); opacity: 0.5; }
        .tooltip {
            position: absolute;
            padding: 8px 12px;
            font-size: 12px;
            background: var(--color-tooltip-bg);
            color: var(--color-tooltip-text);
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            transition: opacity 0.15s ease, transform 0.15s ease;
            white-space: nowrap;
        }

        /* --- STICKY MOBILE FOOTER --- */
        .mobile-sticky-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--color-card);
            border-top: 1px solid var(--color-border-strong);
            padding: 0.5rem 1rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .mobile-sticky-footer.visible { transform: translateY(0); }
        .mobile-sticky-footer > div {
            gap: 0.125rem;
        }
        .mobile-sticky-footer span {
            line-height: 1.2;
        }
        
        /* --- QR MODAL --- */
        .qr-modal {
            position: fixed; inset: 0; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        .qr-modal.open { pointer-events: auto; opacity: 1; }
        .qr-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .qr-content { 
            position: relative; background: var(--color-card); 
            padding: 2rem; border-radius: 1rem; 
            box-shadow: var(--shadow-lg); max-width: 340px; width: 100%;
            text-align: center; transform: translateY(10px); transition: transform 0.2s;
        }
        .qr-modal.open .qr-content { transform: translateY(0); }

        /* --- TOAST --- */
        .toast {
            position: fixed; 
            bottom: 2rem; 
            left: 50%; 
            transform: translateX(-50%) translateY(20px);
            background: var(--color-primary); 
            color: white;
            padding: 0.5rem 1rem; 
            font-size: 0.875rem;
            opacity: 0; 
            pointer-events: none; 
            transition: all 0.3s; 
            z-index: 2000;
            border-radius: 9999px; 
            box-shadow: var(--shadow-lg);
        }
        .toast.show { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0); 
        }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

        /* --- SETUP WIZARD --- */
        #setup-wizard.open {
            opacity: 1;
            pointer-events: auto;
        }
        #setup-wizard.open > div {
            transform: scale(1);
        }
        .wizard-question {
            animation: fadeIn 0.3s ease-out;
        }
        .wizard-input {
            width: 100%;
            padding: 0.875rem 1.25rem;
            background-color: var(--color-card-muted);
            border: 2px solid var(--color-border);
            border-radius: 0.875rem;
            color: var(--color-text);
            font-size: 1.125rem;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        .wizard-input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.15);
            background-color: var(--color-card);
        }
        .wizard-input::placeholder {
            color: var(--color-text-muted);
            opacity: 0.6;
        }
        .wizard-option {
            padding: 1.125rem 1.5rem; background-color: var(--color-card-muted);
            border: 2px solid var(--color-border); border-radius: 0.875rem;
            cursor: pointer; transition: all 0.2s ease; text-align: left;
            font-size: 1rem; font-weight: 500; position: relative; overflow: hidden;
        }
        .wizard-option::before {
            content: ''; position: absolute; left: 0; top: 0; width: 4px; height: 100%;
            background: linear-gradient(to bottom, #0ea5e9, #0284c7);
            transform: scaleY(0); transition: transform 0.2s ease;
        }
        .wizard-option:hover, .wizard-option.selected { border-color: #0ea5e9; }
        .wizard-option:hover { background-color: var(--color-card); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2); }
        .wizard-option:hover::before, .wizard-option.selected::before { transform: scaleY(1); }
        .wizard-option.selected { background: linear-gradient(135deg, rgba(14, 165, 233, 0.1), rgba(2, 132, 199, 0.1)); box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.3); }
        .wizard-option:focus { outline: none; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3); }
        .wizard-hint {
            font-size: 0.9375rem;
            color: var(--color-text-muted);
            margin-top: 0.75rem;
            line-height: 1.6;
            padding: 0.75rem 1rem;
            background-color: var(--color-card-muted);
            border-left: 3px solid #0ea5e9;
            border-radius: 0.5rem;
        }
        .wizard-error {
            color: var(--color-invalid);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.5rem 0.75rem;
            background-color: rgba(239, 68, 68, 0.1);
            border-radius: 0.5rem;
            display: none;
        }
        .wizard-error.show {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }
        #wizard-progress {
            background: linear-gradient(to right, #0ea5e9, #0284c7, #06b6d4);
        }

        /* --- RESPONSIVE BUTTON STYLES --- */
        
        /* Base button touch target - ensure minimum 44px for accessibility */
        button, .btn-primary, .btn-secondary, .mode-card, .fee-type-btn, .chart-toggle-btn, .wizard-option {
            min-height: 44px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Small buttons can have smaller height */
        .helper-tooltip {
            min-height: auto;
        }
        
        /* Mobile button improvements */
        @media (max-width: 639px) {
            #enter-app-btn { width: 100%; max-width: 320px; padding: 1rem 1.5rem; font-size: 0.875rem; }
            #quick-start-btn { padding: 0.75rem; font-size: 0.8125rem; }
            #intro-video-link, #intro-how-it-works { padding: 0.5rem; font-size: 0.75rem; }
            header .flex.items-center.gap-3 { flex-wrap: wrap; gap: 0.5rem; justify-content: flex-end; }
            #sol-btn, #theme-toggle-btn, #video-btn-mobile, #sticky-expand-btn { padding: 0.75rem; min-width: 44px; min-height: 44px; }
            #sticky-expand-btn { padding: 0.5rem; }
            .btn-secondary.flex.items-center.gap-2 { padding: 0.625rem 0.875rem; font-size: 0.8125rem; }
            #mode-buy-btn, #mode-sell-btn { padding: 0.75rem; }
            #mode-simple, #mode-pro { padding: 0.5rem 0.75rem; font-size: 0.6875rem; }
            #tab-buy, #tab-sell { padding: 0.875rem 0.5rem; font-size: 0.8125rem; }
            .fee-type-btn, .chart-toggle-btn { padding: 0.625rem 0.75rem; font-size: 0.6875rem; min-height: 36px; }
            #wizard-back, #wizard-next { padding: 0.875rem 1.5rem; font-size: 0.875rem; min-width: 100px; }
            #wizard-skip { padding: 0.5rem 0.75rem; }
            .helper-tooltip { width: 24px; height: 24px; font-size: 0.75rem; }
            #qr-close, #video-close, #how-it-works-close { padding: 0.875rem; font-size: 0.875rem; }
            details summary { padding: 0.875rem 1rem; }
            .wizard-option { padding: 1rem 1.25rem; font-size: 0.9375rem; }
        }
        @media (min-width: 640px) and (max-width: 1023px) {
            #tab-buy, #tab-sell { padding: 0.875rem; }
        }
        
        /* Touch device button states */
        @media (hover: none) and (pointer: coarse) {
            .btn-primary:hover, .btn-secondary:hover, .mode-card:hover,
            .fee-type-btn:not(.active):hover, .chart-toggle-btn:not(.active):hover, .wizard-option:hover { transform: none; }
            .btn-primary:active, .btn-secondary:active, .mode-card:active, .wizard-option:active { transform: scale(0.98); }
            .btn-primary:active { opacity: 0.9; }
            .btn-secondary:active { background-color: var(--color-border); }
            .wizard-option:active { border-color: #0ea5e9; }
        }
        
        /* Focus and selection states for all buttons */
        button:focus-visible, .btn-primary:focus-visible, .btn-secondary:focus-visible, .mode-card:focus-visible,
        .fee-type-btn:focus-visible, .chart-toggle-btn:focus-visible, .wizard-option:focus-visible {
            outline: 2px solid var(--color-primary); outline-offset: 2px;
        }
        button, .btn-primary, .btn-secondary, .mode-card, .fee-type-btn, .chart-toggle-btn, .wizard-option {
            user-select: none; -webkit-user-select: none;
        }

    </style>
</head>
<body class="p-3 sm:p-6 theme-light layout-desktop antialiased">

    <!-- Intro Overlay -->
    <div id="intro-layer" class="fixed inset-0 z-[9999] bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 flex items-center justify-center transition-opacity duration-500 overflow-hidden">
        <!-- Animated Background Pattern -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-cyan-900/20 via-transparent to-transparent"></div>
            <div class="absolute top-0 left-0 w-full h-full">
                <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-cyan-500/10 rounded-full blur-3xl animate-pulse"></div>
                <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-blue-500/10 rounded-full blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
        </div>
        </div>
        
        <!-- Content -->
        <div class="relative z-20 text-center space-y-8 animate-fade-in px-4 max-w-2xl">
            <div class="space-y-3">
                <h1 class="text-5xl md:text-7xl font-bold font-solana text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-400 to-cyan-300 drop-shadow-lg tracking-tight">
                    ORDER SKEW
                </h1>
                <div class="h-1 w-40 mx-auto bg-gradient-to-r from-transparent via-cyan-400 to-transparent rounded-full"></div>
                <p class="text-cyan-200/80 text-sm tracking-[0.3em] uppercase font-light">Trading Plan Calculator</p>
            </div>
            
            <p class="text-gray-300 text-lg md:text-xl tracking-wide font-light max-w-lg mx-auto leading-relaxed">
                Create smart <span class="text-red-400 font-medium">buy</span> and <span class="text-green-400 font-medium">sell</span> ladders<br>
                <span class="text-gray-400 text-base">with customizable allocation strategies</span>
            </p>

            <!-- Feature Highlights -->
            <div class="grid grid-cols-3 gap-4 max-w-md mx-auto text-center">
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-2xl mb-1">üìä</div>
                    <div class="text-xs text-gray-400">Visual Planning</div>
                </div>
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-2xl mb-1">‚öñÔ∏è</div>
                    <div class="text-xs text-gray-400">Smart Allocation</div>
                </div>
                <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                    <div class="text-2xl mb-1">üí∞</div>
                    <div class="text-xs text-gray-400">Profit Projection</div>
                </div>
            </div>
            
            <div class="flex flex-col items-center gap-3 sm:gap-4 pt-4 w-full px-4 sm:px-0">
                <button id="enter-app-btn" class="group relative w-full sm:w-auto px-8 sm:px-12 py-3.5 sm:py-4 bg-gradient-to-r from-cyan-500 to-blue-500 overflow-hidden rounded-xl text-white font-bold tracking-wide uppercase shadow-xl shadow-cyan-500/25 hover:shadow-cyan-500/40 transition-all duration-300 hover:scale-105 active:scale-95 text-sm sm:text-base">
                    <span class="relative z-10 flex items-center justify-center gap-2">
                        <span>Start Planning</span>
                        <svg class="w-4 h-4 sm:w-5 sm:h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>
                    </span>
                </button>
                
                <button id="quick-start-btn" class="text-cyan-400/70 hover:text-cyan-400 active:text-cyan-300 transition-colors text-xs sm:text-sm underline underline-offset-4 py-2">
                    Quick start with example values ‚Üí
                </button>
                
                <div class="flex flex-wrap items-center justify-center gap-4 sm:gap-6 text-xs sm:text-sm mt-2">
                    <button id="intro-video-link" class="flex items-center gap-1.5 sm:gap-2 text-gray-400 hover:text-cyan-400 active:text-cyan-300 transition-colors py-2 px-1">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>Watch Tutorial</span>
                    </button>
                    <button id="intro-how-it-works" class="flex items-center gap-1.5 sm:gap-2 text-gray-400 hover:text-cyan-400 active:text-cyan-300 transition-colors py-2 px-1">
                        <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span>How It Works</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- How It Works Modal -->
    <div id="how-it-works-modal" class="qr-modal" style="z-index: 10001;">
        <div class="qr-backdrop" id="how-it-works-backdrop"></div>
        <div class="qr-content w-full max-w-2xl p-0 bg-[var(--color-card)] rounded-2xl overflow-hidden max-h-[90vh] overflow-y-auto">
            <!-- Header -->
            <div class="bg-gradient-to-r from-cyan-500/20 to-blue-500/20 p-6 border-b border-[var(--color-border)]">
                <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-400 font-solana text-center">Welcome to Order Skew</h3>
                <p class="text-center text-[var(--color-text-secondary)] text-sm mt-2">Your intelligent trading plan calculator for strategic order placement</p>
            </div>
            
            <div class="p-6 space-y-6">
                <!-- What is Order Skew -->
                <div class="space-y-3">
                    <h4 class="text-lg font-semibold text-[var(--color-text)] flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-cyan-500/20 text-cyan-400 flex items-center justify-center text-sm">?</span>
                        What is Order Skew?
                    </h4>
                    <p class="text-sm text-[var(--color-text-secondary)] leading-relaxed pl-9">
                        Order Skew helps you create <strong class="text-red-400">buy ladders</strong> and <strong class="text-green-400">sell ladders</strong> ‚Äî 
                        a series of limit orders at different price levels. Instead of placing one big order, you spread your capital across multiple price points 
                        to reduce risk and improve your average entry/exit price.
                    </p>
                </div>

                <!-- Trading Modes -->
                <div class="space-y-3">
                    <h4 class="text-lg font-semibold text-[var(--color-text)] flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center text-sm">‚öô</span>
                        Choose Your Mode
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 pl-9">
                        <div class="p-3 rounded-lg bg-gradient-to-br from-red-500/10 to-green-500/10 border border-[var(--color-border)]">
                            <p class="font-medium text-[var(--color-text)] text-sm">Buy + Sell</p>
                            <p class="text-xs text-[var(--color-text-muted)] mt-1">Plan both entry and exit orders for complete round-trip trades</p>
                        </div>
                        <div class="p-3 rounded-lg bg-red-500/10 border border-red-500/30">
                            <p class="font-medium text-red-400 text-sm">Buy Only</p>
                            <p class="text-xs text-[var(--color-text-muted)] mt-1">Accumulate assets with a DCA-style buy ladder</p>
                        </div>
                        <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/30">
                            <p class="font-medium text-green-400 text-sm">Sell Only</p>
                            <p class="text-xs text-[var(--color-text-muted)] mt-1">Already holding? Plan your exit strategy</p>
                        </div>
                    </div>
                </div>

                <!-- Step by Step -->
                <div class="space-y-3">
                    <h4 class="text-lg font-semibold text-[var(--color-text)] flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center text-sm">üìã</span>
                        Step-by-Step Guide
                    </h4>
                    <div class="space-y-2 pl-9">
                        <div class="flex gap-3 items-start">
                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center text-xs font-bold">1</div>
                            <div>
                                <p class="font-medium text-[var(--color-text)] text-sm">Set Your Capital & Price</p>
                                <p class="text-xs text-[var(--color-text-muted)]">Enter how much you want to invest and the current asset price</p>
                            </div>
                        </div>
                        <div class="flex gap-3 items-start">
                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-orange-500/20 text-orange-400 flex items-center justify-center text-xs font-bold">2</div>
                            <div>
                                <p class="font-medium text-[var(--color-text)] text-sm">Define Your Range</p>
                                <p class="text-xs text-[var(--color-text-muted)]">Set the price spread (%) for buy orders below and sell orders above current price</p>
                            </div>
                        </div>
                        <div class="flex gap-3 items-start">
                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-yellow-500/20 text-yellow-400 flex items-center justify-center text-xs font-bold">3</div>
                            <div>
                                <p class="font-medium text-[var(--color-text)] text-sm">Choose Allocation Strategy</p>
                                <p class="text-xs text-[var(--color-text-muted)]">Linear (equal amounts) or Martingale (larger orders at extreme prices)</p>
                            </div>
                        </div>
                        <div class="flex gap-3 items-start">
                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-xs font-bold">4</div>
                            <div>
                                <p class="font-medium text-[var(--color-text)] text-sm">Set Number of Orders</p>
                                <p class="text-xs text-[var(--color-text-muted)]">More orders = finer granularity, but some exchanges have minimum order sizes</p>
                            </div>
                        </div>
                        <div class="flex gap-3 items-start">
                            <div class="flex-shrink-0 w-6 h-6 rounded-full bg-cyan-500/20 text-cyan-400 flex items-center justify-center text-xs font-bold">5</div>
                            <div>
                                <p class="font-medium text-[var(--color-text)] text-sm">Review & Export</p>
                                <p class="text-xs text-[var(--color-text-muted)]">View your order table, charts, and projected profits ‚Äî then copy or export</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Allocation Strategies Visual -->
                <div class="space-y-3">
                    <h4 class="text-lg font-semibold text-[var(--color-text)] flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-blue-500/20 text-blue-400 flex items-center justify-center text-sm">‚öñ</span>
                        Allocation Strategies
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pl-9">
                        <div class="p-4 rounded-lg bg-[var(--color-card-muted)] border border-[var(--color-border)]">
                            <p class="font-medium text-[var(--color-text)] text-sm mb-2">Linear (Even)</p>
                            <div class="flex items-end gap-1 h-12 mb-2">
                                <div class="flex-1 bg-cyan-500/60 rounded-t" style="height: 100%"></div>
                                <div class="flex-1 bg-cyan-500/60 rounded-t" style="height: 100%"></div>
                                <div class="flex-1 bg-cyan-500/60 rounded-t" style="height: 100%"></div>
                                <div class="flex-1 bg-cyan-500/60 rounded-t" style="height: 100%"></div>
                                <div class="flex-1 bg-cyan-500/60 rounded-t" style="height: 100%"></div>
                            </div>
                            <p class="text-xs text-[var(--color-text-muted)]">Equal capital per order. Predictable and simple.</p>
                        </div>
                        <div class="p-4 rounded-lg bg-[var(--color-card-muted)] border border-[var(--color-border)]">
                            <p class="font-medium text-[var(--color-text)] text-sm mb-2">Martingale (Weighted)</p>
                            <div class="flex items-end gap-1 h-12 mb-2">
                                <div class="flex-1 bg-orange-500/60 rounded-t" style="height: 30%"></div>
                                <div class="flex-1 bg-orange-500/60 rounded-t" style="height: 50%"></div>
                                <div class="flex-1 bg-orange-500/60 rounded-t" style="height: 70%"></div>
                                <div class="flex-1 bg-orange-500/60 rounded-t" style="height: 85%"></div>
                                <div class="flex-1 bg-orange-500/60 rounded-t" style="height: 100%"></div>
                            </div>
                            <p class="text-xs text-[var(--color-text-muted)]">Larger orders at better prices. Higher risk, higher reward.</p>
                        </div>
                    </div>
                </div>

                <!-- Pro Tips -->
                <div class="p-4 bg-gradient-to-r from-cyan-500/10 to-blue-500/10 rounded-lg border border-cyan-500/20">
                    <h4 class="font-semibold text-cyan-400 text-sm mb-3 flex items-center gap-2">
                        <span>üí°</span> Pro Tips
                    </h4>
                    <ul class="space-y-2 text-xs text-[var(--color-text-secondary)]">
                        <li class="flex gap-2">
                            <span class="text-cyan-400">‚Ä¢</span>
                            <span>Start with <strong>Linear allocation</strong> if you're new ‚Äî it's easier to understand and manage</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-cyan-400">‚Ä¢</span>
                            <span>Use <strong>Sell-Only mode</strong> when you already hold assets and want to plan profit-taking</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-cyan-400">‚Ä¢</span>
                            <span>Check your exchange's <strong>minimum order size</strong> before setting too many orders</span>
                        </li>
                        <li class="flex gap-2">
                            <span class="text-cyan-400">‚Ä¢</span>
                            <span>The <strong>charts</strong> help visualize how your capital is distributed across price levels</span>
                        </li>
                    </ul>
                </div>

                <!-- Quick Glossary -->
                <div class="space-y-3">
                    <h4 class="text-lg font-semibold text-[var(--color-text)] flex items-center gap-2">
                        <span class="w-7 h-7 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-sm">üìñ</span>
                        Quick Glossary
                    </h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 pl-9 text-xs">
                        <div class="flex gap-2">
                            <span class="text-red-400 font-medium min-w-[80px]">Buy Ladder:</span>
                            <span class="text-[var(--color-text-muted)]">Series of buy orders at decreasing prices</span>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-green-400 font-medium min-w-[80px]">Sell Ladder:</span>
                            <span class="text-[var(--color-text-muted)]">Series of sell orders at increasing prices</span>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-yellow-400 font-medium min-w-[80px]">Spread:</span>
                            <span class="text-[var(--color-text-muted)]">Price range your orders will cover (%)</span>
                        </div>
                        <div class="flex gap-2">
                            <span class="text-purple-400 font-medium min-w-[80px]">DCA:</span>
                            <span class="text-[var(--color-text-muted)]">Dollar Cost Averaging across price levels</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-6 border-t border-[var(--color-border)] bg-[var(--color-card-muted)]">
                <button id="how-it-works-close" class="btn-primary w-full py-3.5 sm:py-3 rounded-lg text-sm font-semibold bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-400 hover:to-blue-400 active:scale-[0.98] transition-all">
                    Got It ‚Äî Let's Start Planning!
                </button>
            </div>
        </div>
    </div>

    <!-- Question-Based Setup Wizard -->
    <div id="setup-wizard" class="fixed inset-0 z-[10000] bg-black backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none" role="dialog" aria-labelledby="wizard-title" aria-modal="true">
        <div class="bg-[var(--color-card)] rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" style="transform: scale(0.95); transition: transform 0.4s ease;">
            <div class="p-6 sm:p-8">
                <!-- Header with gradient accent -->
                <div class="mb-6 pb-4 border-b border-[var(--color-border)]">
                    <h2 id="wizard-title" class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 font-solana mb-2">
                        Trading Plan Setup
                    </h2>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-xs font-medium text-[var(--color-text-muted)]" aria-live="polite">
                            Step <span id="wizard-step-num">1</span> of <span id="wizard-total-steps">7</span>
                        </span>
                        <button id="wizard-skip" class="text-xs text-[var(--color-text-muted)] hover:text-cyan-400 active:text-cyan-300 transition-all focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2 rounded px-3 py-1.5 active:scale-95" aria-label="Skip setup wizard">
                            Skip Setup
                        </button>
                    </div>
                    <div class="w-full bg-[var(--color-card-muted)] rounded-full h-2.5 overflow-hidden mt-3">
                        <div id="wizard-progress" class="h-full rounded-full transition-all duration-300" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <!-- Question Content -->
                <div id="wizard-content" class="space-y-6" role="region" aria-live="polite">
                    <!-- Question will be dynamically inserted here -->
                </div>

                <!-- Error Message -->
                <div id="wizard-error" class="wizard-error" role="alert" aria-live="assertive"></div>

                <!-- Navigation Buttons -->
                <div class="flex flex-col-reverse sm:flex-row justify-between items-stretch sm:items-center gap-3 sm:gap-4 mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-[var(--color-border)]">
                    <button id="wizard-back" class="w-full sm:w-auto px-4 sm:px-6 py-3 sm:py-2.5 rounded-lg bg-[var(--color-card-alt)] text-[var(--color-text)] hover:bg-[var(--color-border)] active:scale-95 transition-all font-medium text-sm hidden focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2" aria-label="Go to previous question">
                        ‚Üê Back
                    </button>
                    <div class="hidden sm:block flex-1"></div>
                    <button id="wizard-next" class="w-full sm:w-auto px-6 sm:px-8 py-3 sm:py-2.5 rounded-lg bg-gradient-to-r from-cyan-400 to-blue-600 text-white hover:from-cyan-500 hover:to-blue-700 active:scale-95 transition-all font-medium text-sm shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-cyan-400 focus:ring-offset-2">
                        Next ‚Üí
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Value copied!</div>

    <!-- QR Modal -->
    <div id="qr-modal" class="qr-modal">
        <div class="qr-backdrop" id="qr-backdrop"></div>
        <div class="qr-content flex flex-col items-center gap-5">
            <div class="text-center space-y-2">
                <h3 class="text-lg font-bold text-[var(--color-text)] font-solana">Fuel the Development</h3>
                <p class="text-sm text-[var(--color-text-secondary)] leading-relaxed max-w-[280px]">
                    If Order Skew brings value to your trading, consider supporting its development. Every contribution helps keep the platform free and evolving.
                </p>
            </div>
            
            <div class="bg-white p-1.5 rounded-xl border border-[var(--color-border)] shadow-sm inline-block overflow-hidden">
                 <img src="https://raw.githubusercontent.com/yanniedog/OrderSkew/main/QRcode.jpg" 
                      alt="Donate SOL" 
                      class="w-40 h-40 object-contain" 
                      style="transform: scale(1.15);"
                      onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'text-xs text-red-500\'>QR Not Found</span>'"> 
            </div>

            <div class="w-full space-y-3">
                <div class="flex items-center justify-center gap-2">
                    <img src="https://cryptologos.cc/logos/solana-sol-logo.svg" 
                         alt="Solana" 
                         class="h-5 w-auto object-contain"
                         onerror="this.style.display='none'">
                    <span class="text-xs font-bold text-[var(--color-text-secondary)] uppercase tracking-widest font-solana">Solana Network</span>
                </div>

                <div class="relative group cursor-pointer transition-all" onclick="App.copy('F6mjNXKBKzjmKTK1Z9cWabFHZYtxMg8rojuNuppX2EG1')" title="Click to copy">
                    <div class="absolute inset-0 bg-[var(--color-card-muted)] rounded-lg border border-[var(--color-border)] group-hover:border-[var(--color-primary)] transition-colors"></div>
                    <code class="relative z-10 block text-[10px] sm:text-[11px] text-[var(--color-text-muted)] font-mono break-all p-3 text-center group-hover:text-[var(--color-text)] transition-colors">
                        F6mjNXKBKzjmKTK1Z9cWabFHZYtxMg8rojuNuppX2EG1
                    </code>
                </div>
            </div>
            
            <button id="qr-close" class="btn-secondary w-full py-3 sm:py-2.5 rounded-lg text-sm font-medium hover:bg-[var(--color-border)] active:scale-[0.98] transition-all">Close</button>
        </div>
    </div>

    <!-- Video Modal -->
    <div id="video-modal" class="qr-modal">
        <div class="qr-backdrop" id="video-backdrop"></div>
        <div class="qr-content w-full max-w-3xl p-0 bg-black overflow-hidden flex flex-col" style="max-width: 600px;">
            <div class="relative pb-[56.25%] h-0">
                <iframe class="absolute top-0 left-0 w-full h-full" data-src="https://www.youtube.com/embed/LPaAtWphx2U" title="Order Skew Tutorial" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe>
            </div>
            <button id="video-close" class="w-full py-3.5 sm:py-3 text-sm font-medium bg-[var(--color-card)] text-[var(--color-text)] hover:bg-[var(--color-border)] active:scale-[0.98] transition-all">Close Tutorial</button>
        </div>
    </div>

    <!-- Sticky Mobile Summary -->
    <div id="mobile-sticky-summary" class="mobile-sticky-footer flex-col lg:hidden">
        <div class="w-full flex justify-between items-center">
            <div class="flex flex-col">
                <span class="text-[10px] text-[var(--color-text-secondary)] font-medium uppercase tracking-wider">Net Profit</span>
                <span id="sticky-net-profit" class="text-base font-bold text-[var(--color-primary)]">-</span>
            </div>
            <button id="sticky-expand-btn" class="p-2.5 text-[var(--color-text-muted)] hover:text-[var(--color-text)] active:scale-90 focus:outline-none transition-all rounded-full hover:bg-[var(--color-card-alt)]">
                <svg id="sticky-chevron" class="w-5 h-5 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>
            </button>
            <div class="flex flex-col items-end">
                 <span class="text-[10px] text-[var(--color-text-secondary)] font-medium uppercase tracking-wider">ROI</span>
                 <span id="sticky-roi" class="text-base font-bold text-green-600">-</span>
            </div>
        </div>
        
        <!-- Expanded Details -->
        <div id="sticky-details" class="hidden w-full pt-3 mt-2 border-t border-[var(--color-border)] grid grid-cols-2 gap-y-3 gap-x-4 text-xs animate-fade-in">
            <div>
                <span class="text-[var(--color-text-muted)]">Avg Buy:</span>
                <span id="sticky-avg-buy" class="float-right font-mono font-medium text-[var(--color-text)]">-</span>
            </div>
            <div>
                <span class="text-[var(--color-text-muted)]">Avg Sell:</span>
                <span id="sticky-avg-sell" class="float-right font-mono font-medium text-[var(--color-text)]">-</span>
            </div>
            <div>
                <span class="text-[var(--color-text-muted)]">Fees:</span>
                <span id="sticky-fees" class="float-right font-mono font-medium text-[var(--color-text)]">-</span>
            </div>
            <div>
                <span class="text-[var(--color-text-muted)]">Vol:</span>
                <span id="sticky-vol" class="float-right font-mono font-medium text-[var(--color-text)]">-</span>
            </div>
            <div>
                <span class="text-[var(--color-text-muted)]">Floor:</span>
                <span id="sticky-floor" class="float-right font-mono font-medium text-[var(--color-text)]">-</span>
            </div>
            <div>
                <span class="text-[var(--color-text-muted)]">Ceiling:</span>
                <span id="sticky-ceiling" class="float-right font-mono font-medium text-[var(--color-text)]">-</span>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="relative z-40 flex flex-col md:flex-row md:items-center justify-between gap-4 animate-fade-in">
            <div>
                <div class="flex items-center gap-2">
                    <h1 id="logo-header" class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-secondary)] font-solana cursor-pointer hover:opacity-80 transition-opacity">
                        ORDER SKEW
                    </h1>
                </div>
                <p class="text-sm text-[var(--color-text-secondary)] mt-1">Plan your trades.<br><span class="text-xs">Buy <span class="bg-red-500/30 text-white px-1.5 py-0.5 rounded text-[10px]">low</span>, sell <span class="bg-green-500/30 text-white px-1.5 py-0.5 rounded text-[10px]">high</span>.</span></p>
            </div>

            <div class="flex flex-wrap items-center justify-end gap-2 sm:gap-3">
                <!-- Video Tutorial -->
                <button id="video-btn" class="hidden sm:flex items-center gap-1.5 px-3 py-2 rounded-full bg-[var(--color-primary)] text-[var(--color-primary-contrast)] hover:bg-[var(--color-primary-accent)] active:scale-95 transition-all text-xs font-medium shadow-sm" title="Watch Tutorial">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>Tutorial</span>
                </button>
                <button id="video-btn-mobile" class="sm:hidden p-2.5 rounded-full bg-[var(--color-card-alt)] text-[var(--color-text-muted)] hover:text-[var(--color-primary)] hover:bg-[var(--color-border)] active:scale-90 transition-all" title="Watch Tutorial">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </button>

                <!-- Solana Donation -->
                <button id="sol-btn" class="p-2.5 rounded-full bg-[var(--color-card-alt)] text-[var(--color-text-muted)] hover:text-[#9945FF] hover:bg-[var(--color-border)] active:scale-90 transition-all" title="Donate SOL">
                    <svg viewBox="0 0 397.7 311.7" class="w-5 h-5" fill="currentColor"><path d="M64.6 237.9c2.4-2.4 5.7-3.8 9.2-3.8h317.4c5.8 0 8.7 7 4.6 11.1l-62.7 62.7c-2.4 2.4-5.7 3.8-9.2 3.8H6.5c-5.8 0-8.7-7-4.6-11.1l62.7-62.7z"/><path d="M64.6 3.8C67.1 1.4 70.4 0 73.8 0h317.4c5.8 0 8.7 7 4.6 11.1l-62.7 62.7c-2.4 2.4-5.7 3.8-9.2 3.8H6.5c-5.8 0-8.7-7-4.6-11.1L64.6 3.8z"/><path d="M333.1 120.1c-2.4-2.4-5.7-3.8-9.2-3.8H6.5c-5.8 0-8.7 7 4.6 11.1l62.7 62.7c2.4 2.4 5.7 3.8 9.2 3.8h317.4c5.8 0 8.7-7 4.6-11.1l-62.7-62.7z"/></svg>
                </button>

                <!-- GitHub -->
                <a href="https://github.com/yanniedog/OrderSkew" target="_blank" rel="noopener" class="p-2.5 rounded-full bg-[var(--color-card-alt)] text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-border)] active:scale-90 transition-all" title="View on GitHub">
                    <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                </a>

                <!-- Theme Toggle -->
                <button id="theme-toggle-btn" class="p-2.5 rounded-full bg-[var(--color-card-alt)] text-[var(--color-text)] hover:bg-[var(--color-border)] active:scale-90 transition-all" aria-label="Toggle Theme">
                    <svg id="icon-sun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
                    <svg id="icon-moon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                
                <!-- Export/Actions Menu -->
                <div class="relative group z-50">
                    <button class="btn-secondary flex items-center gap-1.5 sm:gap-2 px-3 sm:px-4 py-2.5 sm:py-2 rounded-lg text-xs sm:text-sm font-medium shadow-sm active:scale-95 transition-all">
                        <span>Export</span>
                        <svg class="w-3 h-3 sm:w-4 sm:h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-[var(--color-card)] border border-[var(--color-border)] rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top-right">
                        <div class="py-1">
                            <button type="button" id="download-csv-btn" class="block w-full text-left px-4 py-2.5 sm:py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-card-alt)] active:bg-[var(--color-border)]">Download CSV</button>
                            <button type="button" id="save-config-btn" class="block w-full text-left px-4 py-2.5 sm:py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-card-alt)] active:bg-[var(--color-border)]">Save Config</button>
                            <label class="block w-full text-left px-4 py-2.5 sm:py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-card-alt)] active:bg-[var(--color-border)] cursor-pointer">
                                Load Config <input type="file" id="load-config-file" accept=".json" class="hidden">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main id="main-content-grid" class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Column: Controls (lg:col-span-4) -->
            <div id="config-column" class="lg:col-span-5 space-y-6">
                
                <!-- Input Form Card -->
                <div class="card p-5 sm:p-6 animate-fade-in" style="animation-delay: 0.1s;">
                    <div class="flex justify-between items-center mb-5">
                        <h2 class="text-lg font-semibold text-[var(--color-primary)] flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                            Strategy
                        </h2>
                        <div class="flex items-center bg-[var(--color-card-muted)] rounded-lg p-0.5 sm:p-1 border border-[var(--color-border)]">
                            <button id="mode-simple" class="px-2.5 sm:px-3 py-1.5 sm:py-1 text-[10px] sm:text-xs font-medium rounded-md transition-all shadow-sm bg-[var(--color-card)] text-[var(--color-primary)] active:scale-95">Current</button>
                            <button id="mode-pro" class="px-2.5 sm:px-3 py-1.5 sm:py-1 text-[10px] sm:text-xs font-medium rounded-md transition-all text-[var(--color-text-secondary)] hover:text-[var(--color-text)] active:scale-95">Customise</button>
                        </div>
                    </div>
                    
                    <form id="trading-plan-form" class="space-y-6" onsubmit="return false;">
                        
                        <!-- Mode Selector (Buy vs Sell-Only) -->
                        <div id="mode-selector" class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">
                            <button type="button" id="mode-buy-btn" class="mode-card active relative p-3 sm:p-4 rounded-xl border-2 border-red-500/50 bg-red-500/10 transition-all hover:border-red-500 active:scale-[0.98] group">
                                <div class="flex items-center gap-2.5 sm:gap-3">
                                    <div class="w-9 h-9 sm:w-10 sm:h-10 rounded-lg bg-red-500/20 flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                                    </div>
                                    <div class="text-left min-w-0">
                                        <div class="font-semibold text-red-500 text-xs sm:text-sm">Buy Mode</div>
                                        <div class="text-[9px] sm:text-[10px] text-[var(--color-text-muted)] truncate">Build buy & sell ladders</div>
                                    </div>
                                </div>
                                <div class="absolute top-1.5 right-1.5 sm:top-2 sm:right-2 w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-red-500 text-white flex items-center justify-center opacity-100 transition-opacity" id="mode-buy-check">
                                    <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                            </button>
                            <button type="button" id="mode-sell-btn" class="mode-card relative p-3 sm:p-4 rounded-xl border-2 border-[var(--color-border)] bg-[var(--color-card-muted)] transition-all hover:border-green-500/50 active:scale-[0.98] group">
                                <div class="flex items-center gap-2.5 sm:gap-3">
                                    <div class="w-9 h-9 sm:w-10 sm:h-10 rounded-lg bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                        <svg class="w-4 h-4 sm:w-5 sm:h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <div class="text-left min-w-0">
                                        <div class="font-semibold text-green-500 text-xs sm:text-sm">Sell Mode</div>
                                        <div class="text-[9px] sm:text-[10px] text-[var(--color-text-muted)] truncate">Plan exits for holdings</div>
                                    </div>
                                </div>
                                <div class="absolute top-1.5 right-1.5 sm:top-2 sm:right-2 w-4 h-4 sm:w-5 sm:h-5 rounded-full bg-green-500 text-white flex items-center justify-center opacity-0 transition-opacity" id="mode-sell-check">
                                    <svg class="w-2.5 h-2.5 sm:w-3 sm:h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                </div>
                            </button>
                        </div>
                        
                        <!-- Market Data Group (Always Visible) -->
                        <div class="space-y-4">
                            <!-- Buy Mode Inputs -->
                            <div id="buy-mode-inputs" class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="flex items-center gap-1 mb-1.5">
                                        <label class="text-xs font-medium text-[var(--color-text-secondary)]" id="starting_capital_label">Initial Capital ($)</label>
                                        <button type="button" class="helper-tooltip" title="Total amount of capital available to deploy for this plan.">?</button>
                                    </div>
                                    <div class="relative flex items-center">
                                        <span class="absolute left-3 text-[var(--color-text-secondary)] font-mono">$</span>
                                        <input type="text" id="starting_capital" value="10,000" class="form-input w-full rounded-lg p-2.5 font-mono pl-7">
                                    </div>
                                </div>
                                <div>
                                    <div class="flex items-center gap-1 mb-1.5">
                                        <label class="block text-xs font-medium text-[var(--color-text-secondary)]">Asset Price ($)</label>
                                        <button type="button" class="helper-tooltip" title="Current market price of the asset used as a baseline.">?</button>
                                    </div>
                                    <div class="relative flex items-center">
                                        <span class="absolute left-3 text-[var(--color-text-secondary)] font-mono">$</span>
                                        <input type="text" id="current_price" value="100" class="form-input w-full rounded-lg p-2.5 font-mono pl-7">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sell Mode Inputs (Hidden by default) -->
                            <div id="sell-mode-inputs" class="hidden space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="flex items-center gap-1 mb-1.5">
                                            <label class="text-xs font-medium text-[var(--color-text-secondary)]">Held Quantity</label>
                                            <button type="button" class="helper-tooltip" title="The amount of the asset you currently possess.">?</button>
                                        </div>
                                        <input type="number" id="existing_quantity" value="50" class="form-input w-full rounded-lg p-2.5 font-mono">
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-1 mb-1.5">
                                            <label class="text-xs font-medium text-[var(--color-text-secondary)]">Asset Price ($)</label>
                                            <button type="button" class="helper-tooltip" title="Current market price of the asset.">?</button>
                                        </div>
                                        <div class="relative flex items-center">
                                            <span class="absolute left-3 text-[var(--color-text-secondary)] font-mono">$</span>
                                            <input type="text" id="current_price_sell" value="100" class="form-input w-full rounded-lg p-2.5 font-mono pl-7">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <div class="flex items-center gap-1 mb-1.5">
                                        <label class="text-xs font-medium text-[var(--color-text-secondary)]">Average Cost Basis ($)</label>
                                        <button type="button" class="helper-tooltip" title="Your average buy price for the assets you hold.">?</button>
                                    </div>
                                    <div class="relative flex items-center">
                                        <span class="absolute left-3 text-[var(--color-text-secondary)] font-mono">$</span>
                                        <input type="number" id="existing_avg_price" value="80" class="form-input w-full rounded-lg p-2.5 font-mono pl-7">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden checkbox for compatibility -->
                        <input type="checkbox" id="sell_only_mode" class="hidden">

                        <!-- Pro Controls Container -->
                        <div id="pro-controls" class="hidden space-y-4 pt-4 border-t border-[var(--color-border)]">

                            <!-- Section 1: Order Structure -->
                            <details class="group bg-[var(--color-card-muted)] rounded-lg border border-[var(--color-border)] overflow-hidden" open>
                                <summary class="flex items-center justify-between cursor-pointer px-4 py-3 bg-[var(--color-card-alt)] hover:bg-[var(--color-border)] transition-colors">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"></path></svg>
                                        <span class="text-sm font-semibold text-[var(--color-text)]">Order Structure</span>
                            </div>
                                    <svg class="w-4 h-4 text-[var(--color-text-muted)] transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </summary>
                                <div class="p-4 space-y-4">
                                    <!-- Number of Orders -->
                            <div>
                                <div class="flex justify-between mb-1.5">
                                    <div class="flex items-center gap-1">
                                                <label class="text-xs font-medium text-[var(--color-text-secondary)]">Number of Orders</label>
                                        <button type="button" class="helper-tooltip" title="How many separate buy/sell orders (rungs) to place in the ladder.">?</button>
                                    </div>
                                            <span id="number_of_rungs_display" class="text-xs font-mono font-bold text-[var(--color-primary)]">10</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" id="number_of_rungs" min="2" max="50" value="10" class="flex-1">
                                            <input type="number" id="number_of_rungs_input" value="10" min="2" max="50" class="form-input w-14 rounded-md p-1 text-center text-xs">
                                </div>
                            </div>

                                    <!-- Spacing Mode -->
                            <div>
                                        <div class="flex items-center gap-1 mb-1.5">
                                            <label class="text-xs font-medium text-[var(--color-text-secondary)]">Spacing Mode</label>
                                            <button type="button" class="helper-tooltip" title="'Absolute' means equal dollar distance between orders. 'Relative' means geometric progression (percentage distance).">?</button>
                                    </div>
                                        <select id="spacing_mode" class="form-input w-full rounded-lg p-2 text-sm">
                                            <option value="absolute">Absolute (Equal Steps)</option>
                                            <option value="relative">Relative (Geometric %)</option>
                                        </select>
                                    </div>
                                </div>
                            </details>

                            <!-- Section 2: Price Range -->
                            <details class="group bg-[var(--color-card-muted)] rounded-lg border border-[var(--color-border)] overflow-hidden" open>
                                <summary class="flex items-center justify-between cursor-pointer px-4 py-3 bg-[var(--color-card-alt)] hover:bg-[var(--color-border)] transition-colors">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                                        <span class="text-sm font-semibold text-[var(--color-text)]">Price Range</span>
                                    </div>
                                    <svg class="w-4 h-4 text-[var(--color-text-muted)] transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </summary>
                                <div class="p-4 space-y-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-xs text-[var(--color-text-muted)]">Range Type</span>
                                        <select id="price_range_mode" class="bg-[var(--color-card)] text-xs font-medium text-[var(--color-primary)] border border-[var(--color-border)] rounded-md px-2 py-1 focus:ring-1 focus:ring-[var(--color-primary)] cursor-pointer">
                                        <option value="width">Percentage (%)</option>
                                        <option value="floor">Fixed Price Range</option>
                                    </select>
                                </div>
                                
                                <div id="width-mode-container">
                                    <div class="flex items-center gap-3">
                                        <input type="range" id="depth" min="0.1" max="99" step="0.1" value="20" class="flex-1">
                                        <div class="relative">
                                                <input type="number" id="depth_input" value="20" step="0.1" class="form-input w-16 rounded-md p-1.5 text-center text-xs pr-5">
                                                <span class="absolute right-2 top-1/2 -translate-y-1/2 text-[10px] text-[var(--color-text-muted)]">%</span>
                                        </div>
                                    </div>
                                </div>

                                    <div id="floor-mode-container" class="hidden grid grid-cols-2 gap-3">
                                    <div>
                                        <div class="flex items-center gap-1 mb-1">
                                                <label class="text-[10px] text-[var(--color-text-muted)]">Buy Floor</label>
                                            <button type="button" class="helper-tooltip" title="The price of the absolute lowest buy order.">?</button>
                                        </div>
                                        <div class="relative flex items-center">
                                            <span class="absolute left-2 text-[var(--color-text-secondary)] font-mono text-xs">$</span>
                                                <input type="number" id="buy_floor" class="form-input w-full rounded-lg p-2 text-xs pl-6" placeholder="Low">
                                        </div>
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-1 mb-1">
                                                <label class="text-[10px] text-[var(--color-text-muted)]">Sell Ceiling</label>
                                            <button type="button" class="helper-tooltip" title="The price of the absolute highest sell order.">?</button>
                                        </div>
                                        <div class="relative flex items-center">
                                            <span class="absolute left-2 text-[var(--color-text-secondary)] font-mono text-xs">$</span>
                                                <input type="number" id="sell_ceiling" class="form-input w-full rounded-lg p-2 text-xs pl-6" placeholder="High">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </details>

                            <!-- Section 3: Allocation -->
                            <details class="group bg-[var(--color-card-muted)] rounded-lg border border-[var(--color-border)] overflow-hidden" open>
                                <summary class="flex items-center justify-between cursor-pointer px-4 py-3 bg-[var(--color-card-alt)] hover:bg-[var(--color-border)] transition-colors">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                                        <span class="text-sm font-semibold text-[var(--color-text)]">Allocation</span>
                                    </div>
                                    <svg class="w-4 h-4 text-[var(--color-text-muted)] transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </summary>
                                <div class="p-4 space-y-4">
                            <!-- Skew -->
                            <div>
                                <div class="flex justify-between mb-1.5">
                                    <div class="flex items-center gap-1">
                                                <label class="text-xs font-medium text-[var(--color-text-secondary)]">Capital Skew</label>
                                        <button type="button" class="helper-tooltip" title="Adjusts capital distribution. 'Flat' means equal distribution. 'Curved' allocates more capital to lower buy prices (martingale style).">?</button>
                                    </div>
                                            <span class="text-xs font-medium text-[var(--color-primary)]" id="skew_label">Moderate</span>
                                </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-[9px] font-bold text-[var(--color-text-muted)] w-8">FLAT</span>
                                    <input type="range" id="skew_value" min="0" max="100" value="50" class="flex-1">
                                            <span class="text-[9px] font-bold text-[var(--color-text-muted)] w-12 text-right">CURVED</span>
                                    <input type="number" id="skew_value_input" min="0" max="100" value="50" class="form-input w-14 rounded-md p-1 text-center text-xs hidden">
                                </div>
                            </div>

                                    <!-- Equal Quantity -->
                                    <div class="flex items-center gap-2 p-2 bg-[var(--color-card)] rounded-lg border border-[var(--color-border)]">
                                        <input type="checkbox" id="equal_quantity_mode" class="rounded border-gray-300 text-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                                        <div class="flex items-center gap-1 flex-1">
                                            <label for="equal_quantity_mode" class="text-xs text-[var(--color-text)]">Force Equal Quantity</label>
                                            <button type="button" class="helper-tooltip" title="Overrides skew settings to buy/sell the exact same amount of asset at every rung.">?</button>
                                        </div>
                                    </div>
                                </div>
                            </details>

                            <!-- Section 4: Fees -->
                            <details class="group bg-[var(--color-card-muted)] rounded-lg border border-[var(--color-border)] overflow-hidden">
                                <summary class="flex items-center justify-between cursor-pointer px-4 py-3 bg-[var(--color-card-alt)] hover:bg-[var(--color-border)] transition-colors">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4 text-[var(--color-primary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                        <span class="text-sm font-semibold text-[var(--color-text)]">Fees</span>
                                    </div>
                                    <svg class="w-4 h-4 text-[var(--color-text-muted)] transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </summary>
                                <div class="p-4 space-y-4">
                                    <!-- Fee Type & Value -->
                            <div>
                                <div class="flex items-center gap-1 mb-1.5">
                                            <label class="text-xs font-medium text-[var(--color-text-secondary)]">Trading Fee</label>
                                    <button type="button" class="helper-tooltip" title="Trading fee as a percentage or fixed dollar amount per trade.">?</button>
                                </div>
                                <div class="flex items-center gap-2">
                                            <div class="flex rounded-lg border border-[var(--color-border)] overflow-hidden bg-[var(--color-card)]">
                                        <button type="button" id="fee_type_percent" class="fee-type-btn active px-3.5 sm:px-3 py-2.5 sm:py-2 text-xs font-medium transition-all active:scale-95" data-value="percent">%</button>
                                        <button type="button" id="fee_type_fixed" class="fee-type-btn px-3.5 sm:px-3 py-2.5 sm:py-2 text-xs font-medium transition-all active:scale-95" data-value="fixed">$</button>
                                    </div>
                                    <div class="relative flex items-center flex-1">
                                        <span id="fee_dollar_prefix" class="absolute left-3 text-[var(--color-text-secondary)] font-mono hidden">$</span>
                                                <input type="number" id="fee_value" value="0.1" step="0.01" class="form-input w-full rounded-lg p-2 font-mono text-sm">
                                    </div>
                                    <input type="hidden" id="fee_type" value="percent">
                            </div>
                        </div>

                                    <!-- Fee Settlement -->
                                    <div>
                                        <div class="flex items-center gap-1 mb-1.5">
                                            <label class="text-xs font-medium text-[var(--color-text-secondary)]">Settlement</label>
                                        <button type="button" class="helper-tooltip" title="'Net' means fees reduce the asset received. 'External' means fees are paid from a separate cash balance.">?</button>
                                    </div>
                                        <select id="fee_settlement" class="form-input w-full rounded-lg p-2 text-sm">
                                        <option value="netted">Net (Deduct from Order)</option>
                                        <option value="external">External (Separate Funds)</option>
                                    </select>
                                </div>
                                    </div>
                            </details>

                        </div> <!-- End Pro Controls -->

                    </form>
                </div>

            </div>

            <!-- Right Column: Visualization (lg:col-span-8) -->
            <div id="graph-column" class="lg:col-span-7 space-y-6">
                
                <!-- Combined Depth Chart (Vertical) -->
                <div id="depth-chart-card" class="card p-4 h-[600px] flex flex-col animate-fade-in relative z-0" style="animation-delay: 0.3s;">
                    <div class="flex flex-wrap justify-between items-center gap-2 mb-3">
                        <div id="chart-legend" class="flex items-center gap-3 text-xs">
                            <span id="chart-buy-legend" class="chart-buy-legend buy-only-content inline-flex items-center gap-1 text-[var(--color-text-secondary)]">
                                <span class="inline-block w-2 h-2 rounded-full bg-red-500"></span> Buy
                            </span>
                            <span class="inline-flex items-center gap-1 text-[var(--color-text-secondary)]">
                                <span class="inline-block w-2 h-2 rounded-full bg-green-500"></span> Sell
                            </span>
                        </div>
                        
                        <!-- Chart Display Options -->
                        <div class="flex flex-wrap items-center gap-2 sm:gap-4 text-[10px]">
                            <!-- Layer Toggles -->
                            <div class="flex items-center gap-2 sm:gap-3">
                                <label class="flex items-center gap-1.5 cursor-pointer select-none py-1 px-0.5">
                                    <input type="checkbox" id="chart-show-bars" checked class="w-4 h-4 sm:w-3 sm:h-3 rounded border-[var(--color-border-strong)] text-[var(--color-primary)] focus:ring-[var(--focus-ring-color)]">
                                    <span class="text-[var(--color-text-secondary)]">Bars</span>
                                </label>
                                <label class="flex items-center gap-1.5 cursor-pointer select-none py-1 px-0.5">
                                    <input type="checkbox" id="chart-show-cumulative" checked class="w-4 h-4 sm:w-3 sm:h-3 rounded border-[var(--color-border-strong)] text-[var(--color-primary)] focus:ring-[var(--focus-ring-color)]">
                                    <span class="text-[var(--color-text-secondary)]">Cumulative</span>
                                </label>
                            </div>
                            
                            <!-- Value Type Toggle -->
                            <div class="flex items-center gap-1.5">
                                <span class="text-[var(--color-text-muted)] hidden sm:inline">Units:</span>
                                <div class="flex rounded-md border border-[var(--color-border)] overflow-hidden bg-[var(--color-card-muted)]">
                                    <button type="button" id="chart-unit-volume" class="chart-toggle-btn active px-2.5 sm:px-2 py-1.5 sm:py-1 text-[10px] font-medium transition-all active:scale-95" title="Asset quantity (volume)">Volume</button>
                                    <button type="button" id="chart-unit-value" class="chart-toggle-btn px-2.5 sm:px-2 py-1.5 sm:py-1 text-[10px] font-medium transition-all active:scale-95" title="Dollar value">Value ($)</button>
                                </div>
                            </div>
                        </div>
                        
                        <span id="mid-price-label" class="text-xs text-[var(--color-text-muted)]"></span>
                    </div>
                    <div id="depth-wrapper" class="d3-chart flex-1 w-full h-full relative">
                        <svg id="depth-chart" width="100%" height="100%"></svg>
                        
                        <!-- Projected Results Overlay (Middle Right) -->
                        <div id="chart-summary-overlay" class="absolute top-1/2 right-4 transform -translate-y-1/2 pointer-events-none z-10">
                            <div class="bg-[var(--color-card)]/95 backdrop-blur-sm border border-[var(--color-border)] rounded-lg p-3 shadow-xl min-w-[180px] max-w-[200px]">
                                <h4 class="text-[10px] font-bold text-[var(--color-text-muted)] uppercase tracking-wider mb-2">Projected Results</h4>
                                <div class="space-y-2.5">
                                    <div>
                                        <p class="text-[9px] text-[var(--color-text-secondary)]">Net Profit</p>
                                        <p id="chart-summary-net-profit" class="text-lg font-bold text-[var(--color-primary)]">-</p>
                                    </div>
                                    <div>
                                        <p class="text-[9px] text-[var(--color-text-secondary)]">ROI</p>
                                        <p id="chart-summary-roi" class="text-lg font-bold text-green-600">-</p>
                                    </div>
                                    <div class="pt-2 border-t border-[var(--color-border)]">
                                        <p class="text-[9px] text-[var(--color-text-secondary)]">Avg Buy</p>
                                        <p id="chart-summary-avg-buy" class="text-sm font-semibold text-[var(--color-text)]">-</p>
                                    </div>
                                    <div>
                                        <p class="text-[9px] text-[var(--color-text-secondary)]">Avg Sell</p>
                                        <p id="chart-summary-avg-sell" class="text-sm font-semibold text-[var(--color-text)]">-</p>
                                    </div>
                                    <div class="pt-2 border-t border-[var(--color-border)] text-[9px] text-[var(--color-text-muted)] space-y-1">
                                        <div class="flex justify-between">
                                            <span>Fees:</span>
                                            <span id="chart-summary-total-fees">-</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Vol:</span>
                                            <span id="chart-summary-total-quantity">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Tables -->
                <div id="data-tables-card" class="card overflow-hidden animate-fade-in mb-48 lg:mb-8" style="animation-delay: 0.5s;">
                    <div class="border-b border-[var(--color-border)] flex flex-col sm:flex-row justify-between items-stretch sm:items-center bg-[var(--color-card-alt)]">
                        <div id="table-tabs" class="flex flex-1">
                            <button id="tab-buy" class="buy-only-content flex-1 py-3.5 sm:py-3 text-xs sm:text-sm font-medium text-[var(--color-primary)] border-b-2 border-[var(--color-primary)] bg-[var(--color-card-alt)] active:opacity-80 transition-opacity">Buy Orders</button>
                            <button id="tab-sell" class="flex-1 py-3.5 sm:py-3 text-xs sm:text-sm font-medium text-[var(--color-text-muted)] hover:text-[var(--color-text)] active:opacity-80 transition-opacity">Sell Orders</button>
                        </div>
                        <div class="px-3 sm:px-4 py-2 sm:py-0 flex items-center justify-center sm:justify-end gap-2 border-t sm:border-t-0 border-[var(--color-border)]">
                            <input type="checkbox" id="show-fees-toggle" class="w-4 h-4 sm:w-3.5 sm:h-3.5 rounded border-[var(--color-border-strong)] text-[var(--color-primary)] focus:ring-[var(--focus-ring-color)]">
                            <label for="show-fees-toggle" class="text-xs font-medium text-[var(--color-text-secondary)] cursor-pointer select-none">Show Fees</label>
                        </div>
                    </div>
                    
                    <div class="relative w-full overflow-x-auto pb-32 lg:pb-8">
                        <div id="panel-buy" class="p-0">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="table-header text-xs uppercase">
                                    <tr>
                                        <th class="px-4 py-3">#</th>
                                        <th class="px-4 py-3 text-right">Price</th>
                                        <th class="px-4 py-3 text-right">Vol</th>
                                        <th class="px-4 py-3 text-right">Value ($)</th>
                                        <th class="hidden fee-col px-4 py-3 text-right">Fee</th>
                                        <th class="px-4 py-3 text-right">Avg Price</th>
                                    </tr>
                                </thead>
                                <tbody id="buy-ladder-body" class="divide-y divide-[var(--color-border)]"></tbody>
                            </table>
                        </div>
                        <div id="panel-sell" class="hidden p-0">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="table-header text-xs uppercase">
                                    <tr>
                                        <th class="px-4 py-3">#</th>
                                        <th class="px-4 py-3 text-right">Price</th>
                                        <th class="px-4 py-3 text-right">Vol</th>
                                        <th class="px-4 py-3 text-right">Value ($)</th>
                                        <th class="hidden fee-col px-4 py-3 text-right">Fee</th>
                                        <th class="px-4 py-3 text-right text-green-600">Profit</th>
                                    </tr>
                                </thead>
                                <tbody id="sell-ladder-body" class="divide-y divide-[var(--color-border)]"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Tooltip Element -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- CONSTANTS & UTILS ---
            const CONSTANTS = {
                STORAGE_PREFIX: 'orderskew_v2_',
                MAX_SKEW_RATIO: 10
            };

            const Utils = {
                clamp: (v, min, max) => Math.min(Math.max(v, min), max),
                debounce: (func, wait) => {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                },
                fmtCurr: (n) => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(Number.isFinite(n) ? n : 0),
                fmtNum: (n, d=4) => Number.isFinite(n) ? n.toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:d}) : '0',
                fmtSigFig: (n) => {
                    if (!Number.isFinite(n) || n === 0) return '0';
                    // Use 5 significant figures
                    return new Intl.NumberFormat('en-US', { minimumSignificantDigits: 5, maximumSignificantDigits: 5 }).format(n);
                },
                fmtPct: (n) => Number.isFinite(n) ? n.toFixed(2) + '%' : '0.00%',
                formatNumberWithCommas: (value) => {
                    if (value === null || value === undefined) return '';
                    const strValue = value.toString();
                    if (strValue === '' || strValue === '-' || strValue === '.' || strValue === '-.') {
                        return strValue;
                    }
                    const isNegative = strValue.startsWith('-');
                    const endsWithDot = strValue.endsWith('.');
                    let workingValue = isNegative ? strValue.slice(1) : strValue;
                    const parts = workingValue.split('.');
                    const intPartRaw = parts.shift() || '';
                    const decimalPartRaw = parts.join('');
                    const formattedInt = intPartRaw.replace(/\B(?=(\d{3})+(?!\d))/g, ',') || '0';
                    if (parts.length === 0 && !strValue.includes('.')) {
                        return `${isNegative ? '-' : ''}${formattedInt}`;
                    }
                    if ((parts.length === 0 && strValue.includes('.')) || (parts.length >= 0 && decimalPartRaw.length === 0 && endsWithDot)) {
                        return `${isNegative ? '-' : ''}${formattedInt}.`;
                    }
                    return `${isNegative ? '-' : ''}${formattedInt}.${decimalPartRaw}`;
                },
                stripCommas: (value) => (value ?? '').toString().replace(/,/g, ''),
                sanitizeInput: (value) => {
                    if (value === null || value === undefined) return '';
                    const strValue = value.toString();
                    if (strValue === '' || strValue === '-' || strValue === '.' || strValue === '-.') return strValue;
                    let sanitized = strValue.replace(/,/g, '');
                    let sign = '';
                    if (sanitized.startsWith('-')) { sign = '-'; sanitized = sanitized.slice(1); }
                    sanitized = sanitized.replace(/[^0-9.]/g, '');
                    const hadDecimal = sanitized.includes('.');
                    const parts = sanitized.split('.');
                    const integerPart = parts.shift() || '';
                    const decimalPart = parts.join('');
                    let normalized = sign + integerPart;
                    if (hadDecimal) normalized += '.' + decimalPart;
                    return normalized;
                },
                bindCurrencyInput: (el, callback) => {
                    if (!el) return;
                    el.addEventListener('focus', (e) => { e.target.value = Utils.stripCommas(e.target.value); });
                    el.addEventListener('input', (e) => {
                        const cursorPos = e.target.selectionStart || 0;
                        const valueBefore = e.target.value;
                        const normalized = Utils.sanitizeInput(valueBefore);
                        e.target.value = normalized;
                        const diff = e.target.value.length - valueBefore.length;
                        e.target.setSelectionRange(Math.max(0, cursorPos + diff), Math.max(0, cursorPos + diff));
                        if (callback) callback();
                    });
                    el.addEventListener('blur', (e) => { e.target.value = Utils.formatNumberWithCommas(Utils.sanitizeInput(e.target.value)); });
                },
                bindModal: (modal, openBtns, closeSelectors) => {
                    const toggle = (show) => modal?.classList.toggle('open', show);
                    openBtns.forEach(btn => btn?.addEventListener('click', () => toggle(true)));
                    closeSelectors.forEach(el => el?.addEventListener('click', () => toggle(false)));
                    return toggle;
                },
                hideIntro: (introLayer) => {
                    if (!introLayer) return;
                    introLayer.style.opacity = '0';
                    introLayer.style.pointerEvents = 'none';
                    setTimeout(() => { introLayer.style.display = 'none'; }, 500);
                },
                getSkewLabel: (v) => v === 0 ? "Flat" : v <= 30 ? "Gentle" : v <= 70 ? "Moderate" : "Aggressive",
                copyToClipboard: (text) => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        const t = document.getElementById('toast');
                        t.classList.add('show');
                        setTimeout(() => t.classList.remove('show'), 2000);
                    } catch (err) { console.error('Fallback copy failed', err); }
                    document.body.removeChild(textArea);
                }
            };

            // --- STATE ---
            const State = {
                currentPlanData: null,
                baselineBuySnapshot: null,
                sellOnlyHighestExecuted: null,
                activeTab: 'buy',
                theme: 'light',
                mode: 'simple', // 'simple' or 'pro'
                showFees: false,
                chartShowBars: true,
                chartShowCumulative: true,
                chartUnitType: 'volume', // 'volume' or 'value'
                sellOnlyMode: false
            };

            // --- DOM ELEMENTS ---
            const els = {
                form: document.getElementById('trading-plan-form'),
                // Modes
                modeSimple: document.getElementById('mode-simple'),
                modePro: document.getElementById('mode-pro'),
                proControls: document.getElementById('pro-controls'),
                // Inputs
                startCap: document.getElementById('starting_capital'),
                startCapLabel: document.getElementById('starting_capital_label'),
                currPrice: document.getElementById('current_price'),
                rungs: document.getElementById('number_of_rungs'),
                rungsInput: document.getElementById('number_of_rungs_input'),
                rungsDisplay: document.getElementById('number_of_rungs_display'),
                depth: document.getElementById('depth'),
                depthInput: document.getElementById('depth_input'),
                skew: document.getElementById('skew_value'),
                skewLabel: document.getElementById('skew_label'),
                priceRangeMode: document.getElementById('price_range_mode'),
                widthContainer: document.getElementById('width-mode-container'),
                floorContainer: document.getElementById('floor-mode-container'),
                buyFloor: document.getElementById('buy_floor'),
                sellCeiling: document.getElementById('sell_ceiling'),
                
                // Advanced
                // advCheck: document.getElementById('advanced_mode'), // Removed
                // advPanel: document.getElementById('advanced-settings'), // Just container now
                // advChevron: document.getElementById('adv-chevron'), // Removed
                sellOnlyCheck: document.getElementById('sell_only_mode'),
                sellOnlyInputs: document.getElementById('sell-only-inputs'),
                existQty: document.getElementById('existing_quantity'),
                existAvg: document.getElementById('existing_avg_price'),
                feeType: document.getElementById('fee_type'),
                feeValue: document.getElementById('fee_value'),
                feeSettlement: document.getElementById('fee_settlement'),
                spacingMode: document.getElementById('spacing_mode'),
                equalQtyCheck: document.getElementById('equal_quantity_mode'),

                // Containers
                depthChartCard: document.getElementById('depth-chart-card'),
                
                // Tabs
                tabBuy: document.getElementById('tab-buy'),
                tabSell: document.getElementById('tab-sell'),
                panelBuy: document.getElementById('panel-buy'),
                panelSell: document.getElementById('panel-sell'),
                
                // Theme
                themeBtn: document.getElementById('theme-toggle-btn'),
                iconSun: document.getElementById('icon-sun'),
                iconMoon: document.getElementById('icon-moon'),
                
                // Sticky
                stickyFooter: document.getElementById('mobile-sticky-summary'),
                
                // Modals
                solBtn: document.getElementById('sol-btn'),
                qrModal: document.getElementById('qr-modal'),
                qrBackdrop: document.getElementById('qr-backdrop'),
                qrClose: document.getElementById('qr-close'),

                // Video
                videoBtn: document.getElementById('video-btn'),
                videoBtnMobile: document.getElementById('video-btn-mobile'),
                videoModal: document.getElementById('video-modal'),
                videoBackdrop: document.getElementById('video-backdrop'),
                videoClose: document.getElementById('video-close'),

                // Fees
                showFeesToggle: document.getElementById('show-fees-toggle'),

                // Sections (removed toggles)
                // marketToggle: document.getElementById('toggle-market-data'),
                // marketSection: document.getElementById('section-market-data'),
                // marketChevron: document.getElementById('chevron-market-data'),
                // ladderToggle: document.getElementById('toggle-ladder-settings'),
                // ladderSection: document.getElementById('section-ladder-settings'),
                // ladderChevron: document.getElementById('chevron-ladder-settings'),

                // Sticky Extended
                stickyBtn: document.getElementById('sticky-expand-btn'),
                stickyChevron: document.getElementById('sticky-chevron'),
                stickyDetails: document.getElementById('sticky-details')
            };

            // --- CALCULATOR ENGINE ---
            const Calculator = {
                buildSkewWeights: (count, skewValue) => {
                    if (count <= 0) return [];
                    if (skewValue <= 0) return Array(count).fill(1);
                    const normalizedSkew = Utils.clamp(skewValue, 0, 100) / 100;
                    const targetRatio = 1 + Math.pow(normalizedSkew, 1.2) * (CONSTANTS.MAX_SKEW_RATIO - 1);
                    const minWeight = 1 / targetRatio;
                    const curvature = 1 + normalizedSkew;
                    
                    return Array.from({ length: count }, (_, index) => {
                        if (count === 1) return 1;
                        const relativeIndex = index / (count - 1);
                        const shapedIndex = Math.pow(relativeIndex, curvature);
                        const curveValue = Math.pow(targetRatio, shapedIndex);
                        return Math.max(curveValue - 1 + minWeight, Number.EPSILON);
                    });
                },

                computeEqualGrossAllocations: (totalQuantity, prices) => {
                    const allocations = Array(prices.length).fill(0);
                    const validEntries = prices.map((price, idx) => ({ price, idx })).filter(entry => entry.price > 0);
                    if (totalQuantity <= 0 || validEntries.length === 0) return { allocations, quantityPerRung: 0 };
                    const sharedQuantity = totalQuantity / validEntries.length;
                    validEntries.forEach(({ idx }) => allocations[idx] = sharedQuantity);
                    return { allocations, quantityPerRung: sharedQuantity };
                },

                deriveExecutedBuyTotals: (buyLadder, highestRung) => {
                    if (!Array.isArray(buyLadder) || buyLadder.length === 0 || !Number.isFinite(highestRung)) {
                        return { quantity: 0, netCapital: 0, fees: 0 };
                    }
                    const executed = buyLadder.filter(rung => rung.rung <= highestRung && rung.assetSize > 0);
                    if (executed.length === 0) return { quantity: 0, netCapital: 0, fees: 0 };
                    
                    const quantity = executed.reduce((sum, rung) => sum + rung.assetSize, 0);
                    const netCapital = executed.reduce((sum, rung) => sum + rung.netCapital, 0);
                    const fees = executed.reduce((sum, rung) => sum + rung.fee, 0);
                    return { quantity, netCapital, fees };
                }
            };

            // --- SETUP WIZARD ---
            const SetupWizard = {
                currentStep: 0,
                answers: {},
                _handlers: {},
                getFieldMap: () => ({
                    'starting_capital': els.startCap,
                    'existing_quantity': els.existQty,
                    'current_price': els.currPrice,
                    'number_of_rungs': els.rungsInput,
                    'depth': els.depthInput,
                    'skew_value': els.skew,
                    'fee_value': els.feeValue,
                    'sell_only_mode': els.sellOnlyCheck
                }),
                setFieldValue: (field, value, element) => {
                    if (!element || value === undefined) return;
                    if (field === 'starting_capital') {
                        element.value = Utils.formatNumberWithCommas(value.toString());
                    } else if (field === 'number_of_rungs') {
                        const v = Math.round(value);
                        element.value = v;
                        els.rungs.value = v;
                        els.rungsDisplay.textContent = v;
                    } else if (field === 'depth') {
                        element.value = value;
                        els.depth.value = value;
                    } else if (field === 'skew_value') {
                        element.value = value;
                        const v = parseInt(value);
                        els.skewLabel.textContent = v === 0 ? "Flat" : v <= 30 ? "Gentle" : v <= 70 ? "Moderate" : "Aggressive";
                    } else if (field === 'sell_only_mode') {
                        element.checked = value;
                        els.sellOnlyInputs?.classList.toggle('hidden', !value);
                    } else {
                        element.value = value;
                    }
                },
                questions: [
                    {
                        question: "What's your goal?",
                        hint: "This determines how the calculator works",
                        type: "mode_choice",
                        field: "sell_only_mode",
                        options: [
                            { 
                                label: "Build a Buy Ladder", 
                                value: false, 
                                description: "I have capital to invest",
                                icon: "üìà",
                                color: "red"
                            },
                            { 
                                label: "Plan My Exit", 
                                value: true, 
                                description: "I already own the asset",
                                icon: "üí∞",
                                color: "green"
                            }
                        ],
                        default: false
                    },
                    {
                        question: "How much are you working with?",
                        hint: "Enter your capital (buy mode) or quantity held (sell mode)",
                        type: "currency",
                        field: "starting_capital",
                        placeholder: "10,000",
                        default: 10000
                    },
                    {
                        question: "What's the current price?",
                        hint: "The asset's market price right now",
                        type: "currency",
                        field: "current_price",
                        placeholder: "100",
                        default: 100
                    },
                    {
                        question: "What's your target?",
                        hint: "Your lowest buy price or highest sell price",
                        type: "currency",
                        field: "target_price",
                        placeholder: "80",
                        min: 0.01,
                        default: undefined,
                        dynamicHint: true
                    }
                ],

                init: () => {
                    SetupWizard.currentStep = 0;
                    SetupWizard.answers = {};
                    // Pre-populate with defaults
                    SetupWizard.questions.forEach(q => {
                        if (q.default !== undefined) {
                            SetupWizard.answers[q.field] = q.default;
                        }
                    });
                    // Default to 8 rungs
                    SetupWizard.answers['number_of_rungs'] = 8;
                    SetupWizard.show();
                },

                prepare: () => {
                    SetupWizard.currentStep = 0;
                    SetupWizard.answers = {};
                    // Pre-populate with defaults
                    SetupWizard.questions.forEach(q => {
                        if (q.default !== undefined) {
                            SetupWizard.answers[q.field] = q.default;
                        }
                    });
                    // Default to 8 rungs
                    SetupWizard.answers['number_of_rungs'] = 8;
                },

                bindControls: () => {
                    const wizard = document.getElementById('setup-wizard');
                    if (!wizard) {
                        console.error('SetupWizard: Wizard container not found during bindControls');
                        return;
                    }

                    // Get button elements directly
                    const nextBtn = document.getElementById('wizard-next');
                    const backBtn = document.getElementById('wizard-back');
                    const skipBtn = document.getElementById('wizard-skip');

                    if (!SetupWizard._handlers.nextClick) {
                        SetupWizard._handlers.nextClick = (e) => {
                            console.log('SetupWizard: Next button clicked');
                            e.preventDefault();
                            e.stopPropagation();
                            SetupWizard.next();
                        };
                    }

                    if (!SetupWizard._handlers.backClick) {
                        SetupWizard._handlers.backClick = (e) => {
                            console.log('SetupWizard: Back button clicked');
                            e.preventDefault();
                            e.stopPropagation();
                            SetupWizard.back();
                        };
                    }

                    if (!SetupWizard._handlers.skipClick) {
                        SetupWizard._handlers.skipClick = (e) => {
                            console.log('SetupWizard: Skip button clicked');
                            e.preventDefault();
                            e.stopPropagation();
                            SetupWizard.skip();
                        };
                    }

                    if (!SetupWizard._handlers.keydown) {
                        SetupWizard._handlers.keydown = (event) => {
                            if (event.key === 'Escape') {
                                SetupWizard.skip();
                            }
                        };
                    }

                    // Remove old listeners and attach new ones
                    if (nextBtn) {
                        nextBtn.removeEventListener('click', SetupWizard._handlers.nextClick);
                        nextBtn.addEventListener('click', SetupWizard._handlers.nextClick);
                    }
                    if (backBtn) {
                        backBtn.removeEventListener('click', SetupWizard._handlers.backClick);
                        backBtn.addEventListener('click', SetupWizard._handlers.backClick);
                    }
                    if (skipBtn) {
                        skipBtn.removeEventListener('click', SetupWizard._handlers.skipClick);
                        skipBtn.addEventListener('click', SetupWizard._handlers.skipClick);
                    }

                    wizard.removeEventListener('keydown', SetupWizard._handlers.keydown);
                    wizard.addEventListener('keydown', SetupWizard._handlers.keydown);
                },

                show: () => {
                    console.log('SetupWizard.show called. Step:', SetupWizard.currentStep);
                    const wizard = document.getElementById('setup-wizard');
                    const wizardContent = document.getElementById('wizard-content');
                    const stepNum = document.getElementById('wizard-step-num');
                    const totalSteps = document.getElementById('wizard-total-steps');
                    const progress = document.getElementById('wizard-progress');
                    const backBtn = document.getElementById('wizard-back');
                    const nextBtn = document.getElementById('wizard-next');
                    const skipBtn = document.getElementById('wizard-skip');

                    if (!wizard) {
                        console.error('SetupWizard: Wizard container not found');
                        return;
                    }
                    if (!nextBtn) console.error('SetupWizard: Next button not found');
                    if (!skipBtn) console.error('SetupWizard: Skip button not found');

                    if (totalSteps) totalSteps.textContent = SetupWizard.questions.length;
                    SetupWizard.renderQuestion();
                    
                    // Clear inline styles that may have been set by finish() - they override CSS classes
                    wizard.style.opacity = '';
                    wizard.style.pointerEvents = '';
                    
                    wizard.classList.add('open');
                    // Force pointer-events/opacity inline to guarantee interactivity even if CSS class order changes
                    wizard.style.opacity = '1';
                    wizard.style.pointerEvents = 'auto';

                    // Bind event handlers (delegated click handling on wizard container)
                    SetupWizard.bindControls();

                    if (nextBtn) {
                        // Update next button text
                        if (SetupWizard.currentStep === SetupWizard.questions.length - 1) {
                            nextBtn.textContent = '‚ú® Finish Setup';
                            nextBtn.setAttribute('aria-label', 'Finish setup wizard');
                        } else {
                            nextBtn.textContent = 'Next ‚Üí';
                            nextBtn.setAttribute('aria-label', 'Go to next question');
                        }
                    }
                    if (backBtn) {
                        // Show/hide back button based on step
                        backBtn.classList.toggle('hidden', SetupWizard.currentStep === 0);
                    }
                    // Skip button text is static, no update needed here
                },

                renderQuestion: () => {
                    const wizardContent = document.getElementById('wizard-content');
                    let question = SetupWizard.questions[SetupWizard.currentStep];
                    const stepNum = document.getElementById('wizard-step-num');
                    const progress = document.getElementById('wizard-progress');
                    
                    // Dynamically change capital question to quantity question when in sell-only mode
                    const isSellOnly = SetupWizard.answers['sell_only_mode'] === true;
                    if (question.field === 'starting_capital' && isSellOnly) {
                        question = {
                            ...question,
                            question: "How many units to sell?",
                            hint: "Quantity you hold",
                            type: "number",
                            field: "existing_quantity",
                            placeholder: "50",
                            default: 50
                        };
                    }
                    
                    // Dynamically change target_price question based on mode
                    if (question.field === 'target_price') {
                        if (isSellOnly) {
                            question = {
                                ...question,
                                question: "Highest sell price?",
                                hint: "Top of your sell ladder. Range calculated automatically.",
                                field: "target_price",
                                placeholder: "120"
                            };
                        } else {
                            question = {
                                ...question,
                                question: "Lowest buy price?",
                                hint: "Bottom of your buy ladder. Range calculated automatically.",
                                field: "target_price",
                                placeholder: "80"
                            };
                        }
                    }
                    
                    stepNum.textContent = SetupWizard.currentStep + 1;
                    const progressPercent = ((SetupWizard.currentStep + 1) / SetupWizard.questions.length) * 100;
                    progress.style.width = progressPercent + '%';
                    progress.setAttribute('aria-valuenow', Math.round(progressPercent));
                    
                    // Hide error message
                    const errorEl = document.getElementById('wizard-error');
                    if (errorEl) {
                        errorEl.classList.remove('show');
                        errorEl.textContent = '';
                    }
                    
                    let html = `
                        <div class="wizard-question">
                            <h3 class="text-2xl md:text-3xl font-bold text-[var(--color-text)] mb-4">${question.question}</h3>
                            <p class="wizard-hint">${question.hint}</p>
                    `;

                    if (question.type === 'currency' || question.type === 'number' || question.type === 'percentage' || question.type === 'fee') {
                        // Get the correct field value (handle quantity vs capital)
                        const valueField = question.field === 'starting_capital' && isSellOnly ? 'existing_quantity' : question.field;
                        let actualValue = SetupWizard.answers[valueField];
                        const currentPrice = SetupWizard.answers['current_price'] || 0;
                        
                        // Calculate default for target_price based on mode
                        let defaultValue = question.default;
                        if (question.field === 'target_price' && currentPrice > 0) {
                            // Sell mode: 25% above current price; Buy mode: 25% below
                            const calculatedDefault = isSellOnly ? currentPrice * 1.25 : currentPrice * 0.75;
                            defaultValue = calculatedDefault;
                            
                            // If actualValue is undefined or null, use the calculated default
                            if (actualValue === undefined || actualValue === null) {
                                actualValue = calculatedDefault;
                                SetupWizard.answers[valueField] = calculatedDefault;
                            } else {
                                // Check if the stored value matches what would be calculated (within 0.01 tolerance)
                                // If it matches, it was likely auto-calculated, so recalculate it
                                const tolerance = 0.01;
                                if (Math.abs(actualValue - calculatedDefault) <= tolerance) {
                                    actualValue = calculatedDefault;
                                    SetupWizard.answers[valueField] = calculatedDefault;
                                }
                                // Otherwise, keep the user's manually entered value
                            }
                        }
                        
                        // Format value for display, ensuring null/undefined never appears
                        let currentValue = '';
                        if (actualValue !== undefined && actualValue !== null) {
                            if (question.type === 'currency' && actualValue >= 1000) {
                                currentValue = Utils.formatNumberWithCommas(actualValue.toString());
                            } else {
                                currentValue = actualValue.toString();
                            }
                        } else if (defaultValue !== undefined && defaultValue !== null) {
                            if (question.type === 'currency' && defaultValue >= 1000) {
                                currentValue = Utils.formatNumberWithCommas(defaultValue.toString());
                            } else {
                                currentValue = defaultValue.toString();
                            }
                        }
                        const inputType = question.type === 'number' ? 'number' : 'text';
                        const isCurrency = question.type === 'currency';
                        const showRangeCalc = question.field === 'target_price';
                        html += `
                            <div class="mt-6">
                                <label for="wizard-input" class="sr-only">${question.question}</label>
                                <div class="relative flex items-center gap-4">
                                    <div class="flex-1 relative">
                                        ${isCurrency ? '<span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--color-text-secondary)] font-mono">$</span>' : ''}
                                        <input 
                                            type="${inputType}"
                                            id="wizard-input" 
                                            class="wizard-input ${isCurrency ? 'pl-7' : ''}" 
                                            placeholder="${question.placeholder || ''}"
                                            value="${currentValue}"
                                            ${question.min !== undefined ? `min="${question.min}"` : ''}
                                            ${question.max !== undefined ? `max="${question.max}"` : ''}
                                            aria-describedby="wizard-hint"
                                            autocomplete="off"
                                        >
                                    </div>
                                    ${showRangeCalc ? `<div id="wizard-range-display" class="text-sm text-[var(--color-text-muted)] whitespace-nowrap">Range: <span class="font-mono">0%</span></div>` : ''}
                                </div>
                            </div>
                        `;
                    } else if (question.type === 'mode_choice') {
                        // Special visual mode choice (Buy vs Sell)
                        html += '<div class="mt-6 grid grid-cols-2 gap-4" role="radiogroup">';
                        question.options.forEach((option, idx) => {
                            const isSelected = SetupWizard.answers[question.field] === option.value || 
                                             (SetupWizard.answers[question.field] === undefined && option.value === question.default);
                            const valueStr = typeof option.value === 'boolean' ? option.value : option.value;
                            const colorClass = option.color === 'red' ? 'red' : 'green';
                            const borderClass = isSelected 
                                ? `border-${colorClass}-500 bg-${colorClass}-500/10` 
                                : 'border-[var(--color-border)] bg-[var(--color-card-muted)]';
                            html += `
                                <button 
                                    type="button"
                                    class="wizard-mode-option relative p-6 rounded-xl border-2 transition-all hover:scale-105 ${isSelected ? `border-${colorClass}-500 bg-${colorClass}-500/10 shadow-lg` : 'border-[var(--color-border)] bg-[var(--color-card-muted)] hover:border-' + colorClass + '-500/50'}"
                                    data-field="${question.field}"
                                    data-value="${valueStr}"
                                    role="radio"
                                    aria-checked="${isSelected}"
                                >
                                    <div class="text-4xl mb-3">${option.icon || ''}</div>
                                    <div class="font-bold text-${colorClass}-500 text-lg mb-1">${option.label}</div>
                                    <div class="text-sm text-[var(--color-text-muted)]">${option.description || ''}</div>
                                    ${isSelected ? `<div class="absolute top-3 right-3 w-6 h-6 rounded-full bg-${colorClass}-500 text-white flex items-center justify-center"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg></div>` : ''}
                                </button>
                            `;
                        });
                        html += '</div>';
                    } else if (question.type === 'skew' || question.type === 'choice') {
                        html += '<div class="mt-6 space-y-3" role="radiogroup" aria-labelledby="wizard-question-title">';
                        question.options.forEach((option, idx) => {
                            const isSelected = SetupWizard.answers[question.field] === option.value || 
                                             (SetupWizard.answers[question.field] === undefined && option.value === question.default);
                            const valueStr = typeof option.value === 'boolean' ? option.value : option.value;
                            const optionId = `wizard-option-${SetupWizard.currentStep}-${idx}`;
                            html += `
                                <button 
                                    type="button"
                                    id="${optionId}"
                                    class="wizard-option w-full ${isSelected ? 'selected' : ''}"
                                    data-field="${question.field}"
                                    data-value="${valueStr}"
                                    role="radio"
                                    aria-checked="${isSelected}"
                                    aria-label="${option.label}${option.description ? ': ' + option.description : ''}"
                                >
                                    <div class="flex flex-col items-start">
                                        <span class="font-semibold">${option.label}</span>
                                        ${option.description ? `<span class="text-sm text-[var(--color-text-muted)] mt-1">${option.description}</span>` : ''}
                                    </div>
                                </button>
                            `;
                        });
                        html += '</div>';
                    }

                    html += '</div>';
                    wizardContent.innerHTML = html;

                    // Initialize range display for target price
                    if (question.field === 'target_price') {
                        const currentPrice = SetupWizard.answers['current_price'] || 0;
                        let targetPrice = SetupWizard.answers['target_price'];
                        // If targetPrice is null, undefined, or 0, calculate it from current price
                        if ((!targetPrice || targetPrice === null) && currentPrice > 0) {
                            targetPrice = isSellOnly ? currentPrice * 1.25 : currentPrice * 0.75;
                            SetupWizard.answers['target_price'] = targetPrice;
                            // Update the input field if it exists
                            const input = document.getElementById('wizard-input');
                            if (input) {
                                if (targetPrice >= 1000) {
                                    input.value = Utils.formatNumberWithCommas(targetPrice.toString());
                                } else {
                                    input.value = targetPrice.toString();
                                }
                            }
                        }
                        const rangeDisplay = document.getElementById('wizard-range-display');
                        if (rangeDisplay && currentPrice > 0 && targetPrice && targetPrice > 0) {
                            const range = isSellOnly 
                                ? ((targetPrice - currentPrice) / currentPrice) * 100
                                : ((currentPrice - targetPrice) / currentPrice) * 100;
                            rangeDisplay.innerHTML = `Range: <span class="font-mono">${Math.abs(range).toFixed(1)}%</span>`;
                        }
                    }

                    // Focus input if it exists
                    const input = document.getElementById('wizard-input');
                    if (input) {
                        setTimeout(() => {
                            input.focus();
                            if (input.type === 'text') {
                                input.select();
                            }
                        }, 150);
                        input.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                                SetupWizard.next();
                            }
                        });
                        input.addEventListener('input', () => {
                            // Hide error on input
                            const errorEl = document.getElementById('wizard-error');
                            if (errorEl) errorEl.classList.remove('show');
                            
                            // Update range calculation for target price
                            if (question.field === 'target_price') {
                                const currentPrice = SetupWizard.answers['current_price'] || 0;
                                const targetPrice = parseFloat(input.value.replace(/,/g, '')) || 0;
                                const rangeDisplay = document.getElementById('wizard-range-display');
                                if (rangeDisplay && currentPrice > 0 && targetPrice > 0) {
                                    const range = isSellOnly 
                                        ? ((targetPrice - currentPrice) / currentPrice) * 100
                                        : ((currentPrice - targetPrice) / currentPrice) * 100;
                                    rangeDisplay.innerHTML = `Range: <span class="font-mono">${Math.abs(range).toFixed(1)}%</span>`;
                                }
                            }
                        });
                    }

                    // Bind option buttons (both regular and mode options)
                    const optionButtons = wizardContent.querySelectorAll('.wizard-option, .wizard-mode-option');
                    optionButtons.forEach((btn, idx) => {
                        btn.addEventListener('click', () => {
                            const field = btn.dataset.field;
                            let value = btn.dataset.value;
                            // Parse value appropriately
                            if (value === 'true') value = true;
                            else if (value === 'false') value = false;
                            else if (!isNaN(value)) value = parseFloat(value);
                            SetupWizard.selectOption(field, value);
                        });
                        btn.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                e.preventDefault();
                                btn.click();
                            } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                                e.preventDefault();
                                const nextIdx = (e.key === 'ArrowDown' || e.key === 'ArrowRight')
                                    ? Math.min(idx + 1, optionButtons.length - 1)
                                    : Math.max(idx - 1, 0);
                                optionButtons[nextIdx].focus();
                            }
                        });
                    });
                },

                selectOption: (field, value) => {
                    SetupWizard.answers[field] = value;
                    SetupWizard.updateFormInRealTime();
                    // Re-render to update selected state and potentially change next question
                    SetupWizard.renderQuestion();
                    // Auto-advance to next step
                    setTimeout(() => {
                        if (SetupWizard.currentStep < SetupWizard.questions.length - 1) {
                            SetupWizard.next();
                        }
                    }, 300);
                },

                showError: (message) => {
                    const errorEl = document.getElementById('wizard-error');
                    if (errorEl) {
                        errorEl.textContent = message;
                        errorEl.classList.add('show');
                        errorEl.focus();
                    }
                },

                next: () => {
                    console.log('SetupWizard.next executing');
                    let question = SetupWizard.questions[SetupWizard.currentStep];
                    const input = document.getElementById('wizard-input');
                    
                    // Check if we need to use quantity field instead of capital
                    const isSellOnly = SetupWizard.answers['sell_only_mode'] === true;
                    let actualField = question.field;
                    if (question.field === 'starting_capital' && isSellOnly) {
                        actualField = 'existing_quantity';
                    }
                    
                    // Validate and save answer
                    if (input) {
                        let value = input.value.trim();
                        
                        // Use default for target_price if empty
                        if (!value && question.field === 'target_price') {
                            const currentPrice = SetupWizard.answers['current_price'] || 0;
                            if (currentPrice > 0) {
                                value = (isSellOnly ? currentPrice * 1.25 : currentPrice * 0.75).toString();
                            }
                        }
                        
                        if (!value) {
                            SetupWizard.showError('Please enter a value.');
                            input.focus();
                            return;
                        }
                        
                        // Parse value based on type
                        if (question.type === 'currency' || question.type === 'number' || question.type === 'percentage' || question.type === 'fee') {
                            value = parseFloat(value.replace(/,/g, ''));
                            if (isNaN(value) || value <= 0) {
                                SetupWizard.showError('Enter a valid positive number.');
                                input.focus();
                                input.select();
                                return;
                            }
                            if (question.min !== undefined && value < question.min) {
                                SetupWizard.showError(`Minimum: ${question.min}`);
                                input.focus();
                                input.select();
                                return;
                            }
                            if (question.max !== undefined && value > question.max) {
                                SetupWizard.showError(`Maximum: ${question.max}`);
                                input.focus();
                                input.select();
                                return;
                            }
                            // Validate target price based on mode
                            if (question.field === 'target_price') {
                                const currentPrice = SetupWizard.answers['current_price'] || 0;
                                if (currentPrice > 0) {
                                    if (isSellOnly && value <= currentPrice) {
                                        SetupWizard.showError('Sell target must be above current price.');
                                        input.focus();
                                        input.select();
                                        return;
                                    } else if (!isSellOnly && value >= currentPrice) {
                                        SetupWizard.showError('Buy target must be below current price.');
                                        input.focus();
                                        input.select();
                                        return;
                                    }
                                }
                            }
                        }
                        
                        // Calculate depth from target price if needed
                        if (question.field === 'target_price') {
                            const currentPrice = SetupWizard.answers['current_price'] || 0;
                            if (currentPrice > 0 && value > 0) {
                                const depth = isSellOnly
                                    ? ((value - currentPrice) / currentPrice) * 100
                                    : ((currentPrice - value) / currentPrice) * 100;
                                SetupWizard.answers['depth'] = Math.abs(depth);
                            }
                            SetupWizard.answers['target_price'] = value;
                        } else {
                            SetupWizard.answers[actualField] = value;
                            
                            // If current_price was just set, automatically calculate target_price
                            if (question.field === 'current_price' && value > 0) {
                                const calculatedTargetPrice = isSellOnly ? value * 1.25 : value * 0.75;
                                // Only set if target_price hasn't been manually set yet
                                if (SetupWizard.answers['target_price'] === undefined || 
                                    SetupWizard.answers['target_price'] === null) {
                                    SetupWizard.answers['target_price'] = calculatedTargetPrice;
                                }
                            }
                        }
                        SetupWizard.updateFormInRealTime();
                    } else if (question.type === 'skew' || question.type === 'choice' || question.type === 'mode_choice') {
                        if (SetupWizard.answers[actualField] === undefined) {
                            SetupWizard.answers[actualField] = question.default;
                        }
                        SetupWizard.updateFormInRealTime();
                    }

                    // Move to next step or finish
                    if (SetupWizard.currentStep < SetupWizard.questions.length - 1) {
                        SetupWizard.currentStep++;
                        SetupWizard.show();
                    } else {
                        SetupWizard.finish();
                    }
                },

                back: () => {
                    console.log('SetupWizard.back executing');
                    if (SetupWizard.currentStep > 0) {
                        SetupWizard.currentStep--;
                        SetupWizard.show();
                    }
                },

                skip: () => {
                    console.log('SetupWizard.skip executing');
                    SetupWizard.finish(true);
                },

                finish: (wasSkipped = false) => {
                    console.log('SetupWizard.finish executing, skipped:', wasSkipped);
                    // Apply answers to form fields
                    SetupWizard.applyAnswers();
                    
                    // Set mode based on whether wizard was skipped
                    // If completed normally, default to 'simple' (Current mode)
                    // If skipped, default to 'pro' (Customise mode)
                    App.setMode(wasSkipped ? 'pro' : 'simple');
                    
                    // Hide wizard
                    const wizard = document.getElementById('setup-wizard');
                    if (wizard) {
                        wizard.classList.remove('open');
                        // Reset inline opacity and pointer-events styles to ensure proper hiding
                        wizard.style.opacity = '0';
                        wizard.style.pointerEvents = 'none';
                    }
                    
                    // Mark as completed
                    localStorage.setItem(CONSTANTS.STORAGE_PREFIX + 'setup_completed', 'true');
                    
                    // Trigger calculation
                    setTimeout(() => {
                        App.calculatePlan();
                    }, 300);
                },

                applyAnswers: () => {
                    if (SetupWizard.answers['number_of_rungs'] === undefined) SetupWizard.answers['number_of_rungs'] = 8;
                    const fieldMap = SetupWizard.getFieldMap();
                    Object.keys(SetupWizard.answers).forEach(field => {
                        SetupWizard.setFieldValue(field, SetupWizard.answers[field], fieldMap[field]);
                    });
                },

                updateFormInRealTime: () => {
                    const question = SetupWizard.questions[SetupWizard.currentStep];
                    if (!question) return;
                    const isSellOnly = SetupWizard.answers['sell_only_mode'] === true;
                    
                    // Recalculate depth from target price
                    if (question.field === 'target_price' || SetupWizard.answers['target_price'] !== undefined) {
                        const currentPrice = SetupWizard.answers['current_price'] || 0;
                        const targetPrice = SetupWizard.answers['target_price'];
                        if (currentPrice > 0 && targetPrice > 0) {
                            SetupWizard.answers['depth'] = Math.abs((isSellOnly ? targetPrice - currentPrice : currentPrice - targetPrice) / currentPrice * 100);
                        }
                    }
                    
                    const actualField = (question.field === 'starting_capital' && isSellOnly) ? 'existing_quantity' : question.field;
                    const fieldMap = SetupWizard.getFieldMap();
                    const answer = SetupWizard.answers[actualField] ?? SetupWizard.answers[question.field];
                    SetupWizard.setFieldValue(actualField, answer, fieldMap[actualField]);
                }
            };

            SetupWizard.bindControls();

            // --- APP LOGIC ---
            const App = {
                init: () => {
                    App.loadTheme();
                    App.bindEvents();
                    
                    // Always show welcome screen on initial load
                    const introLayer = document.getElementById('intro-layer');
                    if (introLayer) {
                        introLayer.style.display = 'flex';
                        introLayer.style.opacity = '1';
                        introLayer.style.pointerEvents = 'auto';
                    }
                    
                    App.calculatePlan();
                    App.ensureTableBottomSpace();
                    window.addEventListener('resize', Utils.debounce(() => {
                        App.calculatePlan();
                        App.ensureTableBottomSpace();
                        // Re-render tables to update spacer rows on mobile
                        if (State.currentPlanData) {
                            App.updateUI(State.currentPlanData);
                        }
                    }, 200));
                },
                
                ensureTableBottomSpace: () => {
                    // Simple, robust logic: If mobile (narrower than lg breakpoint), enforce moderate bottom margin
                    const tableContainer = document.querySelector('.card.overflow-hidden');
                    if (!tableContainer) return;
                    
                    const isMobile = window.innerWidth < 1024;
                    // 24px margin + 80px body padding ensures safety without huge void
                    tableContainer.style.marginBottom = isMobile ? '24px' : '48px';
                },

                loadTheme: () => {
                    const saved = localStorage.getItem(CONSTANTS.STORAGE_PREFIX + 'theme');
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    State.theme = saved || (prefersDark ? 'dark' : 'light');
                    App.applyTheme();
                },

                toggleTheme: () => {
                    State.theme = State.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem(CONSTANTS.STORAGE_PREFIX + 'theme', State.theme);
                    App.applyTheme();
                },

                applyTheme: () => {
                    document.body.className = document.body.className.replace(/theme-\w+/, `theme-${State.theme}`);
                    if (State.theme === 'dark') {
                        els.iconSun.classList.remove('hidden');
                        els.iconMoon.classList.add('hidden');
                    } else {
                        els.iconSun.classList.add('hidden');
                        els.iconMoon.classList.remove('hidden');
                    }
                    App.calculatePlan(); // Redraw charts
                },

                bindEvents: () => {
                    // Mode Switch (with null checks)
                    if (els.modeSimple) els.modeSimple.addEventListener('click', () => App.setMode('simple'));
                    if (els.modePro) els.modePro.addEventListener('click', () => App.setMode('pro'));

                    // Fees Toggle
                    if (els.showFeesToggle) {
                        els.showFeesToggle.addEventListener('change', () => {
                            State.showFees = els.showFeesToggle.checked;
                            App.updateUI(State.currentPlanData);
                        });
                    }

                    // Chart Display Toggles
                    const chartShowBars = document.getElementById('chart-show-bars');
                    const chartShowCumulative = document.getElementById('chart-show-cumulative');
                    const chartUnitVolume = document.getElementById('chart-unit-volume');
                    const chartUnitValue = document.getElementById('chart-unit-value');

                    const redrawChart = () => {
                        if (State.currentPlanData) {
                            App.drawDepthChart('#depth-chart', State.currentPlanData.buyLadder, State.currentPlanData.sellLadder);
                        }
                    };

                    if (chartShowBars) {
                        chartShowBars.addEventListener('change', () => {
                            State.chartShowBars = chartShowBars.checked;
                            redrawChart();
                        });
                    }

                    if (chartShowCumulative) {
                        chartShowCumulative.addEventListener('change', () => {
                            State.chartShowCumulative = chartShowCumulative.checked;
                            redrawChart();
                        });
                    }

                    const updateChartUnitType = (type) => {
                        State.chartUnitType = type;
                        if (type === 'volume') {
                            chartUnitVolume.classList.add('active');
                            chartUnitValue.classList.remove('active');
                        } else {
                            chartUnitValue.classList.add('active');
                            chartUnitVolume.classList.remove('active');
                        }
                        redrawChart();
                    };

                    if (chartUnitVolume) chartUnitVolume.addEventListener('click', () => updateChartUnitType('volume'));
                    if (chartUnitValue) chartUnitValue.addEventListener('click', () => updateChartUnitType('value'));

                    // How It Works Modal
                    const howItWorksModal = document.getElementById('how-it-works-modal');
                    const toggleHowItWorks = Utils.bindModal(howItWorksModal, 
                        [document.getElementById('intro-how-it-works')],
                        [document.getElementById('how-it-works-backdrop'), document.getElementById('how-it-works-close')]);

                    // Handle Intro Page
                    const enterBtn = document.getElementById('enter-app-btn');
                    if (enterBtn) {
                        enterBtn.addEventListener('click', () => {
                            const wizard = document.getElementById('setup-wizard');
                            if (!wizard) { console.error('Setup wizard not found'); return; }
                            SetupWizard.prepare();
                            wizard.style.opacity = '1';
                            wizard.style.pointerEvents = 'auto';
                            requestAnimationFrame(() => {
                                SetupWizard.show();
                                Utils.hideIntro(document.getElementById('intro-layer'));
                            });
                        });
                    }

                    // Quick Start Button - Skip wizard and use defaults
                    const quickStartBtn = document.getElementById('quick-start-btn');
                    if (quickStartBtn) {
                        quickStartBtn.addEventListener('click', () => {
                            // Set example values directly
                            if (els.startCap) els.startCap.value = '10,000';
                            if (els.currPrice) els.currPrice.value = '100';
                            if (els.depth) els.depth.value = '25';
                            if (els.depthInput) els.depthInput.value = '25';
                            if (els.rungs) els.rungs.value = '10';
                            if (els.rungsInput) els.rungsInput.value = '10';
                            if (els.rungsDisplay) els.rungsDisplay.textContent = '10';
                            if (els.skew) els.skew.value = '50';
                            
                            Utils.hideIntro(document.getElementById('intro-layer'));
                            localStorage.setItem(CONSTANTS.STORAGE_PREFIX + 'setup_completed', 'true');
                            App.calculatePlan();
                            
                            const toast = document.getElementById('toast');
                            if (toast) {
                                toast.textContent = '‚ú® Example plan loaded! Adjust values to customize.';
                                toast.classList.add('show');
                                setTimeout(() => toast.classList.remove('show'), 3000);
                            }
                        });
                    }

                    // Handle Logo Click - Return to Start Page
                    const logoHeader = document.getElementById('logo-header');
                    if (logoHeader) {
                        logoHeader.addEventListener('click', () => {
                            const introLayer = document.getElementById('intro-layer');
                            if (introLayer) {
                                introLayer.style.display = 'flex';
                                introLayer.style.opacity = '1';
                                introLayer.style.pointerEvents = 'auto';
                            }
                        });
                    }

                    // Slider Syncs
                    const syncSlider = (slider, input, display) => {
                        slider.addEventListener('input', () => {
                            input.value = slider.value;
                            if(display) display.textContent = slider.value;
                            App.debouncedCalc();
                        });
                        input.addEventListener('input', () => {
                            slider.value = input.value;
                            if(display) display.textContent = input.value;
                            App.debouncedCalc();
                        });
                    };

                    syncSlider(els.rungs, els.rungsInput, els.rungsDisplay);
                    syncSlider(els.depth, els.depthInput);
                    
                    // Skew Sync
                    els.skew.addEventListener('input', () => {
                        els.skewLabel.textContent = Utils.getSkewLabel(parseInt(els.skew.value));
                        App.debouncedCalc();
                    });

                    // Format currency inputs with commas
                    Utils.bindCurrencyInput(els.startCap, App.debouncedCalc);
                    Utils.bindCurrencyInput(els.currPrice, App.debouncedCalc);

                    // Standard Inputs
                    const inputs = [els.buyFloor, els.sellCeiling, 
                                   els.existQty, els.existAvg, els.feeValue];
                    inputs.forEach(el => { if(el) el.addEventListener('input', App.debouncedCalc); });

                    // Fee Type Toggle Buttons
                    const feeTypePercent = document.getElementById('fee_type_percent');
                    const feeTypeFixed = document.getElementById('fee_type_fixed');
                    const feeDollarPrefix = document.getElementById('fee_dollar_prefix');
                    if (feeTypePercent && feeTypeFixed) {
                        const updateFeeType = (value) => {
                            if (els.feeType) els.feeType.value = value;
                            if (value === 'percent') {
                                feeTypePercent.classList.add('active');
                                feeTypeFixed.classList.remove('active');
                                if (feeDollarPrefix) {
                                    feeDollarPrefix.classList.add('hidden');
                                }
                                if (els.feeValue) els.feeValue.style.paddingLeft = '';
                            } else {
                                feeTypeFixed.classList.add('active');
                                feeTypePercent.classList.remove('active');
                                if (feeDollarPrefix) {
                                    feeDollarPrefix.classList.remove('hidden');
                                }
                                if (els.feeValue) els.feeValue.style.paddingLeft = '2.5rem';
                            }
                            App.calculatePlan();
                        };
                        feeTypePercent.addEventListener('click', () => updateFeeType('percent'));
                        feeTypeFixed.addEventListener('click', () => updateFeeType('fixed'));
                        // Initialize active state
                        updateFeeType('percent');
                    }

                    // Selects
                    [els.priceRangeMode, els.feeSettlement, els.spacingMode].forEach(el => {
                        if(el) el.addEventListener('change', (e) => {
                            if (e.target === els.priceRangeMode) App.togglePriceMode();
                            App.calculatePlan();
                        });
                    });

                    // Toggles
                    // Mode Selector Buttons (Buy vs Sell-Only)
                    const modeBuyBtn = document.getElementById('mode-buy-btn');
                    const modeSellBtn = document.getElementById('mode-sell-btn');
                    const modeBuyCheck = document.getElementById('mode-buy-check');
                    const modeSellCheck = document.getElementById('mode-sell-check');
                    const buyModeInputs = document.getElementById('buy-mode-inputs');
                    const sellModeInputs = document.getElementById('sell-mode-inputs');
                    const currentPriceSell = document.getElementById('current_price_sell');

                    const setSellOnlyMode = (isSellOnly) => {
                        State.sellOnlyMode = isSellOnly;
                        if (els.sellOnlyCheck) els.sellOnlyCheck.checked = isSellOnly;
                        
                        const updateModeCard = (btn, check, isActive, color) => {
                            if (btn) {
                                btn.classList.toggle('active', isActive);
                                btn.classList.toggle(`border-${color}-500/50`, isActive);
                                btn.classList.toggle(`bg-${color}-500/10`, isActive);
                                btn.classList.toggle('border-[var(--color-border)]', !isActive);
                                btn.classList.toggle('bg-[var(--color-card-muted)]', !isActive);
                            }
                            if (check) check.style.opacity = isActive ? '1' : '0';
                        };
                        
                        updateModeCard(modeBuyBtn, modeBuyCheck, !isSellOnly, 'red');
                        updateModeCard(modeSellBtn, modeSellCheck, isSellOnly, 'green');
                        buyModeInputs?.classList.toggle('hidden', isSellOnly);
                        sellModeInputs?.classList.toggle('hidden', !isSellOnly);
                        document.body.classList.toggle('sell-mode-active', isSellOnly);
                        
                        if (isSellOnly) App.switchTab('sell');
                        else State.sellOnlyHighestExecuted = null;
                        
                        App.calculatePlan();
                    };

                    if (modeBuyBtn) modeBuyBtn.addEventListener('click', () => setSellOnlyMode(false));
                    if (modeSellBtn) modeSellBtn.addEventListener('click', () => setSellOnlyMode(true));
                    
                    // Sync price inputs between modes
                    if (currentPriceSell && els.currPrice) {
                        currentPriceSell.addEventListener('input', () => {
                            els.currPrice.value = currentPriceSell.value;
                            App.debouncedCalc();
                        });
                        els.currPrice.addEventListener('input', () => {
                            currentPriceSell.value = els.currPrice.value;
                        });
                    }

                    // Legacy checkbox handler (for compatibility)
                    if (els.sellOnlyCheck) {
                        els.sellOnlyCheck.addEventListener('change', () => {
                            setSellOnlyMode(els.sellOnlyCheck.checked);
                        });
                    }

                    if (els.equalQtyCheck) {
                        els.equalQtyCheck.addEventListener('change', () => {
                            if (els.skew) {
                                els.skew.disabled = els.equalQtyCheck.checked;
                                if(els.equalQtyCheck.checked) els.skew.classList.add('opacity-50');
                                else els.skew.classList.remove('opacity-50');
                            }
                            App.calculatePlan();
                        });
                    }

                    // Tabs & Buttons (with null checks)
                    if (els.tabBuy) els.tabBuy.addEventListener('click', () => App.switchTab('buy'));
                    if (els.tabSell) els.tabSell.addEventListener('click', () => App.switchTab('sell'));
                    if (els.themeBtn) els.themeBtn.addEventListener('click', App.toggleTheme);
                    
                    const downloadBtn = document.getElementById('download-csv-btn');
                    const saveConfigBtn = document.getElementById('save-config-btn');
                    const loadConfigFile = document.getElementById('load-config-file');
                    if (downloadBtn) downloadBtn.addEventListener('click', App.exportCSV);
                    if (saveConfigBtn) saveConfigBtn.addEventListener('click', App.saveConfig);
                    if (loadConfigFile) loadConfigFile.addEventListener('change', App.loadConfig);
                    
                    // QR Modal
                    const toggleModal = Utils.bindModal(els.qrModal, [els.solBtn], [els.qrBackdrop, els.qrClose]);

                    // Video Modal with lazy loading
                    const videoIframe = els.videoModal?.querySelector('iframe');
                    const videoSrc = videoIframe?.dataset.src || videoIframe?.src || '';
                    const toggleVideo = (show) => {
                        els.videoModal?.classList.toggle('open', show);
                        if (videoIframe) videoIframe.src = show ? videoSrc : '';
                    };
                    [els.videoBtn, els.videoBtnMobile, document.getElementById('intro-video-link')].forEach(btn => btn?.addEventListener('click', () => toggleVideo(true)));
                    [els.videoBackdrop, els.videoClose].forEach(el => el?.addEventListener('click', () => toggleVideo(false)));

                    // Global Escape key handler for all modals (better UX)
                    document.addEventListener('keydown', (e) => {
                        if (e.key === 'Escape') {
                            if (els.qrModal.classList.contains('open')) toggleModal(false);
                            if (els.videoModal.classList.contains('open')) toggleVideo(false);
                            if (howItWorksModal?.classList.contains('open')) toggleHowItWorks(false);
                        }
                    });

                    // Sections (Removed)
                    // const toggleSection = (btn, section, chevron) => ...

                    // Sticky Footer
                    if(els.stickyBtn) {
                        els.stickyBtn.addEventListener('click', () => {
                            if (els.stickyDetails) els.stickyDetails.classList.toggle('hidden');
                            if (els.stickyChevron) els.stickyChevron.classList.toggle('rotate-180');
                        });
                    }
                },

                debouncedCalc: () => Utils.debounce(App.calculatePlan, 50)(),

                setMode: (mode) => {
                    State.mode = mode;
                    // Update Buttons
                    const activeClass = "shadow-sm bg-[var(--color-card)] text-[var(--color-primary)]";
                    const inactiveClass = "text-[var(--color-text-secondary)] hover:text-[var(--color-text)]";
                    
                    if (els.modeSimple) els.modeSimple.className = `px-3 py-1 text-xs font-medium rounded-md transition-all ${mode==='simple'?activeClass:inactiveClass}`;
                    if (els.modePro) els.modePro.className = `px-3 py-1 text-xs font-medium rounded-md transition-all ${mode==='pro'?activeClass:inactiveClass}`;
                    
                    // Show/Hide Pro Controls
                    if (els.proControls) els.proControls.classList.toggle('hidden', mode === 'simple');
                    
                    // Adjust layout for customise mode - graph sits on side of configuration card
                    const mainGrid = document.getElementById('main-content-grid');
                    const configColumn = document.getElementById('config-column');
                    const graphColumn = document.getElementById('graph-column');
                    
                    if (mode === 'pro') {
                        // Customise mode: side-by-side layout (graph on right side of config card)
                        if (mainGrid) mainGrid.className = 'grid grid-cols-1 lg:grid-cols-12 gap-6';
                        if (configColumn) configColumn.className = 'lg:col-span-5 space-y-6';
                        if (graphColumn) graphColumn.className = 'lg:col-span-7 space-y-6';
                    } else {
                        // Simple mode: stacked layout (full width for both)
                        if (mainGrid) mainGrid.className = 'grid grid-cols-1 gap-6';
                        if (configColumn) configColumn.className = 'space-y-6';
                        if (graphColumn) graphColumn.className = 'space-y-6';
                    }
                    
                    App.calculatePlan();
                },

                togglePriceMode: () => {
                    const mode = els.priceRangeMode.value;
                    els.widthContainer.classList.toggle('hidden', mode !== 'width');
                    els.floorContainer.classList.toggle('hidden', mode !== 'floor');
                },

                switchTab: (tab) => {
                    State.activeTab = tab;
                    const activeClass = "flex-1 py-3 text-sm font-medium text-[var(--color-primary)] border-b-2 border-[var(--color-primary)] bg-[var(--color-card-alt)]";
                    const inactiveClass = "flex-1 py-3 text-sm font-medium text-[var(--color-text-muted)] hover:text-[var(--color-text)]";
                    
                    els.tabBuy.className = tab === 'buy' ? activeClass : inactiveClass;
                    els.tabSell.className = tab === 'sell' ? activeClass : inactiveClass;
                    els.panelBuy.classList.toggle('hidden', tab !== 'buy');
                    els.panelSell.classList.toggle('hidden', tab !== 'sell');
                },

                // --- CORE CALCULATION ---
                calculatePlan: () => {
                    // 1. Inputs
                    const C = parseFloat(Utils.stripCommas(els.startCap.value)) || 0;
                    const currentPrice = parseFloat(Utils.stripCommas(els.currPrice.value)) || 0;
                    
                    let N, S, depth, feeType, feeValue, feeSettlement, spacingMode, sellOnly, equalQty;

                    if (State.mode === 'simple') {
                        // Defaults for Simple Mode
                        N = 10;
                        S = 50; // Moderate
                        depth = 25;
                        feeType = 'percent';
                        feeValue = 0.075;
                        feeSettlement = 'netted';
                        spacingMode = 'absolute';
                        sellOnly = false;
                        equalQty = false;
                    } else {
                        // Pro Mode Inputs
                        N = parseInt(els.rungs.value) || 2;
                        S = parseInt(els.skew.value) || 0;
                        depth = parseFloat(els.depth.value) || 20;
                        feeType = els.feeType.value;
                        feeValue = parseFloat(els.feeValue.value) || 0;
                        feeSettlement = els.feeSettlement.value;
                        spacingMode = els.spacingMode.value;
                        sellOnly = els.sellOnlyCheck.checked;
                        equalQty = els.equalQtyCheck.checked;
                    }

                    const feeRate = feeType === 'percent' ? feeValue / 100 : 0;
                    const isFeeNetted = feeSettlement !== 'external';
                    const isRelativeSpacing = spacingMode === 'relative';

                    // 2. Price Range
                    let buyPriceEnd, sellPriceEnd;
                    // In simple mode, always use width. In Pro, check DOM.
                    const useFloor = State.mode === 'pro' && els.priceRangeMode.value === 'floor';
                    
                    if (useFloor) {
                        // Use explicit NaN check instead of || to allow 0 as a valid value
                        const buyFloorValue = parseFloat(els.buyFloor.value);
                        buyPriceEnd = !isNaN(buyFloorValue) ? buyFloorValue : currentPrice * 0.8;
                        
                        const sellCeilingValue = parseFloat(els.sellCeiling.value);
                        sellPriceEnd = !isNaN(sellCeilingValue) ? sellCeilingValue : currentPrice * 1.2;
                    } else {
                        buyPriceEnd = currentPrice * (1 - depth/100);
                        sellPriceEnd = currentPrice * (1 + depth/100);
                    }

                    // Correctly Calculate Steps to ensure Last Rung == Floor/Ceiling
                    // If N rungs, we want i=0 to i=N-1.
                    // If standard steps, we want the Nth rung to be EXACTLY buyPriceEnd.
                    // Standard logic: price = current - (i+1)*step.
                    // Last rung (i=N-1): price = current - N*step = buyPriceEnd.
                    // So N*step = current - buyPriceEnd => step = (current - buyPriceEnd) / N.
                    
                    const buyStep = (!isRelativeSpacing && N > 0) ? (currentPrice - buyPriceEnd) / N : 0;
                    const sellStep = (!isRelativeSpacing && N > 0) ? (sellPriceEnd - currentPrice) / N : 0;
                    const buyRatio = (isRelativeSpacing && N > 0) ? Math.pow(Math.max(buyPriceEnd/currentPrice, 0), 1/N) : 1;
                    const sellRatio = (isRelativeSpacing && N > 0) ? Math.pow(sellPriceEnd/currentPrice, 1/N) : 1;

                    let buyPrices = Array.from({length: N}, (_, i) => isRelativeSpacing ? currentPrice * Math.pow(buyRatio, i+1) : currentPrice - ((i+1)*buyStep));
                    let sellPrices = Array.from({length: N}, (_, i) => isRelativeSpacing ? currentPrice * Math.pow(sellRatio, i+1) : currentPrice + ((i+1)*sellStep));
                    
                    // Force exact floor/ceiling on last rung to prevent floating point errors
                    if (N > 0) {
                        buyPrices[N-1] = buyPriceEnd;
                        sellPrices[N-1] = sellPriceEnd;
                    }

                    // 3. Buy Ladder Calculation
                    let buyLadder = [];
                    let totalAssetBought = 0;
                    let totalNetCapitalSpent = 0;
                    let totalBuyFees = 0;

                    const reuseSnapshot = sellOnly && State.baselineBuySnapshot && State.baselineBuySnapshot.buyLadder.length > 0;

                    if (reuseSnapshot) {
                        buyLadder = State.baselineBuySnapshot.buyLadder.map(r => ({...r}));
                        totalAssetBought = State.baselineBuySnapshot.totalAssetBought;
                        totalNetCapitalSpent = State.baselineBuySnapshot.totalNetCapitalSpent;
                        totalBuyFees = State.baselineBuySnapshot.totalBuyFees;
                    } else {
                        if (equalQty) {
                            const activePrices = buyPrices.filter(p => p > 0);
                            const sumPrices = activePrices.reduce((a, b) => a + b, 0);
                            let sharedQty = 0;
                            
                            if (activePrices.length > 0 && C > 0) {
                                if (feeValue > 0 && isFeeNetted && feeType !== 'percent') {
                                    sharedQty = (C - (activePrices.length * feeValue)) / sumPrices;
                                } else if (feeValue > 0 && feeType === 'percent' && isFeeNetted) {
                                    sharedQty = C / (sumPrices * (1 + feeRate));
                                } else {
                                    sharedQty = C / sumPrices;
                                }
                            }
                            sharedQty = Math.max(sharedQty, 0);

                            buyLadder = buyPrices.map((price, i) => {
                                const assetSize = price > 0 ? sharedQty : 0;
                                const netCapital = assetSize * price;
                                let fee = 0;
                                if (assetSize > 0 && feeValue > 0) {
                                    fee = feeType === 'percent' ? netCapital * feeRate : feeValue;
                                }
                                totalAssetBought += assetSize;
                                totalNetCapitalSpent += netCapital;
                                totalBuyFees += fee;
                                return { rung: i+1, price, capital: netCapital + (isFeeNetted?fee:0), netCapital, assetSize, fee };
                            });

                        } else {
                            const rawWeights = Calculator.buildSkewWeights(N, S);
                            const totalWeight = rawWeights.reduce((a,b) => a+b, 0);
                            
                            buyLadder = rawWeights.map((w, i) => {
                                const alloc = (C * w) / totalWeight;
                                const price = buyPrices[i];
                                let net = alloc, fee = 0, gross = alloc;

                                if (feeValue > 0) {
                                    if (isFeeNetted) {
                                        if (feeType === 'percent') { net = alloc / (1+feeRate); fee = alloc - net; }
                                        else { fee = Math.min(feeValue, alloc); net = alloc - fee; }
                                        gross = alloc;
                                    } else {
                                        fee = feeType === 'percent' ? alloc * feeRate : (alloc > 0 ? feeValue : 0);
                                        gross = alloc + fee;
                                        net = alloc;
                                    }
                                }
                                const assetSize = (price > 0 && net > 0) ? net / price : 0;
                                totalAssetBought += assetSize;
                                totalNetCapitalSpent += net;
                                totalBuyFees += fee;
                                return { rung: i+1, price, capital: gross, netCapital: net, assetSize, fee };
                            });
                        }
                    }

                    let cumNet = 0, cumAsset = 0;
                    buyLadder.forEach(r => {
                        cumNet += r.netCapital; cumAsset += r.assetSize;
                        r.avg = cumAsset > 0 ? cumNet / cumAsset : 0;
                        r.cumQty = cumAsset; // Store for chart
                    });

                    // 4. Sell Logic
                    let effectiveAsset = totalAssetBought;
                    let effectiveSpent = totalNetCapitalSpent;
                    let effectiveFees = totalBuyFees;

                    if (sellOnly) {
                        const exQty = parseFloat(els.existQty.value || 0);
                        const exAvg = parseFloat(els.existAvg.value || 0);
                        
                        if (State.sellOnlyHighestExecuted !== null) {
                            const dt = Calculator.deriveExecutedBuyTotals(buyLadder, State.sellOnlyHighestExecuted);
                            if (dt.quantity > 0) {
                                effectiveAsset = dt.quantity;
                                effectiveSpent = dt.netCapital;
                                effectiveFees = dt.fees;
                            }
                        } else if (exQty > 0) {
                            effectiveAsset = exQty;
                            effectiveSpent = exQty * exAvg;
                            effectiveFees = 0;
                        }
                    }

                    const avgBuyPrice = effectiveAsset > 0 ? effectiveSpent / effectiveAsset : 0;
                    let assetAllocations = [];
                    if (sellOnly && effectiveAsset <= 0) {
                        assetAllocations = Array(N).fill(0);
                    } else if (equalQty) {
                         assetAllocations = Calculator.computeEqualGrossAllocations(effectiveAsset, sellPrices).allocations;
                    } else if (sellOnly) {
                         const w = Calculator.buildSkewWeights(N, S);
                         const tw = w.reduce((a,b) => a+b, 0);
                         assetAllocations = tw > 0 ? w.map(val => (effectiveAsset * val) / tw) : Array(N).fill(0);
                    } else {
                         assetAllocations = buyLadder.map(r => r.assetSize);
                    }

                    let totalSellRev = 0;
                    let totalSellFees = 0;
                    let cumSold = 0;
                    let cumProfit = 0;
                    
                    const sellLadder = assetAllocations.map((qty, i) => {
                        const price = sellPrices[i];
                        const grossRev = qty * price;
                        let netRev = grossRev, fee = 0;

                        if (feeValue > 0) {
                             const rawFee = feeType === 'percent' ? grossRev * feeRate : (grossRev > 0 ? feeValue : 0);
                             fee = isFeeNetted ? Math.min(rawFee, grossRev) : rawFee;
                             netRev = isFeeNetted ? Math.max(grossRev - fee, 0) : grossRev;
                        }

                        const costBasis = avgBuyPrice * qty;
                        const profit = netRev - costBasis;
                        
                        totalSellRev += netRev;
                        totalSellFees += fee;
                        
                        cumSold += qty;
                        cumProfit += profit;

                        return { rung: i+1, price, assetSize: qty, capital: grossRev, fee, netRevenue: netRev, profit, cumSold, cumProfit };
                    });

                    const totalFees = (sellOnly ? effectiveFees : totalBuyFees) + totalSellFees;
                    const finalCostBasis = sellOnly ? effectiveSpent : (totalNetCapitalSpent + totalBuyFees);
                    const netProfit = totalSellRev - finalCostBasis - (isFeeNetted ? 0 : totalSellFees);
                    const roi = finalCostBasis > 0 ? (netProfit / finalCostBasis) * 100 : 0;
                    const avgSell = effectiveAsset > 0 ? totalSellRev / effectiveAsset : 0;

                    const lowestBuy = buyLadder.length > 0 ? buyLadder[buyLadder.length - 1].price : 0;
                    const highestSell = sellLadder.length > 0 ? sellLadder[sellLadder.length - 1].price : 0;

                    State.currentPlanData = { buyLadder, sellLadder, summary: { netProfit, roi, avgBuy: avgBuyPrice, avgSell, totalFees, totalQuantity: effectiveAsset, lowestBuy, highestSell } };
                    if (!sellOnly && buyLadder.length > 0) {
                        State.baselineBuySnapshot = { buyLadder: [...buyLadder], totalAssetBought, totalNetCapitalSpent, totalBuyFees };
                    }
                    App.updateUI(State.currentPlanData);
                },

                updateUI: (plan) => {
                    const s = plan.summary;
                    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
                    const setCls = (id, cls) => { const el = document.getElementById(id); if(el) el.className = cls; };
                    
                    // Update summary displays
                    const summaryMap = {
                        'chart-summary-net-profit': Utils.fmtCurr(s.netProfit), 'chart-summary-roi': Utils.fmtPct(s.roi),
                        'chart-summary-avg-buy': Utils.fmtCurr(s.avgBuy), 'chart-summary-avg-sell': Utils.fmtCurr(s.avgSell),
                        'chart-summary-total-fees': Utils.fmtCurr(s.totalFees), 'chart-summary-total-quantity': Utils.fmtNum(s.totalQuantity),
                        'sticky-net-profit': Utils.fmtCurr(s.netProfit), 'sticky-roi': Utils.fmtPct(s.roi),
                        'sticky-avg-buy': Utils.fmtCurr(s.avgBuy), 'sticky-avg-sell': Utils.fmtCurr(s.avgSell),
                        'sticky-fees': Utils.fmtCurr(s.totalFees), 'sticky-vol': Utils.fmtNum(s.totalQuantity),
                        'sticky-floor': Utils.fmtCurr(s.lowestBuy), 'sticky-ceiling': Utils.fmtCurr(s.highestSell)
                    };
                    Object.entries(summaryMap).forEach(([id, val]) => setTxt(id, val));
                    setCls('chart-summary-net-profit', `text-lg font-bold ${s.netProfit >= 0 ? 'text-[var(--color-primary)]' : 'text-[var(--color-invalid)]'}`);
                    setCls('chart-summary-roi', `text-lg font-bold ${s.roi >= 0 ? 'text-green-600' : 'text-red-500'}`);
                    els.stickyFooter.classList.add('visible');

                    // Toggle Fee Cols
                    document.querySelectorAll('.fee-col').forEach(el => el.classList.toggle('hidden', !State.showFees));

                    const renderRow = (r, isSell) => `
                        <td class="px-4 py-3 font-mono text-xs text-[var(--color-text-muted)]">${isSell?'':`<input type="checkbox" class="mr-2" ${State.sellOnlyHighestExecuted===r.rung?'checked':''} onclick="App.toggleExecuted(${r.rung})">`}${r.rung}</td>
                        <td class="px-4 py-3 text-right font-mono copy-cursor hover:bg-[var(--color-border)] transition-colors" onclick="App.copy('${r.price}')">${Utils.fmtSigFig(r.price)}</td>
                        <td class="px-4 py-3 text-right font-mono text-[var(--color-text)] copy-cursor hover:bg-[var(--color-border)] transition-colors" onclick="App.copy('${r.assetSize}')">${Utils.fmtSigFig(r.assetSize)}</td>
                        <td class="px-4 py-3 text-right font-mono text-[var(--color-text-muted)]">${Utils.fmtSigFig(r.capital)}</td>
                        ${State.showFees ? `<td class="px-4 py-3 text-right font-mono text-[var(--color-text-muted)]">${Utils.fmtSigFig(r.fee)}</td>` : ''}
                        <td class="px-4 py-3 text-right font-mono font-medium ${isSell ? 'text-green-600' : 'text-[var(--color-text-secondary)]'}">
                            ${Utils.fmtSigFig(isSell ? r.profit : r.avg)}
                        </td>
                    `;

                    const updateTable = (id, data, isSell) => {
                        const tbody = document.getElementById(id);
                        const isMobile = window.innerWidth < 1024;
                        // Much smaller spacer row to remove the "blue block" effect, while still keeping structure
                        const spacerHeight = 'h-8';
                        const colSpan = State.showFees ? 6 : 5;
                        const spacerRow = `<tr><td colspan="${colSpan}" class="${spacerHeight}"></td></tr>`;
                        tbody.innerHTML = data.map((r, i) => 
                            `<tr class="${i%2===0?'table-row-even':'table-row-odd'} ${State.sellOnlyHighestExecuted>=r.rung && !isSell && els.sellOnlyCheck.checked ? 'executed-rung' : ''}">
                                ${renderRow(r, isSell)}
                             </tr>`
                        ).join('') + spacerRow;
                    };
                    updateTable('buy-ladder-body', plan.buyLadder, false);
                    updateTable('sell-ladder-body', plan.sellLadder, true);

                    App.drawDepthChart('#depth-chart', plan.buyLadder, plan.sellLadder);
                    
                    // Ensure table has enough bottom space after rendering
                    setTimeout(() => App.ensureTableBottomSpace(), 100);
                },

                toggleExecuted: (rung) => {
                    if(!els.sellOnlyCheck.checked) return;
                    window.App.toggleExecutedGlobal(rung);
                },

                copy: (val) => {
                    Utils.copyToClipboard(val);
                },

                // --- CHARTS ---
                /**
                 * Combined bar chart with cumulative line overlay:
                 *  - Horizontal bars for each individual order
                 *  - Cumulative line showing running total
                 *  - Both layers can be toggled on/off
                 *  - In sell-only mode, only shows sell orders
                 */
                drawDepthChart: (selector, buys, sells) => {
                    const svgSel = d3.select(selector);
                    const svgNode = svgSel.node();
                    if (!svgNode) return;

                    const container = svgNode.parentNode;
                    if (!container || (!buys?.length && !sells?.length)) return;

                    svgSel.selectAll("*").remove();

                    const width  = container.clientWidth;
                    const height = container.clientHeight;
                    const margin = { top: 20, right: 50, bottom: 30, left: 55 };

                    const svg = svgSel
                        .attr("width", width)
                        .attr("height", height);

                    // Get display modes
                    const showBars = State.chartShowBars;
                    const showCumulative = State.chartShowCumulative;
                    const isValue = State.chartUnitType === 'value';
                    const isSellOnly = State.sellOnlyMode;

                    // Prepare data and compute cumulative values
                    const computeCumulatives = (series, valKey) => {
                        let cumQty = 0, cumVal = 0;
                        series.forEach(d => {
                            const qty = d.assetSize ?? d.qty ?? d.size ?? d.volume ?? 0;
                            const val = d[valKey] ?? d.capital ?? (qty * d.price) ?? 0;
                            d.individualQty = qty; d.individualVal = val;
                            cumQty += qty; cumVal += val;
                            d.cumulativeQty = cumQty; d.cumulativeVal = cumVal;
                        });
                    };
                    const buySeries = isSellOnly ? [] : (buys || []).slice().sort((a, b) => b.price - a.price);
                    const sellSeries = (sells || []).slice().sort((a, b) => a.price - b.price);
                    computeCumulatives(buySeries, 'netCapital');
                    computeCumulatives(sellSeries, 'netRevenue');

                    // Value accessors
                    const getIndividualValue = (d) => isValue ? d.individualVal : d.individualQty;
                    const getCumulativeValue = (d) => isValue ? d.cumulativeVal : d.cumulativeQty;

                    const allData = [...buySeries, ...sellSeries];
                    if (!allData.length) return;

                    // Calculate price range
                    const prices = allData.map(d => d.price);
                    const yMin = d3.min(prices);
                    const yMax = d3.max(prices);
                    const mid = (yMin + yMax) / 2;

                    // Calculate bar heights based on number of orders and available space
                    const chartHeight = height - margin.top - margin.bottom;
                    const totalBars = buySeries.length + sellSeries.length;
                    const barPadding = 0.15;
                    const barHeight = Math.min(chartHeight / (totalBars + 1), 25);
                    const effectiveBarHeight = barHeight * (1 - barPadding);

                    // Build price scale
                    const priceExtent = yMax - yMin || 1;
                    const paddedMin = yMin - priceExtent * 0.05;
                    const paddedMax = yMax + priceExtent * 0.05;

                    const y = d3.scaleLinear()
                        .domain([paddedMin, paddedMax])
                        .range([height - margin.bottom, margin.top]);

                    // X scale - account for both individual and cumulative max
                    const maxIndividual = d3.max(allData, getIndividualValue) || 1;
                    const maxCumulative = d3.max(allData, getCumulativeValue) || 1;
                    const maxValue = Math.max(maxIndividual, showCumulative ? maxCumulative : 0);

                    const x = d3.scaleLinear()
                        .domain([0, maxValue * 1.1])
                        .range([margin.left, width - margin.right]);

                    // Mid price label
                    const midLabel = document.getElementById("mid-price-label");
                    if (midLabel) {
                        midLabel.textContent = isSellOnly ? `Sell Ladder` : `Mid ‚âà ${Utils.fmtCurr(mid)}`;
                    }

                    // Create layer groups
                    const barsGroup = svg.append("g").attr("class", "bars-layer");
                    const lineGroup = svg.append("g").attr("class", "cumulative-layer");

                    // Draw bars if enabled
                    if (showBars) {
                        const drawBars = (series, className, colorVar) => {
                            if (!series.length) return;
                            barsGroup.selectAll(`.${className}`)
                                .data(series).enter().append("rect")
                                .attr("class", className)
                                .attr("x", margin.left)
                                .attr("y", d => y(d.price) - effectiveBarHeight / 2)
                                .attr("width", 0).attr("height", effectiveBarHeight)
                                .attr("fill", getComputedStyle(document.body).getPropertyValue(colorVar).trim())
                                .attr("opacity", 0.7).attr("rx", 2)
                                .transition().duration(600)
                                .attr("width", d => Math.max(0, x(getIndividualValue(d)) - margin.left));
                        };
                        drawBars(buySeries, "buy-bar", "--color-chart-buy-start");
                        drawBars(sellSeries, "sell-bar", "--color-chart-sell-start");
                    }

                    // Draw cumulative lines if enabled
                    if (showCumulative) {
                        const lineGenerator = d3.line().x(d => x(getCumulativeValue(d))).y(d => y(d.price)).curve(d3.curveStepAfter);
                        const drawCumulativeLine = (series, dotClass, colorVar) => {
                            if (!series.length) return;
                            const color = getComputedStyle(document.body).getPropertyValue(colorVar).trim();
                            lineGroup.append("path").datum(series)
                                .attr("fill", "none").attr("stroke", color)
                                .attr("stroke-width", 2.5).attr("stroke-dasharray", "6 3")
                                .attr("opacity", 0.9).attr("d", lineGenerator);
                            lineGroup.selectAll(`.${dotClass}`).data(series).enter().append("circle")
                                .attr("class", dotClass)
                                .attr("cx", d => x(getCumulativeValue(d))).attr("cy", d => y(d.price))
                                .attr("r", 4).attr("fill", color).attr("stroke", "white").attr("stroke-width", 1.5);
                        };
                        drawCumulativeLine(buySeries, "buy-cum-dot", "--color-chart-buy-start");
                        drawCumulativeLine(sellSeries, "sell-cum-dot", "--color-chart-sell-start");
                    }

                    // Mid price line (only show in buy mode)
                    if (!isSellOnly) {
                    svg.append("line")
                        .attr("x1", margin.left)
                        .attr("x2", width - margin.right)
                        .attr("y1", y(mid))
                        .attr("y2", y(mid))
                        .attr("stroke", "currentColor")
                        .attr("stroke-width", 1)
                            .attr("stroke-dasharray", "4 2")
                        .attr("opacity", 0.3);
                    }

                    // Y-axis (Price)
                    const yAxis = d3.axisLeft(y)
                        .ticks(Math.min(totalBars, 10))
                        .tickFormat(d => "$" + d3.format(",.0f")(d));

                    svg.append("g")
                        .attr("transform", `translate(${margin.left},0)`)
                        .call(yAxis)
                        .attr("class", "text-[9px] opacity-60")
                        .call(g => g.selectAll("path").attr("stroke", "var(--color-border-strong)"))
                        .call(g => g.selectAll("line").attr("stroke", "var(--color-border)"));

                    // X-axis
                    const xAxis = d3.axisBottom(x)
                        .ticks(5)
                        .tickFormat(d => isValue ? "$" + d3.format(".2s")(d) : d3.format(".3s")(d));

                    svg.append("g")
                        .attr("transform", `translate(0,${height - margin.bottom})`)
                        .call(xAxis)
                        .attr("class", "text-[9px] opacity-60")
                        .call(g => g.selectAll("path").attr("stroke", "var(--color-border-strong)"))
                        .call(g => g.selectAll("line").remove());

                    // X-axis label
                    const unitLabel = isValue ? "Value ($)" : "Volume";
                    svg.append("text")
                        .attr("x", (width + margin.left - margin.right) / 2)
                        .attr("y", height - 5)
                        .attr("fill", "currentColor")
                        .attr("text-anchor", "middle")
                        .attr("font-size", "9px")
                        .attr("class", "opacity-50")
                        .text(unitLabel);

                    // Tooltip and hover zones
                    const tooltip = d3.select("#tooltip");
                    const allBarsData = [
                        ...buySeries.map(d => ({ ...d, isBuy: true })),
                        ...sellSeries.map(d => ({ ...d, isBuy: false }))
                    ];

                    svg.selectAll(".hover-zone")
                        .data(allBarsData)
                        .enter()
                        .append("rect")
                        .attr("class", "hover-zone")
                        .attr("x", margin.left)
                        .attr("y", d => y(d.price) - effectiveBarHeight / 2 - 2)
                        .attr("width", width - margin.left - margin.right)
                        .attr("height", effectiveBarHeight + 4)
                        .attr("fill", "transparent")
                        .style("cursor", "crosshair")
                        .on("mouseenter", function(event, d) {
                            // Highlight bar
                            if (showBars) {
                                const barClass = d.isBuy ? ".buy-bar" : ".sell-bar";
                                barsGroup.selectAll(barClass)
                                    .filter(bd => bd.price === d.price)
                                    .attr("opacity", 1)
                                    .attr("stroke", d.isBuy ? "#dc2626" : "#16a34a")
                                    .attr("stroke-width", 2);
                            }

                            // Highlight cumulative dot
                            if (showCumulative) {
                                const dotClass = d.isBuy ? ".buy-cum-dot" : ".sell-cum-dot";
                                lineGroup.selectAll(dotClass)
                                    .filter(bd => bd.price === d.price)
                                    .attr("r", 6);
                            }

                            // Show tooltip
                            const html = `
                                <div class="font-bold ${d.isBuy ? "text-red-400" : "text-green-400"}">
                                    ${d.isBuy ? "Buy" : "Sell"} Order #${d.rung}
                                </div>
                                <div>Price: ${Utils.fmtCurr(d.price)}</div>
                                <div class="border-t border-gray-600 mt-1 pt-1">
                                    <div class="text-gray-400 text-[10px] mb-1">Individual:</div>
                                    <div>Vol: ${Utils.fmtNum(d.individualQty, 4)}</div>
                                    <div>Val: ${Utils.fmtCurr(d.individualVal)}</div>
                                </div>
                                <div class="border-t border-gray-600 mt-1 pt-1">
                                    <div class="text-gray-400 text-[10px] mb-1">Cumulative:</div>
                                    <div>Vol: ${Utils.fmtNum(d.cumulativeQty, 4)}</div>
                                    <div>Val: ${Utils.fmtCurr(d.cumulativeVal)}</div>
                                </div>
                            `;

                            tooltip.classed("hidden", false).style("opacity", 1).html(html);

                            const box = tooltip.node().getBoundingClientRect();
                            let left = event.pageX + 15;
                            if (left + box.width > window.innerWidth) left = event.pageX - box.width - 15;
                            tooltip.style("left", left + "px").style("top", (event.pageY - 40) + "px");

                            // Cursor line
                            svg.selectAll(".cursor-line").remove();
                            svg.append("line")
                                .attr("class", "cursor-line")
                                .attr("x1", margin.left)
                                .attr("x2", width - margin.right)
                                .attr("y1", y(d.price))
                                .attr("y2", y(d.price))
                                .attr("stroke", d.isBuy ? "#dc2626" : "#16a34a")
                                .attr("stroke-width", 1)
                                .attr("stroke-dasharray", "4 4")
                                .attr("opacity", 0.8);
                        })
                        .on("mousemove", function(event) {
                            const box = tooltip.node().getBoundingClientRect();
                            let left = event.pageX + 15;
                            if (left + box.width > window.innerWidth) left = event.pageX - box.width - 15;
                            tooltip.style("left", left + "px").style("top", (event.pageY - 40) + "px");
                        })
                        .on("mouseleave", function(event, d) {
                            if (showBars) {
                                const barClass = d.isBuy ? ".buy-bar" : ".sell-bar";
                                barsGroup.selectAll(barClass)
                                    .filter(bd => bd.price === d.price)
                                    .attr("opacity", 0.7)
                                    .attr("stroke", "none");
                            }
                            if (showCumulative) {
                                const dotClass = d.isBuy ? ".buy-cum-dot" : ".sell-cum-dot";
                                lineGroup.selectAll(dotClass)
                                    .filter(bd => bd.price === d.price)
                                    .attr("r", 4);
                            }
                            tooltip.classed("hidden", true).style("opacity", 0);
                            svg.selectAll(".cursor-line").remove();
                        });
                },
                
                exportCSV: () => {
                    if (!State.currentPlanData) return;
                    const p = State.currentPlanData;
                    const rows = [
                        ['Type', 'Rung', 'Price', 'Size', 'Value', 'Profit/Avg'],
                        ...p.buyLadder.map(r => ['Buy', r.rung, r.price, r.assetSize, r.capital, r.avg]),
                        ...p.sellLadder.map(r => ['Sell', r.rung, r.price, r.assetSize, r.capital, r.profit])
                    ];
                    const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI(csvContent));
                    link.setAttribute("download", "orderskew_plan.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                
                saveConfig: () => {
                    const config = {
                        startingCapital: Utils.stripCommas(els.startCap.value),
                        numberOfRungs: els.rungs.value,
                        skewValue: els.skew.value,
                        depth: els.depth.value
                    };
                    const blob = new Blob([JSON.stringify(config)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'orderskew_config.json'; a.click();
                },

                loadConfig: (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const c = JSON.parse(ev.target.result);
                            if (c.startingCapital) {
                                els.startCap.value = Utils.formatNumberWithCommas(c.startingCapital);
                                els.rungs.value = c.numberOfRungs;
                                els.skew.value = c.skewValue;
                                els.depth.value = c.depth;
                                els.rungs.dispatchEvent(new Event('input'));
                                els.skew.dispatchEvent(new Event('input'));
                                els.depth.dispatchEvent(new Event('input'));
                                els.startCap.dispatchEvent(new Event('input'));
                            }
                        } catch(err) { alert('Invalid Config'); }
                    };
                    reader.readAsText(file);
                }
            };

            window.App = App;
            window.SetupWizard = SetupWizard;
            window.App.toggleExecutedGlobal = (rung) => {
                // Toggle: if clicking the same rung, deselect it (set to null)
                // Otherwise, select the clicked rung
                State.sellOnlyHighestExecuted = State.sellOnlyHighestExecuted === rung ? null : rung;
                App.calculatePlan();
            };

            App.init();
        });
    </script>
</body>
</html>