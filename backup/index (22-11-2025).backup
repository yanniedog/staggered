<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Skew | Trading Plan Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Michroma&display=swap" rel="stylesheet">
    <style>
        /* --- VARIABLES --- */
        :root {
            --color-bg: #cde7ec;
            --color-card: #edfcff;
            --color-card-alt: #dbf6fa;
            --color-card-muted: #f0f7f8;
            --color-text: #273f43;
            --color-text-secondary: #4a656b;
            --color-text-muted: #6c858b;
            --color-border: #c8e6eb;
            --color-border-strong: #bac6ea;
            --color-primary: #00424a;
            --color-primary-accent: #005f6b;
            --color-primary-contrast: #ffffff;
            --color-secondary: #008a7b;
            --color-secondary-hover: #006b5e;
            --color-tooltip-bg: #00424a;
            --color-tooltip-text: #ffffff;
            --color-table-row-even: #f8fafa;
            --color-table-row-odd: #ffffff;
            --color-summary-bg: #e0f7fa;
            --color-summary-border: #006064;
            --color-executed-bg: #dcfce7;
            --color-invalid: #ef4444;
            --color-slider-track: #cbd5e1;
            --color-slider-thumb: #00424a;
            --color-chart-buy-start: #0ea5e9;
            --color-chart-buy-end: #0284c7;
            --color-chart-sell-start: #14b8a6;
            --color-chart-sell-end: #0d9488;
            --focus-ring-color: rgba(0, 66, 74, 0.2);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body.theme-dark {
            --color-bg: #0f172a;
            --color-card: #1e293b;
            --color-card-alt: #334155;
            --color-card-muted: #253146;
            --color-text: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;
            --color-border: #334155;
            --color-border-strong: #475569;
            --color-primary: #38bdf8;
            --color-primary-accent: #0ea5e9;
            --color-primary-contrast: #0f172a;
            --color-secondary: #22d3ee;
            --color-secondary-hover: #06b6d4;
            --color-tooltip-bg: #e0f2fe;
            --color-tooltip-text: #0f172a;
            --color-table-row-even: #1e293b;
            --color-table-row-odd: #243146;
            --color-summary-bg: rgba(56, 189, 248, 0.1);
            --color-summary-border: #38bdf8;
            --color-executed-bg: rgba(34, 197, 94, 0.15);
            --color-invalid: #f87171;
            --color-slider-track: #334155;
            --color-slider-thumb: #38bdf8;
            --color-chart-buy-start: #38bdf8;
            --color-chart-buy-end: #0284c7;
            --color-chart-sell-start: #2dd4bf;
            --color-chart-sell-end: #0d9488;
            --focus-ring-color: rgba(56, 189, 248, 0.35);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.3), 0 2px 4px -2px rgb(0 0 0 / 0.3);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
        }

        /* --- BASE --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color .3s ease, color .3s ease;
            -webkit-font-smoothing: antialiased;
            /* Reduced padding to avoid excessive gap but still clear footer */
            padding-bottom: 80px; 
        }
        
        .font-solana {
            font-family: 'Michroma', sans-serif;
            letter-spacing: -0.02em;
        }
        
        @media (min-width: 1024px) {
            body { padding-bottom: 0; }
        }
        
        /* Extra spacing for table container elements on small screens */
        @media (max-width: 1023px) {
            #panel-buy,
            #panel-sell {
                padding-bottom: 0.5rem;
            }
            #buy-ladder-body,
            #sell-ladder-body {
                padding-bottom: 1rem;
            }
        }
        
        /* Desktop adjustments */
        @media (min-width: 1024px) {
            #panel-buy,
            #panel-sell {
                padding-bottom: 2rem;
            }
        }

        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

        /* --- FORM ELEMENTS --- */
        .form-input, select.form-input {
            background-color: var(--color-card-muted);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            transition: all .2s ease;
            font-size: 0.9rem;
        }

        .form-input:focus, select.form-input:focus {
            outline: 0;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--focus-ring-color);
            background-color: var(--color-card);
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 6px;
            background: var(--color-slider-track);
            border-radius: 3px; outline: 0; opacity: .85;
            transition: opacity .2s;
        }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 18px; height: 18px;
            background: var(--color-slider-thumb);
            cursor: pointer; border-radius: 50%;
            border: 2px solid var(--color-card);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        /* --- BUTTONS --- */
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-primary-contrast);
            transition: all .2s ease;
            box-shadow: var(--shadow-sm);
        }
        .btn-primary:hover { 
            background-color: var(--color-primary-accent); 
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .btn-secondary {
            background-color: var(--color-card-alt);
            color: var(--color-text);
            border: 1px solid var(--color-border);
            transition: all .2s ease;
        }
        .btn-secondary:hover { 
            background-color: var(--color-border);
            color: var(--color-primary);
        }

        .helper-tooltip {
            background-color: transparent;
            border: 1px solid var(--color-border-strong);
            color: var(--color-text-muted);
            border-radius: 50%;
            width: 16px; height: 16px;
            font-size: .7rem;
            display: flex; align-items: center; justify-content: center;
            cursor: help;
            transition: all .2s;
            flex-shrink: 0;
        }
        .helper-tooltip:hover { border-color: var(--color-primary); color: var(--color-primary); }

        .fee-type-btn {
            border: none;
            outline: none;
            cursor: pointer;
        }
        .fee-type-btn.active {
            background-color: var(--color-primary);
            color: var(--color-primary-contrast);
        }
        .fee-type-btn:not(.active) {
            background-color: transparent;
            color: var(--color-text-secondary);
        }
        .fee-type-btn:not(.active):hover {
            color: var(--color-text);
            background-color: var(--color-card);
        }

        /* --- CARDS --- */
        .card {
            background-color: var(--color-card);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            box-shadow: var(--shadow-sm);
            transition: all .3s ease;
        }
        .card:hover { box-shadow: var(--shadow-md); border-color: var(--color-border-strong); }

        /* --- TABLES --- */
        .table-header th { 
            background-color: var(--color-card-alt); 
            color: var(--color-text-secondary);
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        
        .table-row-odd td { background-color: var(--color-table-row-odd); }
        .table-row-even td { background-color: var(--color-table-row-even); }
        
        .executed-rung td {
            background-color: var(--color-executed-bg);
            color: var(--color-text);
            font-weight: 500;
            border-top: 1px solid rgba(0,0,0,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .copy-cursor { cursor: copy; }
        .copy-cursor:active { transform: scale(0.98); background-color: var(--color-card-alt); }

        /* --- CHARTS --- */
        .d3-chart text { fill: var(--color-text-muted); font-family: 'Inter', sans-serif; font-size: 10px; }
        .d3-chart .domain, .d3-chart .tick line { stroke: var(--color-border-strong); opacity: 0.5; }
        .tooltip {
            position: absolute;
            padding: 8px 12px;
            font-size: 12px;
            background: var(--color-tooltip-bg);
            color: var(--color-tooltip-text);
            border-radius: 6px;
            pointer-events: none;
            opacity: 0;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            transition: opacity 0.15s ease, transform 0.15s ease;
            white-space: nowrap;
        }

        /* --- STICKY MOBILE FOOTER --- */
        .mobile-sticky-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--color-card);
            border-top: 1px solid var(--color-border-strong);
            padding: 0.5rem 1rem;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .mobile-sticky-footer.visible { transform: translateY(0); }
        .mobile-sticky-footer > div {
            gap: 0.125rem;
        }
        .mobile-sticky-footer span {
            line-height: 1.2;
        }
        
        /* --- QR MODAL --- */
        .qr-modal {
            position: fixed; inset: 0; z-index: 1000;
            display: flex; align-items: center; justify-content: center;
            padding: 1rem;
            pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        .qr-modal.open { pointer-events: auto; opacity: 1; }
        .qr-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        .qr-content { 
            position: relative; background: var(--color-card); 
            padding: 2rem; border-radius: 1rem; 
            box-shadow: var(--shadow-lg); max-width: 340px; width: 100%;
            text-align: center; transform: translateY(10px); transition: transform 0.2s;
        }
        .qr-modal.open .qr-content { transform: translateY(0); }

        /* --- TOAST --- */
        .toast {
            position: fixed; 
            bottom: 2rem; 
            left: 50%; 
            transform: translateX(-50%) translateY(20px);
            background: var(--color-primary); 
            color: white;
            padding: 0.5rem 1rem; 
            font-size: 0.875rem;
            opacity: 0; 
            pointer-events: none; 
            transition: all 0.3s; 
            z-index: 2000;
            border-radius: 9999px; 
            box-shadow: var(--shadow-lg);
        }
        .toast.show { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0); 
        }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }

    </style>
</head>
<body class="p-3 sm:p-6 theme-light layout-desktop antialiased">

    <!-- Intro Overlay -->
    <div id="intro-layer" class="fixed inset-0 z-[9999] bg-black flex items-center justify-center transition-opacity duration-700">
        <!-- Video Background -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute inset-0 bg-black/60 z-10"></div>
            <video autoplay loop muted playsinline class="w-full h-full object-cover opacity-60">
                <!-- Using a reliable financial tech background video -->
                <source src="https://assets.mixkit.co/videos/preview/mixkit-digital-animation-of-financial-data-2789-large.mp4" type="video/mp4">
            </video>
        </div>
        <!-- Content -->
        <div class="relative z-20 text-center space-y-8 animate-fade-in px-4">
            <div class="space-y-2">
                <h1 class="text-5xl md:text-7xl font-bold font-solana text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 drop-shadow-lg">
                    ORDER SKEW
                </h1>
                <div class="h-1 w-32 mx-auto bg-gradient-to-r from-cyan-400 to-blue-600 rounded-full"></div>
            </div>
            
            <p class="text-gray-200 text-lg md:text-xl tracking-wide font-light max-w-lg mx-auto leading-relaxed">
                Advanced Trading Strategy<br>& Ladder Visualization
            </p>
            
            <button id="enter-app-btn" class="group relative px-10 py-4 bg-transparent overflow-hidden rounded-full border border-cyan-500 text-cyan-400 font-bold tracking-widest uppercase hover:text-black transition-colors duration-300 shadow-[0_0_20px_rgba(34,211,238,0.3)] hover:shadow-[0_0_30px_rgba(34,211,238,0.6)]">
                <span class="absolute inset-0 w-full h-full bg-cyan-400 transform -translate-x-full group-hover:translate-x-0 transition-transform duration-300 ease-out"></span>
                <span class="relative z-10">Initialize System</span>
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Value copied!</div>

    <!-- QR Modal -->
    <div id="qr-modal" class="qr-modal">
        <div class="qr-backdrop" id="qr-backdrop"></div>
        <div class="qr-content flex flex-col items-center gap-5">
            <div class="text-center space-y-2">
                <h3 class="text-lg font-bold text-[var(--color-text)] font-solana">Fuel the Development</h3>
                <p class="text-sm text-[var(--color-text-secondary)] leading-relaxed max-w-[280px]">
                    If Order Skew brings value to your trading, consider supporting its development. Every contribution helps keep the platform free and evolving.
                </p>
            </div>
            
            <div class="bg-white p-1.5 rounded-xl border border-[var(--color-border)] shadow-sm inline-block overflow-hidden">
                 <img src="https://raw.githubusercontent.com/yanniedog/OrderSkew/main/QRcode.jpg" 
                      alt="Donate SOL" 
                      class="w-40 h-40 object-contain" 
                      style="transform: scale(1.15);"
                      onerror="this.style.display='none'; this.parentElement.innerHTML='<span class=\'text-xs text-red-500\'>QR Not Found</span>'"> 
            </div>

            <div class="w-full space-y-3">
                <div class="flex items-center justify-center gap-2">
                    <img src="https://cryptologos.cc/logos/solana-sol-logo.svg" 
                         alt="Solana" 
                         class="h-5 w-auto object-contain"
                         onerror="this.style.display='none'">
                    <span class="text-xs font-bold text-[var(--color-text-secondary)] uppercase tracking-widest font-solana">Solana Network</span>
                </div>

                <div class="relative group cursor-pointer transition-all" onclick="App.copy('F6mjNXKBKzjmKTK1Z9cWabFHZYtxMg8rojuNuppX2EG1')" title="Click to copy">
                    <div class="absolute inset-0 bg-[var(--color-card-muted)] rounded-lg border border-[var(--color-border)] group-hover:border-[var(--color-primary)] transition-colors"></div>
                    <code class="relative z-10 block text-[10px] sm:text-[11px] text-[var(--color-text-muted)] font-mono break-all p-3 text-center group-hover:text-[var(--color-text)] transition-colors">
                        F6mjNXKBKzjmKTK1Z9cWabFHZYtxMg8rojuNuppX2EG1
                    </code>
                </div>
            </div>
            
            <button id="qr-close" class="btn-secondary w-full py-2.5 rounded-lg text-sm font-medium hover:bg-[var(--color-border)] transition-colors">Close</button>
        </div>
    </div>

    <!-- Sticky Mobile Summary -->
    <div id="mobile-sticky-summary" class="mobile-sticky-footer lg:hidden">
        <div class="flex flex-col">
            <span class="text-[10px] text-secondary font-medium uppercase tracking-wider">Net Profit</span>
            <span id="sticky-net-profit" class="text-base font-bold text-primary">-</span>
        </div>
        <div class="flex flex-col items-end">
             <span class="text-[10px] text-secondary font-medium uppercase tracking-wider">ROI</span>
             <span id="sticky-roi" class="text-base font-bold text-green-600">-</span>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="relative z-40 flex flex-col md:flex-row md:items-center justify-between gap-4 animate-fade-in">
            <div>
                <div class="flex items-center gap-2">
                    <h1 class="text-2xl md:text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-[var(--color-primary)] to-[var(--color-secondary)] font-solana">
                        ORDER SKEW
                    </h1>
                    <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-[var(--color-primary)] text-[var(--color-primary-contrast)] uppercase tracking-widest">Pro</span>
                </div>
                <p class="text-sm text-[var(--color-text-secondary)] mt-1">Trading ladder strategy calculator & visualizer</p>
            </div>

            <div class="flex items-center gap-3">
                <!-- Solana Donation -->
                <button id="sol-btn" class="p-2 rounded-full bg-[var(--color-card-alt)] text-[var(--color-text-muted)] hover:text-[#9945FF] hover:bg-[var(--color-border)] transition-colors" title="Donate SOL">
                    <svg viewBox="0 0 397.7 311.7" class="w-5 h-5" fill="currentColor"><path d="M64.6 237.9c2.4-2.4 5.7-3.8 9.2-3.8h317.4c5.8 0 8.7 7 4.6 11.1l-62.7 62.7c-2.4 2.4-5.7 3.8-9.2 3.8H6.5c-5.8 0-8.7-7-4.6-11.1l62.7-62.7z"/><path d="M64.6 3.8C67.1 1.4 70.4 0 73.8 0h317.4c5.8 0 8.7 7 4.6 11.1l-62.7 62.7c-2.4 2.4-5.7 3.8-9.2 3.8H6.5c-5.8 0-8.7-7-4.6-11.1L64.6 3.8z"/><path d="M333.1 120.1c-2.4-2.4-5.7-3.8-9.2-3.8H6.5c-5.8 0-8.7 7-4.6-11.1l62.7 62.7c2.4 2.4 5.7 3.8 9.2 3.8h317.4c5.8 0 8.7-7 4.6-11.1l-62.7-62.7z"/></svg>
                </button>

                <!-- GitHub -->
                <a href="https://github.com/yanniedog/OrderSkew" target="_blank" rel="noopener" class="p-2 rounded-full bg-[var(--color-card-alt)] text-[var(--color-text-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-border)] transition-colors" title="View on GitHub">
                    <svg viewBox="0 0 24 24" class="w-5 h-5" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                </a>

                <!-- Theme Toggle -->
                <button id="theme-toggle-btn" class="p-2 rounded-full bg-[var(--color-card-alt)] text-[var(--color-text)] hover:bg-[var(--color-border)] transition-colors" aria-label="Toggle Theme">
                    <svg id="icon-sun" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path></svg>
                    <svg id="icon-moon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                </button>
                
                <!-- Export/Actions Menu -->
                <div class="relative group z-50">
                    <button class="btn-secondary flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium shadow-sm">
                        <span>Export</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div class="absolute right-0 mt-2 w-48 bg-[var(--color-card)] border border-[var(--color-border)] rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 transform origin-top-right">
                        <div class="py-1">
                            <button type="button" id="download-csv-btn" class="block w-full text-left px-4 py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-card-alt)]">Download CSV</button>
                            <button type="button" id="save-config-btn" class="block w-full text-left px-4 py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-card-alt)]">Save Config</button>
                            <label class="block w-full text-left px-4 py-2 text-sm text-[var(--color-text)] hover:bg-[var(--color-card-alt)] cursor-pointer">
                                Load Config <input type="file" id="load-config-file" accept=".json" class="hidden">
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Column: Controls (lg:col-span-4) -->
            <div class="lg:col-span-5 space-y-6">
                
                <!-- Input Form Card -->
                <div class="card p-5 sm:p-6 animate-fade-in" style="animation-delay: 0.1s;">
                    <h2 class="text-lg font-semibold text-[var(--color-primary)] mb-5 flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        Strategy Configuration
                    </h2>
                    
                    <form id="trading-plan-form" class="space-y-6" onsubmit="return false;">
                        
                        <!-- Market Data Group -->
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label class="text-xs font-bold text-[var(--color-text-muted)] uppercase tracking-wider">Market Data</label>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <div class="flex items-center gap-1 mb-1.5">
                                        <label class="text-xs font-medium text-[var(--color-text-secondary)]" id="starting_capital_label">Initial Capital ($)</label>
                                        <button type="button" class="helper-tooltip" title="Total amount of capital available to deploy for this plan.">?</button>
                                    </div>
                                    <input type="text" id="starting_capital" value="50,000" class="form-input w-full rounded-lg p-2.5 font-mono">
                                </div>
                                <div>
                                    <div class="flex items-center gap-1 mb-1.5">
                                        <label class="block text-xs font-medium text-[var(--color-text-secondary)]">Asset Price ($)</label>
                                        <button type="button" class="helper-tooltip" title="Current market price of the asset used as a baseline.">?</button>
                                    </div>
                                    <input type="text" id="current_price" value="100" class="form-input w-full rounded-lg p-2.5 font-mono">
                                </div>
                            </div>
                        </div>

                        <hr class="border-[var(--color-border)]">

                        <!-- Ladder Settings Group -->
                        <div class="space-y-5">
                            <label class="text-xs font-bold text-[var(--color-text-muted)] uppercase tracking-wider">Ladder Settings</label>
                            
                            <!-- Rungs -->
                            <div>
                                <div class="flex justify-between mb-1.5">
                                    <div class="flex items-center gap-1">
                                        <label class="text-sm font-medium text-[var(--color-text-secondary)]">Number of Orders</label>
                                        <button type="button" class="helper-tooltip" title="How many separate buy/sell orders (rungs) to place in the ladder.">?</button>
                                    </div>
                                    <span id="number_of_rungs_display" class="text-sm font-mono font-bold text-[var(--color-primary)]">10</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <input type="range" id="number_of_rungs" min="2" max="50" value="10" class="flex-1">
                                    <input type="number" id="number_of_rungs_input" value="10" min="2" max="50" class="form-input w-16 rounded-md p-1 text-center text-xs">
                                </div>
                            </div>

                            <!-- Range/Depth -->
                            <div>
                                <div class="flex justify-between mb-1.5">
                                    <div class="flex items-center gap-1">
                                        <label class="text-sm font-medium text-[var(--color-text-secondary)]">Price Range / Depth</label>
                                        <button type="button" class="helper-tooltip" title="How far below/above the current price the ladder should extend. Use '%' for percentage width or 'Fixed' to set specific prices.">?</button>
                                    </div>
                                    <select id="price_range_mode" class="bg-transparent text-xs font-medium text-[var(--color-primary)] border-none p-0 focus:ring-0 cursor-pointer text-right">
                                        <option value="width">Percentage (%)</option>
                                        <option value="floor">Fixed Price Range</option>
                                    </select>
                                </div>
                                
                                <div id="width-mode-container">
                                    <div class="flex items-center gap-3">
                                        <input type="range" id="depth" min="0.1" max="99" step="0.1" value="20" class="flex-1">
                                        <div class="relative">
                                            <input type="number" id="depth_input" value="20" step="0.1" class="form-input w-16 rounded-md p-1 text-center text-xs pr-4">
                                            <span class="absolute right-1 top-1 text-[10px] text-[var(--color-text-muted)]">%</span>
                                        </div>
                                    </div>
                                </div>

                                <div id="floor-mode-container" class="hidden grid grid-cols-2 gap-3 mt-2">
                                    <div>
                                        <div class="flex items-center gap-1 mb-1">
                                            <label class="text-[10px] text-[var(--color-text-muted)]">Buy Floor ($)</label>
                                            <button type="button" class="helper-tooltip" title="The price of the absolute lowest buy order.">?</button>
                                        </div>
                                        <input type="number" id="buy_floor" class="form-input w-full rounded p-2 text-xs" placeholder="Low">
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-1 mb-1">
                                            <label class="text-[10px] text-[var(--color-text-muted)]">Sell Ceiling ($)</label>
                                            <button type="button" class="helper-tooltip" title="The price of the absolute highest sell order.">?</button>
                                        </div>
                                        <input type="number" id="sell_ceiling" class="form-input w-full rounded p-2 text-xs" placeholder="High">
                                    </div>
                                </div>
                            </div>

                            <!-- Skew -->
                            <div>
                                <div class="flex justify-between mb-1.5">
                                    <div class="flex items-center gap-1">
                                        <label class="text-sm font-medium text-[var(--color-text-secondary)]">Allocation Skew</label>
                                        <button type="button" class="helper-tooltip" title="Adjusts capital distribution. 'Flat' means equal distribution. 'Curved' allocates more capital to lower buy prices (martingale style).">?</button>
                                    </div>
                                    <span class="text-xs text-[var(--color-text-muted)]" id="skew_label">Moderate</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-[10px] font-bold text-[var(--color-text-muted)]">FLAT</span>
                                    <input type="range" id="skew_value" min="0" max="100" value="50" class="flex-1">
                                    <span class="text-[10px] font-bold text-[var(--color-text-muted)]">CURVED</span>
                                    <input type="number" id="skew_value_input" min="0" max="100" value="50" class="form-input w-14 rounded-md p-1 text-center text-xs hidden">
                                </div>
                            </div>

                            <!-- Fees -->
                            <div>
                                <div class="flex items-center gap-1 mb-1.5">
                                    <label class="text-sm font-medium text-[var(--color-text-secondary)]">Fee</label>
                                    <button type="button" class="helper-tooltip" title="Trading fee as a percentage or fixed dollar amount per trade.">?</button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="flex rounded-lg border border-[var(--color-border)] overflow-hidden bg-[var(--color-card-muted)]">
                                        <button type="button" id="fee_type_percent" class="fee-type-btn active px-3 py-2 text-xs font-medium transition-colors" data-value="percent">%</button>
                                        <button type="button" id="fee_type_fixed" class="fee-type-btn px-3 py-2 text-xs font-medium transition-colors" data-value="fixed">$</button>
                                    </div>
                                    <input type="number" id="fee_value" value="0.1" step="0.01" class="form-input flex-1 rounded-lg p-2.5 font-mono">
                                    <input type="hidden" id="fee_type" value="percent">
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Toggle -->
                        <div class="pt-2">
                            <label class="flex items-center gap-2 text-sm font-medium text-[var(--color-primary)] cursor-pointer hover:text-[var(--color-secondary)] transition-colors w-fit select-none">
                                <input type="checkbox" id="advanced_mode" class="w-4 h-4 rounded border-[var(--color-border-strong)] text-[var(--color-primary)] focus:ring-[var(--focus-ring-color)]">
                                <span>Advanced Options</span>
                                <svg id="adv-chevron" class="w-4 h-4 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </label>
                            
                            <div id="advanced-settings" class="hidden mt-4 p-4 bg-[var(--color-card-muted)] rounded-lg border border-[var(--color-border)] space-y-4">
                                
                                <!-- Sell Only Mode -->
                                <div class="flex items-center justify-between p-2 bg-[var(--color-card)] rounded border border-[var(--color-border)]">
                                    <div>
                                        <div class="flex items-center gap-1">
                                            <span class="block text-sm font-medium text-[var(--color-text)]">Sell-Only Mode</span>
                                            <button type="button" class="helper-tooltip" title="Enable this if you already hold the asset and want to plan a sell-ladder only.">?</button>
                                        </div>
                                        <span class="block text-xs text-[var(--color-text-muted)]">Simulate exit from existing position</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="sell_only_mode" class="sr-only peer">
                                        <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-[var(--color-primary)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-[var(--color-primary)]"></div>
                                    </label>
                                </div>
                                
                                <div id="sell-only-inputs" class="hidden grid grid-cols-2 gap-3">
                                    <div>
                                        <div class="flex items-center gap-1 mb-1">
                                            <label class="text-[10px] font-medium">Held Qty</label>
                                            <button type="button" class="helper-tooltip" title="The amount of the asset you currently possess.">?</button>
                                        </div>
                                        <input type="number" id="existing_quantity" value="0" class="form-input w-full rounded p-1.5 text-sm">
                                    </div>
                                    <div>
                                        <div class="flex items-center gap-1 mb-1">
                                            <label class="text-[10px] font-medium">Avg Cost</label>
                                            <button type="button" class="helper-tooltip" title="Your average buy price for the assets you hold.">?</button>
                                        </div>
                                        <input type="number" id="existing_avg_price" value="0" class="form-input w-full rounded p-1.5 text-sm">
                                    </div>
                                </div>

                                <div>
                                    <div class="flex items-center gap-1 mb-1">
                                        <label class="text-[10px] font-medium">Fee Settlement</label>
                                        <button type="button" class="helper-tooltip" title="'Net' means fees reduce the asset received. 'External' means fees are paid from a separate cash balance.">?</button>
                                    </div>
                                    <select id="fee_settlement" class="form-input w-full rounded p-1.5 text-sm">
                                        <option value="netted">Net (Deduct from Order)</option>
                                        <option value="external">External (Separate Funds)</option>
                                    </select>
                                </div>

                                <!-- Spacing Mode -->
                                <div>
                                    <div class="flex items-center gap-1 mb-1">
                                        <label class="text-[10px] font-medium">Spacing Mode</label>
                                        <button type="button" class="helper-tooltip" title="'Absolute' means equal dollar distance between orders. 'Relative' means geometric progression (percentage distance).">?</button>
                                    </div>
                                    <select id="spacing_mode" class="form-input w-full rounded p-1.5 text-sm">
                                        <option value="absolute">Absolute (Equal Steps)</option>
                                        <option value="relative">Relative (Geometric %)</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2 pt-2">
                                    <input type="checkbox" id="equal_quantity_mode" class="rounded border-gray-300 text-[var(--color-primary)] focus:ring-[var(--color-primary)]">
                                    <div class="flex items-center gap-1">
                                        <label for="equal_quantity_mode" class="text-xs text-[var(--color-text-secondary)]">Force Equal Quantity</label>
                                        <button type="button" class="helper-tooltip" title="Overrides skew settings to buy/sell the exact same amount of asset at every rung.">?</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>

                <!-- Summary Card (Desktop) -->
                <div class="hidden lg:block card p-6 animate-fade-in" style="animation-delay: 0.2s;">
                     <h3 class="text-sm font-bold text-[var(--color-text-muted)] uppercase tracking-wider mb-4">Projected Results</h3>
                     <div class="grid grid-cols-2 gap-y-6 gap-x-4">
                         <div>
                             <p class="text-xs text-[var(--color-text-secondary)]">Net Profit</p>
                             <p id="summary-net-profit" class="text-2xl font-bold text-[var(--color-primary)]">-</p>
                         </div>
                         <div>
                             <p class="text-xs text-[var(--color-text-secondary)]">ROI</p>
                             <p id="summary-roi" class="text-2xl font-bold text-green-600">-</p>
                         </div>
                         
                         <!-- Averages -->
                         <div class="pt-4 border-t border-[var(--color-border)]">
                             <p class="text-xs text-[var(--color-text-secondary)]">Avg Buy</p>
                             <p id="summary-avg-buy" class="text-lg font-semibold text-[var(--color-text)]">-</p>
                         </div>
                         <div class="pt-4 border-t border-[var(--color-border)]">
                             <p class="text-xs text-[var(--color-text-secondary)]">Avg Sell</p>
                             <p id="summary-avg-sell" class="text-lg font-semibold text-[var(--color-text)]">-</p>
                         </div>

                         <!-- Limits -->
                         <div class="pt-2">
                            <p class="text-[10px] uppercase tracking-wider text-[var(--color-text-muted)]">Buy Floor</p>
                            <p id="summary-buy-floor" class="text-sm font-mono font-medium text-[var(--color-text-secondary)]">-</p>
                        </div>
                        <div class="pt-2">
                            <p class="text-[10px] uppercase tracking-wider text-[var(--color-text-muted)]">Sell Ceiling</p>
                            <p id="summary-sell-ceiling" class="text-sm font-mono font-medium text-[var(--color-text-secondary)]">-</p>
                        </div>

                         <div class="col-span-2 pt-4 border-t border-[var(--color-border)] text-xs text-[var(--color-text-muted)] flex justify-between">
                             <span>Total Fees: <span id="summary-total-fees">-</span></span>
                             <span>Total Vol: <span id="summary-total-quantity">-</span></span>
                         </div>
                     </div>
                </div>

            </div>

            <!-- Right Column: Visualization (lg:col-span-8) -->
            <div class="lg:col-span-7 space-y-6">
                
                <!-- Charts Container -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Buy Chart -->
                    <div id="buy-chart-card" class="card p-4 h-72 flex flex-col animate-fade-in relative z-0" style="animation-delay: 0.3s;">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-semibold text-[var(--color-text)]">Buy Ladder</h3>
                            <span class="text-[10px] px-2 py-0.5 rounded bg-[var(--color-card-alt)] text-[var(--color-text-secondary)]">Volume Distribution</span>
                        </div>
                        <div id="visualization" class="d3-chart flex-1 w-full h-full relative">
                            <svg id="allocation-chart" width="100%" height="100%"></svg>
                        </div>
                    </div>

                    <!-- Sell Chart -->
                    <div id="sell-chart-card" class="card p-4 h-72 flex flex-col animate-fade-in relative z-0" style="animation-delay: 0.4s;">
                         <div class="flex justify-between items-center mb-2">
                            <h3 class="text-sm font-semibold text-[var(--color-text)]">Sell Ladder</h3>
                            <span class="text-[10px] px-2 py-0.5 rounded bg-[var(--color-card-alt)] text-[var(--color-text-secondary)]">Profit Distribution</span>
                        </div>
                        <div id="sell-visualization" class="d3-chart flex-1 w-full h-full relative">
                            <svg id="sell-allocation-chart" width="100%" height="100%"></svg>
                        </div>
                    </div>
                </div>

                <!-- Data Tables -->
                <div class="card overflow-hidden animate-fade-in mb-48 lg:mb-8" style="animation-delay: 0.5s;">
                    <div class="border-b border-[var(--color-border)]">
                        <div class="flex">
                            <button id="tab-buy" class="flex-1 py-3 text-sm font-medium text-[var(--color-primary)] border-b-2 border-[var(--color-primary)] bg-[var(--color-card-alt)]">Buy Orders</button>
                            <button id="tab-sell" class="flex-1 py-3 text-sm font-medium text-[var(--color-text-muted)] hover:text-[var(--color-text)]">Sell Orders</button>
                        </div>
                    </div>
                    
                    <div class="relative w-full overflow-x-auto pb-32 lg:pb-8">
                        <div id="panel-buy" class="p-0">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="table-header text-xs uppercase">
                                    <tr>
                                        <th class="px-4 py-3">#</th>
                                        <th class="px-4 py-3 text-right">Price</th>
                                        <th class="px-4 py-3 text-right">Vol</th>
                                        <th class="px-4 py-3 text-right">Value ($)</th>
                                        <th class="px-4 py-3 text-right">Avg Price</th>
                                    </tr>
                                </thead>
                                <tbody id="buy-ladder-body" class="divide-y divide-[var(--color-border)]"></tbody>
                            </table>
                        </div>
                        <div id="panel-sell" class="hidden p-0">
                            <table class="w-full text-sm text-left whitespace-nowrap">
                                <thead class="table-header text-xs uppercase">
                                    <tr>
                                        <th class="px-4 py-3">#</th>
                                        <th class="px-4 py-3 text-right">Price</th>
                                        <th class="px-4 py-3 text-right">Vol</th>
                                        <th class="px-4 py-3 text-right">Value ($)</th>
                                        <th class="px-4 py-3 text-right text-green-600">Profit</th>
                                    </tr>
                                </thead>
                                <tbody id="sell-ladder-body" class="divide-y divide-[var(--color-border)]"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Tooltip Element -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- CONSTANTS & UTILS ---
            const CONSTANTS = {
                STORAGE_PREFIX: 'orderskew_v2_',
                MAX_SKEW_RATIO: 10
            };

            const Utils = {
                clamp: (v, min, max) => Math.min(Math.max(v, min), max),
                debounce: (func, wait) => {
                    let timeout;
                    return function(...args) {
                        clearTimeout(timeout);
                        timeout = setTimeout(() => func.apply(this, args), wait);
                    };
                },
                fmtCurr: (n) => new Intl.NumberFormat('en-US', {style:'currency', currency:'USD'}).format(Number.isFinite(n) ? n : 0),
                fmtNum: (n, d=4) => Number.isFinite(n) ? n.toLocaleString('en-US', {minimumFractionDigits:0, maximumFractionDigits:d}) : '0',
                fmtPct: (n) => Number.isFinite(n) ? n.toFixed(2) + '%' : '0.00%',
                formatNumberWithCommas: (value) => {
                    if (value === null || value === undefined) return '';
                    const strValue = value.toString();
                    if (strValue === '' || strValue === '-' || strValue === '.' || strValue === '-.') {
                        return strValue;
                    }
                    const isNegative = strValue.startsWith('-');
                    const endsWithDot = strValue.endsWith('.');
                    let workingValue = isNegative ? strValue.slice(1) : strValue;
                    const parts = workingValue.split('.');
                    const intPartRaw = parts.shift() || '';
                    const decimalPartRaw = parts.join('');
                    const formattedInt = intPartRaw.replace(/\B(?=(\d{3})+(?!\d))/g, ',') || '0';
                    if (parts.length === 0 && !strValue.includes('.')) {
                        return `${isNegative ? '-' : ''}${formattedInt}`;
                    }
                    if ((parts.length === 0 && strValue.includes('.')) || (parts.length >= 0 && decimalPartRaw.length === 0 && endsWithDot)) {
                        return `${isNegative ? '-' : ''}${formattedInt}.`;
                    }
                    return `${isNegative ? '-' : ''}${formattedInt}.${decimalPartRaw}`;
                },
                stripCommas: (value) => (value ?? '').toString().replace(/,/g, ''),
                copyToClipboard: (text) => {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                        const t = document.getElementById('toast');
                        t.classList.add('show');
                        setTimeout(() => t.classList.remove('show'), 2000);
                    } catch (err) { console.error('Fallback copy failed', err); }
                    document.body.removeChild(textArea);
                }
            };

            // --- STATE ---
            const State = {
                currentPlanData: null,
                baselineBuySnapshot: null,
                sellOnlyHighestExecuted: null,
                activeTab: 'buy',
                theme: 'light'
            };

            // --- DOM ELEMENTS ---
            const els = {
                form: document.getElementById('trading-plan-form'),
                // Inputs
                startCap: document.getElementById('starting_capital'),
                startCapLabel: document.getElementById('starting_capital_label'),
                currPrice: document.getElementById('current_price'),
                rungs: document.getElementById('number_of_rungs'),
                rungsInput: document.getElementById('number_of_rungs_input'),
                rungsDisplay: document.getElementById('number_of_rungs_display'),
                depth: document.getElementById('depth'),
                depthInput: document.getElementById('depth_input'),
                skew: document.getElementById('skew_value'),
                skewLabel: document.getElementById('skew_label'),
                priceRangeMode: document.getElementById('price_range_mode'),
                widthContainer: document.getElementById('width-mode-container'),
                floorContainer: document.getElementById('floor-mode-container'),
                buyFloor: document.getElementById('buy_floor'),
                sellCeiling: document.getElementById('sell_ceiling'),
                
                // Advanced
                advCheck: document.getElementById('advanced_mode'),
                advPanel: document.getElementById('advanced-settings'),
                advChevron: document.getElementById('adv-chevron'),
                sellOnlyCheck: document.getElementById('sell_only_mode'),
                sellOnlyInputs: document.getElementById('sell-only-inputs'),
                existQty: document.getElementById('existing_quantity'),
                existAvg: document.getElementById('existing_avg_price'),
                feeType: document.getElementById('fee_type'),
                feeValue: document.getElementById('fee_value'),
                feeSettlement: document.getElementById('fee_settlement'),
                spacingMode: document.getElementById('spacing_mode'),
                equalQtyCheck: document.getElementById('equal_quantity_mode'),

                // Containers
                buyChartCard: document.getElementById('buy-chart-card'),
                
                // Tabs
                tabBuy: document.getElementById('tab-buy'),
                tabSell: document.getElementById('tab-sell'),
                panelBuy: document.getElementById('panel-buy'),
                panelSell: document.getElementById('panel-sell'),
                
                // Theme
                themeBtn: document.getElementById('theme-toggle-btn'),
                iconSun: document.getElementById('icon-sun'),
                iconMoon: document.getElementById('icon-moon'),
                
                // Sticky
                stickyFooter: document.getElementById('mobile-sticky-summary'),
                
                // Modals
                solBtn: document.getElementById('sol-btn'),
                qrModal: document.getElementById('qr-modal'),
                qrBackdrop: document.getElementById('qr-backdrop'),
                qrClose: document.getElementById('qr-close')
            };

            // --- CALCULATOR ENGINE ---
            const Calculator = {
                buildSkewWeights: (count, skewValue) => {
                    if (count <= 0) return [];
                    if (skewValue <= 0) return Array(count).fill(1);
                    const normalizedSkew = Utils.clamp(skewValue, 0, 100) / 100;
                    const targetRatio = 1 + Math.pow(normalizedSkew, 1.2) * (CONSTANTS.MAX_SKEW_RATIO - 1);
                    const minWeight = 1 / targetRatio;
                    const curvature = 1 + normalizedSkew;
                    
                    return Array.from({ length: count }, (_, index) => {
                        if (count === 1) return 1;
                        const relativeIndex = index / (count - 1);
                        const shapedIndex = Math.pow(relativeIndex, curvature);
                        const curveValue = Math.pow(targetRatio, shapedIndex);
                        return Math.max(curveValue - 1 + minWeight, Number.EPSILON);
                    });
                },

                computeEqualGrossAllocations: (totalQuantity, prices) => {
                    const allocations = Array(prices.length).fill(0);
                    const validEntries = prices.map((price, idx) => ({ price, idx })).filter(entry => entry.price > 0);
                    if (totalQuantity <= 0 || validEntries.length === 0) return { allocations, quantityPerRung: 0 };
                    const sharedQuantity = totalQuantity / validEntries.length;
                    validEntries.forEach(({ idx }) => allocations[idx] = sharedQuantity);
                    return { allocations, quantityPerRung: sharedQuantity };
                },

                deriveExecutedBuyTotals: (buyLadder, highestRung) => {
                    if (!Array.isArray(buyLadder) || buyLadder.length === 0 || !Number.isFinite(highestRung)) {
                        return { quantity: 0, netCapital: 0, fees: 0 };
                    }
                    const executed = buyLadder.filter(rung => rung.rung <= highestRung && rung.assetSize > 0);
                    if (executed.length === 0) return { quantity: 0, netCapital: 0, fees: 0 };
                    
                    const quantity = executed.reduce((sum, rung) => sum + rung.assetSize, 0);
                    const netCapital = executed.reduce((sum, rung) => sum + rung.netCapital, 0);
                    const fees = executed.reduce((sum, rung) => sum + rung.fee, 0);
                    return { quantity, netCapital, fees };
                }
            };

            // --- APP LOGIC ---
            const App = {
                init: () => {
                    App.loadTheme();
                    App.bindEvents();
                    App.calculatePlan();
                    App.ensureTableBottomSpace();
                    window.addEventListener('resize', Utils.debounce(() => {
                        App.calculatePlan();
                        App.ensureTableBottomSpace();
                        // Re-render tables to update spacer rows on mobile
                        if (State.currentPlanData) {
                            App.updateUI(State.currentPlanData);
                        }
                    }, 200));
                },
                
                ensureTableBottomSpace: () => {
                    // Simple, robust logic: If mobile (narrower than lg breakpoint), enforce moderate bottom margin
                    const tableContainer = document.querySelector('.card.overflow-hidden');
                    if (!tableContainer) return;
                    
                    const isMobile = window.innerWidth < 1024;
                    // 24px margin + 80px body padding ensures safety without huge void
                    tableContainer.style.marginBottom = isMobile ? '24px' : '48px';
                },

                loadTheme: () => {
                    const saved = localStorage.getItem(CONSTANTS.STORAGE_PREFIX + 'theme');
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    State.theme = saved || (prefersDark ? 'dark' : 'light');
                    App.applyTheme();
                },

                toggleTheme: () => {
                    State.theme = State.theme === 'light' ? 'dark' : 'light';
                    localStorage.setItem(CONSTANTS.STORAGE_PREFIX + 'theme', State.theme);
                    App.applyTheme();
                },

                applyTheme: () => {
                    document.body.className = document.body.className.replace(/theme-\w+/, `theme-${State.theme}`);
                    if (State.theme === 'dark') {
                        els.iconSun.classList.remove('hidden');
                        els.iconMoon.classList.add('hidden');
                    } else {
                        els.iconSun.classList.add('hidden');
                        els.iconMoon.classList.remove('hidden');
                    }
                    App.calculatePlan(); // Redraw charts
                },

                bindEvents: () => {
                    // Handle Intro Page
                    const enterBtn = document.getElementById('enter-app-btn');
                    if (enterBtn) {
                        enterBtn.addEventListener('click', () => {
                            const introLayer = document.getElementById('intro-layer');
                            introLayer.style.opacity = '0';
                            introLayer.style.pointerEvents = 'none';
                            setTimeout(() => introLayer.remove(), 700); // Remove from DOM after transition
                        });
                    }

                    // Slider Syncs
                    const syncSlider = (slider, input, display) => {
                        slider.addEventListener('input', () => {
                            input.value = slider.value;
                            if(display) display.textContent = slider.value;
                            App.debouncedCalc();
                        });
                        input.addEventListener('input', () => {
                            slider.value = input.value;
                            if(display) display.textContent = input.value;
                            App.debouncedCalc();
                        });
                    };

                    syncSlider(els.rungs, els.rungsInput, els.rungsDisplay);
                    syncSlider(els.depth, els.depthInput);
                    
                    // Skew Sync
                    els.skew.addEventListener('input', () => {
                        const v = parseInt(els.skew.value);
                        if (v === 0) els.skewLabel.textContent = "Flat";
                        else if (v <= 30) els.skewLabel.textContent = "Gentle";
                        else if (v <= 70) els.skewLabel.textContent = "Moderate";
                        else els.skewLabel.textContent = "Aggressive";
                        App.debouncedCalc();
                    });

                    // Format Initial Capital with commas
                    if (els.startCap) {
                        const sanitizeInput = (value) => {
                            if (value === null || value === undefined) return '';
                            const strValue = value.toString();
                            if (strValue === '' || strValue === '-' || strValue === '.' || strValue === '-.') {
                                return strValue;
                            }
                            let sanitized = strValue.replace(/,/g, '');
                            let sign = '';
                            if (sanitized.startsWith('-')) {
                                sign = '-';
                                sanitized = sanitized.slice(1);
                            }
                            sanitized = sanitized.replace(/[^0-9.]/g, '');
                            const hadDecimal = sanitized.includes('.');
                            const parts = sanitized.split('.');
                            const integerPart = parts.shift() || '';
                            const decimalPart = parts.join('');
                            let normalized = sign + integerPart;
                            if (hadDecimal) {
                                normalized += '.' + decimalPart;
                                if (sanitized.endsWith('.') && decimalPart.length === 0) {
                                    normalized += '';
                                }
                            }
                            return normalized;
                        };

                        els.startCap.addEventListener('focus', (e) => {
                            e.target.value = Utils.stripCommas(e.target.value);
                        });

                        els.startCap.addEventListener('input', (e) => {
                            const cursorPos = e.target.selectionStart || 0;
                            const valueBefore = e.target.value;
                            const normalized = sanitizeInput(valueBefore);
                            e.target.value = normalized;
                            const diff = e.target.value.length - valueBefore.length;
                            const newPos = Math.max(0, cursorPos + diff);
                            e.target.setSelectionRange(newPos, newPos);
                            App.debouncedCalc();
                        });
                        
                        els.startCap.addEventListener('blur', (e) => {
                            const normalized = sanitizeInput(e.target.value);
                            e.target.value = Utils.formatNumberWithCommas(normalized);
                        });
                    }

                    // Format Asset Price with commas
                    if (els.currPrice) {
                        const sanitizeInput = (value) => {
                            if (value === null || value === undefined) return '';
                            const strValue = value.toString();
                            if (strValue === '' || strValue === '-' || strValue === '.' || strValue === '-.') {
                                return strValue;
                            }
                            let sanitized = strValue.replace(/,/g, '');
                            let sign = '';
                            if (sanitized.startsWith('-')) {
                                sign = '-';
                                sanitized = sanitized.slice(1);
                            }
                            sanitized = sanitized.replace(/[^0-9.]/g, '');
                            const hadDecimal = sanitized.includes('.');
                            const parts = sanitized.split('.');
                            const integerPart = parts.shift() || '';
                            const decimalPart = parts.join('');
                            let normalized = sign + integerPart;
                            if (hadDecimal) {
                                normalized += '.' + decimalPart;
                                if (sanitized.endsWith('.') && decimalPart.length === 0) {
                                    normalized += '';
                                }
                            }
                            return normalized;
                        };

                        els.currPrice.addEventListener('focus', (e) => {
                            e.target.value = Utils.stripCommas(e.target.value);
                        });

                        els.currPrice.addEventListener('input', (e) => {
                            const cursorPos = e.target.selectionStart || 0;
                            const valueBefore = e.target.value;
                            const normalized = sanitizeInput(valueBefore);
                            e.target.value = normalized;
                            const diff = e.target.value.length - valueBefore.length;
                            const newPos = Math.max(0, cursorPos + diff);
                            e.target.setSelectionRange(newPos, newPos);
                            App.debouncedCalc();
                        });
                        
                        els.currPrice.addEventListener('blur', (e) => {
                            const normalized = sanitizeInput(e.target.value);
                            e.target.value = Utils.formatNumberWithCommas(normalized);
                        });
                    }

                    // Standard Inputs
                    const inputs = [els.buyFloor, els.sellCeiling, 
                                   els.existQty, els.existAvg, els.feeValue];
                    inputs.forEach(el => { if(el) el.addEventListener('input', App.debouncedCalc); });

                    // Fee Type Toggle Buttons
                    const feeTypePercent = document.getElementById('fee_type_percent');
                    const feeTypeFixed = document.getElementById('fee_type_fixed');
                    if (feeTypePercent && feeTypeFixed) {
                        const updateFeeType = (value) => {
                            els.feeType.value = value;
                            if (value === 'percent') {
                                feeTypePercent.classList.add('active');
                                feeTypeFixed.classList.remove('active');
                            } else {
                                feeTypeFixed.classList.add('active');
                                feeTypePercent.classList.remove('active');
                            }
                            App.calculatePlan();
                        };
                        feeTypePercent.addEventListener('click', () => updateFeeType('percent'));
                        feeTypeFixed.addEventListener('click', () => updateFeeType('fixed'));
                        // Initialize active state
                        updateFeeType('percent');
                    }

                    // Selects
                    [els.priceRangeMode, els.feeSettlement, els.spacingMode].forEach(el => {
                        if(el) el.addEventListener('change', (e) => {
                            if (e.target === els.priceRangeMode) App.togglePriceMode();
                            App.calculatePlan();
                        });
                    });

                    // Toggles
                    els.advCheck.addEventListener('change', () => {
                        els.advPanel.classList.toggle('hidden', !els.advCheck.checked);
                        els.advChevron.classList.toggle('rotate-180', els.advCheck.checked);
                        App.calculatePlan();
                    });

                    els.sellOnlyCheck.addEventListener('change', () => {
                        const isSellOnly = els.sellOnlyCheck.checked;
                        els.sellOnlyInputs.classList.toggle('hidden', !isSellOnly);
                        els.startCapLabel.textContent = isSellOnly ? 'Held Quantity' : 'Initial Capital ($)';
                        els.buyChartCard.style.display = isSellOnly ? 'none' : 'flex';
                        if(!isSellOnly) {
                            State.sellOnlyHighestExecuted = null;
                        }
                        if(isSellOnly) App.switchTab('sell');
                        App.calculatePlan();
                    });

                    els.equalQtyCheck.addEventListener('change', () => {
                        els.skew.disabled = els.equalQtyCheck.checked;
                        if(els.equalQtyCheck.checked) els.skew.classList.add('opacity-50');
                        else els.skew.classList.remove('opacity-50');
                        App.calculatePlan();
                    });

                    // Tabs & Buttons
                    els.tabBuy.addEventListener('click', () => App.switchTab('buy'));
                    els.tabSell.addEventListener('click', () => App.switchTab('sell'));
                    els.themeBtn.addEventListener('click', App.toggleTheme);
                    document.getElementById('download-csv-btn').addEventListener('click', App.exportCSV);
                    document.getElementById('save-config-btn').addEventListener('click', App.saveConfig);
                    document.getElementById('load-config-file').addEventListener('change', App.loadConfig);
                    
                    // Modal
                    const toggleModal = (show) => els.qrModal.classList.toggle('open', show);
                    els.solBtn.addEventListener('click', () => toggleModal(true));
                    els.qrBackdrop.addEventListener('click', () => toggleModal(false));
                    els.qrClose.addEventListener('click', () => toggleModal(false));
                },

                debouncedCalc: () => Utils.debounce(App.calculatePlan, 50)(),

                togglePriceMode: () => {
                    const mode = els.priceRangeMode.value;
                    els.widthContainer.classList.toggle('hidden', mode !== 'width');
                    els.floorContainer.classList.toggle('hidden', mode !== 'floor');
                },

                switchTab: (tab) => {
                    State.activeTab = tab;
                    const activeClass = "flex-1 py-3 text-sm font-medium text-[var(--color-primary)] border-b-2 border-[var(--color-primary)] bg-[var(--color-card-alt)]";
                    const inactiveClass = "flex-1 py-3 text-sm font-medium text-[var(--color-text-muted)] hover:text-[var(--color-text)]";
                    
                    els.tabBuy.className = tab === 'buy' ? activeClass : inactiveClass;
                    els.tabSell.className = tab === 'sell' ? activeClass : inactiveClass;
                    els.panelBuy.classList.toggle('hidden', tab !== 'buy');
                    els.panelSell.classList.toggle('hidden', tab !== 'sell');
                },

                // --- CORE CALCULATION ---
                calculatePlan: () => {
                    // 1. Inputs
                    const C = parseFloat(Utils.stripCommas(els.startCap.value)) || 0;
                    const N = parseInt(els.rungs.value) || 2;
                    const S = parseInt(els.skew.value) || 0;
                    const currentPrice = parseFloat(Utils.stripCommas(els.currPrice.value)) || 0;
                    const depth = parseFloat(els.depth.value) || 20;
                    
                    const advMode = els.advCheck.checked;
                    const feeType = els.feeType.value;
                    const feeValue = parseFloat(els.feeValue.value) || 0;
                    const feeSettlement = advMode ? els.feeSettlement.value : 'netted';
                    const spacingMode = advMode ? els.spacingMode.value : 'absolute';
                    const sellOnly = advMode && els.sellOnlyCheck.checked;
                    const equalQty = advMode && els.equalQtyCheck.checked;

                    const feeRate = feeType === 'percent' ? feeValue / 100 : 0;
                    const isFeeNetted = feeSettlement !== 'external';
                    const isRelativeSpacing = spacingMode === 'relative';

                    // 2. Price Range
                    let buyPriceEnd, sellPriceEnd;
                    if (els.priceRangeMode.value === 'floor') {
                        buyPriceEnd = parseFloat(els.buyFloor.value) || currentPrice * 0.8;
                        sellPriceEnd = parseFloat(els.sellCeiling.value) || currentPrice * 1.2;
                    } else {
                        buyPriceEnd = currentPrice * (1 - depth/100);
                        sellPriceEnd = currentPrice * (1 + depth/100);
                    }

                    // Correctly Calculate Steps to ensure Last Rung == Floor/Ceiling
                    // If N rungs, we want i=0 to i=N-1.
                    // If standard steps, we want the Nth rung to be EXACTLY buyPriceEnd.
                    // Standard logic: price = current - (i+1)*step.
                    // Last rung (i=N-1): price = current - N*step = buyPriceEnd.
                    // So N*step = current - buyPriceEnd => step = (current - buyPriceEnd) / N.
                    
                    const buyStep = (!isRelativeSpacing && N > 0) ? (currentPrice - buyPriceEnd) / N : 0;
                    const sellStep = (!isRelativeSpacing && N > 0) ? (sellPriceEnd - currentPrice) / N : 0;
                    const buyRatio = (isRelativeSpacing && N > 0) ? Math.pow(Math.max(buyPriceEnd/currentPrice, 0), 1/N) : 1;
                    const sellRatio = (isRelativeSpacing && N > 0) ? Math.pow(sellPriceEnd/currentPrice, 1/N) : 1;

                    let buyPrices = Array.from({length: N}, (_, i) => isRelativeSpacing ? currentPrice * Math.pow(buyRatio, i+1) : currentPrice - ((i+1)*buyStep));
                    let sellPrices = Array.from({length: N}, (_, i) => isRelativeSpacing ? currentPrice * Math.pow(sellRatio, i+1) : currentPrice + ((i+1)*sellStep));
                    
                    // Force exact floor/ceiling on last rung to prevent floating point errors
                    if (N > 0) {
                        buyPrices[N-1] = buyPriceEnd;
                        sellPrices[N-1] = sellPriceEnd;
                    }

                    // 3. Buy Ladder Calculation
                    let buyLadder = [];
                    let totalAssetBought = 0;
                    let totalNetCapitalSpent = 0;
                    let totalBuyFees = 0;

                    const reuseSnapshot = sellOnly && State.baselineBuySnapshot && State.baselineBuySnapshot.buyLadder.length > 0;

                    if (reuseSnapshot) {
                        buyLadder = State.baselineBuySnapshot.buyLadder.map(r => ({...r}));
                        totalAssetBought = State.baselineBuySnapshot.totalAssetBought;
                        totalNetCapitalSpent = State.baselineBuySnapshot.totalNetCapitalSpent;
                        totalBuyFees = State.baselineBuySnapshot.totalBuyFees;
                    } else {
                        if (equalQty) {
                            const activePrices = buyPrices.filter(p => p > 0);
                            const sumPrices = activePrices.reduce((a, b) => a + b, 0);
                            let sharedQty = 0;
                            
                            if (activePrices.length > 0 && C > 0) {
                                if (feeValue > 0 && isFeeNetted && feeType !== 'percent') {
                                    sharedQty = (C - (activePrices.length * feeValue)) / sumPrices;
                                } else if (feeValue > 0 && feeType === 'percent' && isFeeNetted) {
                                    sharedQty = C / (sumPrices * (1 + feeRate));
                                } else {
                                    sharedQty = C / sumPrices;
                                }
                            }
                            sharedQty = Math.max(sharedQty, 0);

                            buyLadder = buyPrices.map((price, i) => {
                                const assetSize = price > 0 ? sharedQty : 0;
                                const netCapital = assetSize * price;
                                let fee = 0;
                                if (assetSize > 0 && feeValue > 0) {
                                    fee = feeType === 'percent' ? netCapital * feeRate : feeValue;
                                }
                                totalAssetBought += assetSize;
                                totalNetCapitalSpent += netCapital;
                                totalBuyFees += fee;
                                return { rung: i+1, price, capital: netCapital + (isFeeNetted?fee:0), netCapital, assetSize, fee };
                            });

                        } else {
                            const rawWeights = Calculator.buildSkewWeights(N, S);
                            const totalWeight = rawWeights.reduce((a,b) => a+b, 0);
                            
                            buyLadder = rawWeights.map((w, i) => {
                                const alloc = (C * w) / totalWeight;
                                const price = buyPrices[i];
                                let net = alloc, fee = 0, gross = alloc;

                                if (feeValue > 0) {
                                    if (isFeeNetted) {
                                        if (feeType === 'percent') { net = alloc / (1+feeRate); fee = alloc - net; }
                                        else { fee = Math.min(feeValue, alloc); net = alloc - fee; }
                                        gross = alloc;
                                    } else {
                                        fee = feeType === 'percent' ? alloc * feeRate : (alloc > 0 ? feeValue : 0);
                                        gross = alloc + fee;
                                        net = alloc;
                                    }
                                }
                                const assetSize = (price > 0 && net > 0) ? net / price : 0;
                                totalAssetBought += assetSize;
                                totalNetCapitalSpent += net;
                                totalBuyFees += fee;
                                return { rung: i+1, price, capital: gross, netCapital: net, assetSize, fee };
                            });
                        }
                    }

                    let cumNet = 0, cumAsset = 0;
                    buyLadder.forEach(r => {
                        cumNet += r.netCapital; cumAsset += r.assetSize;
                        r.avg = cumAsset > 0 ? cumNet / cumAsset : 0;
                    });

                    // 4. Sell Logic
                    let effectiveAsset = totalAssetBought;
                    let effectiveSpent = totalNetCapitalSpent;
                    let effectiveFees = totalBuyFees;

                    if (sellOnly) {
                        const exQty = parseFloat(els.existQty.value || 0);
                        const exAvg = parseFloat(els.existAvg.value || 0);
                        
                        if (State.sellOnlyHighestExecuted !== null) {
                            const dt = Calculator.deriveExecutedBuyTotals(buyLadder, State.sellOnlyHighestExecuted);
                            if (dt.quantity > 0) {
                                effectiveAsset = dt.quantity;
                                effectiveSpent = dt.netCapital;
                                effectiveFees = dt.fees;
                            }
                        } else if (exQty > 0) {
                            effectiveAsset = exQty;
                            effectiveSpent = exQty * exAvg;
                            effectiveFees = 0;
                        }
                    }

                    const avgBuyPrice = effectiveAsset > 0 ? effectiveSpent / effectiveAsset : 0;
                    let assetAllocations = [];
                    if (sellOnly && effectiveAsset <= 0) {
                        assetAllocations = Array(N).fill(0);
                    } else if (equalQty) {
                         assetAllocations = Calculator.computeEqualGrossAllocations(effectiveAsset, sellPrices).allocations;
                    } else if (sellOnly) {
                         const w = Calculator.buildSkewWeights(N, S);
                         const tw = w.reduce((a,b) => a+b, 0);
                         assetAllocations = tw > 0 ? w.map(val => (effectiveAsset * val) / tw) : Array(N).fill(0);
                    } else {
                         assetAllocations = buyLadder.map(r => r.assetSize);
                    }

                    let totalSellRev = 0;
                    let totalSellFees = 0;
                    
                    const sellLadder = assetAllocations.map((qty, i) => {
                        const price = sellPrices[i];
                        const grossRev = qty * price;
                        let netRev = grossRev, fee = 0;

                        if (feeValue > 0) {
                             const rawFee = feeType === 'percent' ? grossRev * feeRate : (grossRev > 0 ? feeValue : 0);
                             fee = isFeeNetted ? Math.min(rawFee, grossRev) : rawFee;
                             netRev = isFeeNetted ? Math.max(grossRev - fee, 0) : grossRev;
                        }

                        const costBasis = avgBuyPrice * qty;
                        const profit = netRev - costBasis;
                        
                        totalSellRev += netRev;
                        totalSellFees += fee;
                        return { rung: i+1, price, assetSize: qty, capital: grossRev, fee, netRevenue: netRev, profit };
                    });

                    const totalFees = (sellOnly ? effectiveFees : totalBuyFees) + totalSellFees;
                    const finalCostBasis = sellOnly ? effectiveSpent : (totalNetCapitalSpent + totalBuyFees);
                    const netProfit = totalSellRev - finalCostBasis - (isFeeNetted ? 0 : totalSellFees);
                    const roi = finalCostBasis > 0 ? (netProfit / finalCostBasis) * 100 : 0;
                    const avgSell = effectiveAsset > 0 ? totalSellRev / effectiveAsset : 0;

                    const lowestBuy = buyLadder.length > 0 ? buyLadder[buyLadder.length - 1].price : 0;
                    const highestSell = sellLadder.length > 0 ? sellLadder[sellLadder.length - 1].price : 0;

                    State.currentPlanData = { buyLadder, sellLadder, summary: { netProfit, roi, avgBuy: avgBuyPrice, avgSell, totalFees, totalQuantity: effectiveAsset, lowestBuy, highestSell } };
                    if (!sellOnly && buyLadder.length > 0) {
                        State.baselineBuySnapshot = { buyLadder: [...buyLadder], totalAssetBought, totalNetCapitalSpent, totalBuyFees };
                    }
                    App.updateUI(State.currentPlanData);
                },

                updateUI: (plan) => {
                    const s = plan.summary;
                    const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
                    const setCls = (id, cls) => { const el = document.getElementById(id); if(el) el.className = cls; };
                    
                    setTxt('summary-net-profit', Utils.fmtCurr(s.netProfit));
                    setCls('summary-net-profit', `text-2xl font-bold ${s.netProfit >= 0 ? 'text-[var(--color-primary)]' : 'text-[var(--color-invalid)]'}`);
                    setTxt('summary-roi', Utils.fmtPct(s.roi));
                    setCls('summary-roi', `text-2xl font-bold ${s.roi >= 0 ? 'text-green-600' : 'text-red-500'}`);
                    setTxt('summary-avg-buy', Utils.fmtCurr(s.avgBuy));
                    setTxt('summary-avg-sell', Utils.fmtCurr(s.avgSell));
                    setTxt('summary-total-fees', Utils.fmtCurr(s.totalFees));
                    setTxt('summary-total-quantity', Utils.fmtNum(s.totalQuantity));
                    setTxt('summary-buy-floor', Utils.fmtCurr(s.lowestBuy));
                    setTxt('summary-sell-ceiling', Utils.fmtCurr(s.highestSell));

                    setTxt('sticky-net-profit', Utils.fmtCurr(s.netProfit));
                    setTxt('sticky-roi', Utils.fmtPct(s.roi));
                    els.stickyFooter.classList.add('visible');

                    const renderRow = (r, isSell) => `
                        <td class="px-4 py-3 font-mono text-xs text-[var(--color-text-muted)]">${isSell?'':`<input type="checkbox" class="mr-2" ${State.sellOnlyHighestExecuted===r.rung?'checked':''} onclick="App.toggleExecuted(${r.rung})">`}${r.rung}</td>
                        <td class="px-4 py-3 text-right font-mono copy-cursor hover:bg-[var(--color-border)] transition-colors" onclick="App.copy('${r.price}')">${Utils.fmtCurr(r.price)}</td>
                        <td class="px-4 py-3 text-right font-mono text-[var(--color-text)] copy-cursor hover:bg-[var(--color-border)] transition-colors" onclick="App.copy('${r.assetSize}')">${Utils.fmtNum(r.assetSize)}</td>
                        <td class="px-4 py-3 text-right font-mono text-[var(--color-text-muted)]">${Utils.fmtNum(r.capital)}</td>
                        <td class="px-4 py-3 text-right font-mono font-medium ${isSell ? 'text-green-600' : 'text-[var(--color-text-secondary)]'}">
                            ${isSell ? Utils.fmtCurr(r.profit) : Utils.fmtCurr(r.avg)}
                        </td>
                    `;

                    const updateTable = (id, data, isSell) => {
                        const tbody = document.getElementById(id);
                        const isMobile = window.innerWidth < 1024;
                        // Much smaller spacer row to remove the "blue block" effect, while still keeping structure
                        const spacerHeight = 'h-8';
                        const spacerRow = `<tr><td colspan="5" class="${spacerHeight}"></td></tr>`;
                        tbody.innerHTML = data.map((r, i) => 
                            `<tr class="${i%2===0?'table-row-even':'table-row-odd'} ${State.sellOnlyHighestExecuted>=r.rung && !isSell && els.sellOnlyCheck.checked ? 'executed-rung' : ''}">
                                ${renderRow(r, isSell)}
                             </tr>`
                        ).join('') + spacerRow;
                    };
                    updateTable('buy-ladder-body', plan.buyLadder, false);
                    updateTable('sell-ladder-body', plan.sellLadder, true);

                    App.drawChart('#allocation-chart', plan.buyLadder, 'buy');
                    App.drawChart('#sell-allocation-chart', plan.sellLadder, 'sell');
                    
                    // Ensure table has enough bottom space after rendering
                    setTimeout(() => App.ensureTableBottomSpace(), 100);
                },

                toggleExecuted: (rung) => {
                    if(!els.sellOnlyCheck.checked) return;
                    window.App.toggleExecutedGlobal(rung);
                },

                copy: (val) => {
                    Utils.copyToClipboard(val);
                },

                // --- CHARTS ---
                drawChart: (selector, data, type) => {
                    const container = d3.select(selector).node()?.parentNode;
                    if (!container) return;
                    d3.select(selector).selectAll("*").remove();

                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    const margin = {top: 10, right: 10, bottom: 30, left: 35};

                    const svg = d3.select(selector).attr("width", width).attr("height", height);
                    
                    const defs = svg.append("defs");
                    const gradientId = `grad-${type}`;
                    const gradient = defs.append("linearGradient").attr("id", gradientId).attr("x1", "0%").attr("y1", "0%").attr("x2", "0%").attr("y2", "100%");
                    const colorStart = getComputedStyle(document.body).getPropertyValue(type === 'buy' ? '--color-chart-buy-start' : '--color-chart-sell-start').trim();
                    const colorEnd = getComputedStyle(document.body).getPropertyValue(type === 'buy' ? '--color-chart-buy-end' : '--color-chart-sell-end').trim();
                    gradient.append("stop").attr("offset", "0%").attr("stop-color", colorStart);
                    gradient.append("stop").attr("offset", "100%").attr("stop-color", colorEnd);

                    const x = d3.scaleBand().range([margin.left, width - margin.right]).padding(0.2).domain(data.map(d => d.rung));
                    const maxVal = d3.max(data, d => d.assetSize) || 1;
                    const y = d3.scaleLinear().range([height - margin.bottom, margin.top]).domain([0, maxVal]);

                    // Intelligent Axis Ticks to avoid "missing rung" perception
                    const domain = x.domain();
                    const tickValues = domain.length <= 20 ? domain : domain.filter((d,i) => i === 0 || i === domain.length - 1 || i % Math.ceil(domain.length/10) === 0);
                    
                    const xAxis = d3.axisBottom(x).tickValues(tickValues).tickSize(0).tickPadding(8);
                    svg.append("g").attr("transform", `translate(0,${height - margin.bottom})`).call(xAxis).attr("class", "text-[9px] opacity-60");
                    
                    const yAxis = d3.axisLeft(y).ticks(4).tickSize(0).tickPadding(8).tickFormat(d => d >= 1000 ? d/1000 + 'k' : d);
                    svg.append("g").attr("transform", `translate(${margin.left},0)`).call(yAxis).attr("class", "text-[9px] opacity-60");
                    
                    svg.selectAll(".domain").remove();

                    const tooltip = d3.select("#tooltip");

                    svg.selectAll(".bar").data(data).enter().append("rect")
                        .attr("class", "bar")
                        .attr("x", d => x(d.rung))
                        .attr("width", x.bandwidth())
                        .attr("y", height - margin.bottom)
                        .attr("height", 0)
                        .attr("fill", `url(#${gradientId})`)
                        .attr("rx", 2)
                        .on("mouseover", (e, d) => {
                            tooltip.style("opacity", 1).html(`<div class="font-bold">Rung ${d.rung}</div><div>Price: $${d.price.toFixed(2)}</div><div>Size: ${d.assetSize.toFixed(4)}</div>`);
                        })
                        .on("mousemove", (e) => {
                            const box = tooltip.node().getBoundingClientRect();
                            let left = e.pageX + 10;
                            if (left + box.width > window.innerWidth) left = e.pageX - box.width - 10;
                            tooltip.style("left", left + "px").style("top", (e.pageY - 40) + "px");
                        })
                        .on("mouseout", () => tooltip.style("opacity", 0))
                        .transition().duration(600).delay((d, i) => i * 30)
                        .attr("y", d => y(d.assetSize))
                        .attr("height", d => height - margin.bottom - y(d.assetSize));
                },
                
                exportCSV: () => {
                    if (!State.currentPlanData) return;
                    const p = State.currentPlanData;
                    const rows = [
                        ['Type', 'Rung', 'Price', 'Size', 'Value', 'Profit/Avg'],
                        ...p.buyLadder.map(r => ['Buy', r.rung, r.price, r.assetSize, r.capital, r.avg]),
                        ...p.sellLadder.map(r => ['Sell', r.rung, r.price, r.assetSize, r.capital, r.profit])
                    ];
                    const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI(csvContent));
                    link.setAttribute("download", "orderskew_plan.csv");
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                
                saveConfig: () => {
                    const config = {
                        startingCapital: Utils.stripCommas(els.startCap.value),
                        numberOfRungs: els.rungs.value,
                        skewValue: els.skew.value,
                        depth: els.depth.value
                    };
                    const blob = new Blob([JSON.stringify(config)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'orderskew_config.json'; a.click();
                },

                loadConfig: (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const c = JSON.parse(ev.target.result);
                            if (c.startingCapital) {
                                els.startCap.value = Utils.formatNumberWithCommas(c.startingCapital);
                                els.rungs.value = c.numberOfRungs;
                                els.skew.value = c.skewValue;
                                els.depth.value = c.depth;
                                els.rungs.dispatchEvent(new Event('input'));
                                els.skew.dispatchEvent(new Event('input'));
                                els.depth.dispatchEvent(new Event('input'));
                                els.startCap.dispatchEvent(new Event('input'));
                            }
                        } catch(err) { alert('Invalid Config'); }
                    };
                    reader.readAsText(file);
                }
            };

            window.App = App;
            window.App.toggleExecutedGlobal = (rung) => {
                State.sellOnlyHighestExecuted = State.sellOnlyHighestExecuted === rung ? rung - 1 : rung;
                App.calculatePlan();
            };

            App.init();
        });
    </script>
</body>
</html>